




<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <link rel="icon" type="image/x-icon" href="assets/favicon.png">
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MZJ-WORKSPACE</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    /* Tajawal for the whole file */
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
    html, body, button, input, select, textarea {
      font-family: 'Tajawal', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* Make Unique Spec Key inputs wider + more readable (all modals) */
    .modal input[list],
    .modal input[type="text"],
    .modal select {
      font-size: 15px;
    }
    /* Specifically: Unique Spec Key fields */
    #taskSpecKey, #dSpecKey {
      font-size: 16px;
      padding: 12px 12px;
      height: 46px;
    }
    /* Let the Unique Spec Key field take full row in the modal */
    #taskModal .grid2 .speckey-full { grid-column: 1 / -1; }
    /* VIN hint under the dropdown */
    .vin-hint {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }


    /* Finish modal color rows */
    .color-row{
      display:flex;gap:10px;align-items:center;
      background:#fff;
      border:1px solid #e6ded6;
      border-radius:12px;
      padding:10px;
      margin-top:10px;
    }
    .color-row .grow{flex:1;min-width:0;}
    .color-row label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}
    .color-row select{width:100%;height:42px;border-radius:12px}
    .color-row .btn{white-space:nowrap}
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --text:#1f2937;
      --muted:#6b7280;
      --card:#ffffff;
      --line:#e5e7eb;
      --radius:16px;
      --shadow: 0 12px 30px rgba(62,36,32,.12);
      --shadow2: 0 18px 50px rgba(62,36,32,.18);
      --danger:#b91c1c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--cream);
      color:var(--text);
      font-family:"Tajawal",system-ui,Arial;
    }
    a{color:inherit;text-decoration:none}
    button,input,select,textarea{font-family:inherit}

    /* ===== Layout ===== */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 300px 1fr;
      transition: grid-template-columns .18s ease;
    }
    .app.collapsed{ grid-template-columns: 88px 1fr; }

    /* ===== Sidebar ===== */
    .sidebar{
      background: linear-gradient(180deg, var(--brown), #2f1c19);
      color:#fff;
      padding:14px;
      position:sticky;
      top:0;
      height:100vh;
      overflow:auto;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .sb-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:6px 4px 14px;
      border-bottom:1px solid rgba(255,255,255,.12);
      margin-bottom:12px;
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand-badge{
      inline-size:34px;
      block-size:34px;
      border-radius:12px;
      background:linear-gradient(135deg,var(--beige),#d9b39a);
      flex:0 0 auto;
      box-shadow: 0 12px 24px rgba(188,143,116,.25);
    }
    .brand-title{display:flex;flex-direction:column;gap:2px;min-width:0}
    .brand-title strong{
      font-size:14px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .brand-title span{
      font-size:12px;opacity:.85;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .toggle-btn{
      border:0;
      background:rgba(255,255,255,.12);
      color:#fff;
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .toggle-btn:hover{background:rgba(255,255,255,.18)}
    .app.collapsed .brand-title{display:none}

    .sb-user{
      margin:10px 0 14px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      background:rgba(255,255,255,.06);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .avatar{
      width:36px;height:36px;border-radius:12px;
      background:rgba(255,255,255,.14);
      display:flex;align-items:center;justify-content:center;
      font-weight:800;
      flex:0 0 auto;
    }
    .sb-user .meta{min-width:0}
    .sb-user .meta .name{
      font-weight:800;font-size:13px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .sb-user .meta .role{
      font-size:12px;opacity:.85;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .app.collapsed .sb-user .meta{display:none}

    .sb-nav{display:grid;gap:8px;margin-top:10px}
    .sb-link{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      cursor:pointer;transition:.15s;user-select:none;
    }
    .sb-link:hover{background:rgba(255,255,255,.10)}
    .sb-link.active{
      background:rgba(255,255,255,.16);
      border-color:rgba(255,255,255,.16);
    }
    .sb-ico{
      width:34px;height:34px;border-radius:12px;
      background:rgba(255,255,255,.12);
      display:flex;align-items:center;justify-content:center;
      flex:0 0 auto;font-size:16px;
    }
    .sb-text{font-weight:800}
    .app.collapsed .sb-text{display:none}

    .sb-foot{
      margin-top:14px;padding-top:12px;
      border-top:1px solid rgba(255,255,255,.12);
      display:grid;gap:8px;
    }
    .hint{font-size:12px;line-height:1.6}

    /* ===== Main ===== */
    .main{padding:18px;min-width:0}
    .page-head{
      display:flex;align-items:flex-start;justify-content:space-between;
      gap:14px;margin-bottom:14px;
    }
    .title-wrap h1{margin:0;font-size:20px;color:var(--brown);letter-spacing:.2px}
    .title-wrap p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.6}

    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      padding:10px 12px;border-radius:14px;border:0;
      background:var(--brown);color:#fff;cursor:pointer;font-weight:800;
      box-shadow: 0 10px 24px rgba(62,36,32,.18);transition:.15s;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{background:#fff;color:var(--brown);border:1px solid var(--brown);box-shadow:none}
    .btn.danger{background:var(--danger);box-shadow: 0 10px 24px rgba(185,28,28,.18)}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--brown);box-shadow:none}
    .btn.sm{padding:8px 10px;border-radius:12px;font-size:13px}
    .btn.xs{padding:6px 9px;border-radius:999px;font-size:12px}

    .panel{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(62,36,32,.06);
      overflow:hidden;
    }
    .panel .head{
      padding:12px 14px;border-bottom:1px solid #f1f1f1;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      background: linear-gradient(180deg, #fff, #fff8ef);
    }
    .panel .body{padding:14px}
    .muted{color:var(--muted)}

    /* ===== Home cards ===== */
    .home-grid{display:grid;grid-template-columns:repeat(2, minmax(0, 1fr));gap:14px}
    @media(max-width:980px){.home-grid{grid-template-columns:1fr}}
    .hero-card{
      border-radius:18px;border:1px solid rgba(62,36,32,.10);
      background: linear-gradient(140deg, #fff, #fff8ef 60%, rgba(188,143,116,.10));
      box-shadow: var(--shadow);
      padding:16px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      position:relative;overflow:hidden;min-height:150px;cursor:pointer;
    }
    .hero-card::before{
      content:"";position:absolute;inset:auto -40px -40px auto;
      width:160px;height:160px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(188,143,116,.35), transparent 60%);
      transform: rotate(12deg);
    }
    .hero-left{position:relative;z-index:1;min-width:0}
    .hero-title{margin:0;font-size:18px;color:var(--brown);font-weight:900}
    .hero-desc{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.7;max-width:560px}
    .hero-actions{position:relative;z-index:1;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;background:#fff;
      border:1px solid rgba(62,36,32,.10);color:var(--brown);
      font-weight:800;font-size:12px;box-shadow: 0 8px 18px rgba(62,36,32,.10);
    }
    .pill .dot{width:8px;height:8px;border-radius:999px;background:var(--beige)}

    /* ===== Lists ===== */
    .list{display:grid;gap:10px}
    .list-item{
      border:1px solid rgba(62,36,32,.10);border-radius:16px;padding:12px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      background:#fff;transition:.15s;cursor:pointer;
    }
    .list-item:hover{transform:translateY(-1px);box-shadow: 0 14px 36px rgba(62,36,32,.12)}
    .li-main{min-width:0}
    .li-title{
      margin:0;font-size:14px;font-weight:900;color:var(--brown);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .li-sub{
      margin:6px 0 0;font-size:12px;color:var(--muted);line-height:1.6;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
    }
    .li-right{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;flex:0 0 auto}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;background:#fff8ef;
      border:1px solid rgba(188,143,116,.30);color:var(--brown);
      font-size:12px;font-weight:800;
    }
    .tag .mini{width:6px;height:6px;border-radius:999px;background:var(--beige)}

    /* ===== Board ===== */
    .board{display:grid;gap:14px;grid-template-columns:repeat(4, minmax(0, 1fr));margin-top:12px}
    @media(max-width:1400px){.board{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:980px){.board{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.board{grid-template-columns:1fr}}

    .col{
      background:#fff;border:1px solid rgba(62,36,32,.08);
      border-radius:16px;box-shadow: 0 10px 28px rgba(62,36,32,.08);
      overflow:hidden;display:flex;flex-direction:column;min-height:220px;
    }
    .col-head{
      background: linear-gradient(180deg, #fff8ef, #fff);
      border-bottom:1px solid rgba(62,36,32,.06);
      padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px;
    }


    /* ===== Done Column (green) ===== */
    .col.done-col{border-color: rgba(22,163,74,.35); box-shadow: 0 14px 34px rgba(22,163,74,.10)}
    .col.done-col .col-head{background: linear-gradient(180deg, #f0fdf4, #ffffff); border-bottom-color: rgba(22,163,74,.20)}
    .col.done-col .col-title{color:#166534}
    .col.done-col .count-badge{border-color: rgba(22,163,74,.28); color:#166534}
    .col-title{
      font-weight:900;color:var(--brown);font-size:13px;
      display:flex;align-items:center;gap:8px;min-width:0;
    }
    .col-title span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .count-badge{
      display:inline-flex;align-items:center;justify-content:center;
      min-width:24px;height:24px;padding:0 8px;border-radius:999px;
      background:#fff;border:1px solid rgba(62,36,32,.12);
      font-size:12px;font-weight:900;color:var(--brown);
    }
    .col-body{padding:10px;display:grid;gap:10px}

    .task-card{
      border:1px solid rgba(62,36,32,.10);border-radius:14px;padding:10px;
      background:#fff;box-shadow: 0 10px 22px rgba(62,36,32,.08);
      cursor:pointer;transition:.15s;
    }
    .task-card:hover{transform:translateY(-1px)}
    .t-title{margin:0;font-size:13px;font-weight:900;color:var(--brown);line-height:1.5}
    .t-meta{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:12px}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;background:#fff8ef;
      border:1px solid rgba(188,143,116,.25);color:var(--brown);
      font-weight:800;font-size:12px;
    }
    .badge .dot{width:8px;height:8px;border-radius:999px;background:var(--beige)}


    /* Done column (ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡) */
    .col.done-col{border-color: rgba(22,163,74,.35); box-shadow: 0 12px 34px rgba(22,163,74,.10);}
    .col.done-col .col-head{background: linear-gradient(180deg, rgba(220,252,231,.9), #fff); border-bottom-color: rgba(22,163,74,.18);}
    .col.done-col .col-title{color:#0f5a2a}
    .col.done-col .count-badge{border-color: rgba(22,163,74,.35); color:#0f5a2a}
    /* ===== Modal ===== */
    .modal{
      position:fixed;inset:0;background:rgba(0,0,0,.40);
      display:none;place-items:center;padding:16px;z-index:999;
    }
    .modal.show{display:grid}
    .sheet{
      width:min(900px, 100%);background:#fff;border-radius:18px;box-shadow: var(--shadow2);
      overflow:hidden;display:flex;flex-direction:column;max-height:92vh;
    }
    .sheet .m-head{
      padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid #f1f1f1;background: linear-gradient(180deg, #fff, #fff8ef);
    }
    .sheet .m-head strong{color:var(--brown);font-size:14px;font-weight:900}
    .sheet .m-body{padding:14px;overflow:auto;display:grid;gap:10px}
    .sheet .m-foot{
      padding:12px 14px;border-top:1px solid #f1f1f1;background: #fff8ef;
      display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;
    }

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:860px){.grid2{grid-template-columns:1fr}}
    label{display:block;margin:4px 0 6px;font-size:12px;font-weight:900;color:var(--brown)}
    input,select,textarea{
      width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      outline:none;background:#fff;font-size:14px;
    }
    textarea{min-height:110px;resize:vertical;line-height:1.8}
    input:focus,select:focus,textarea:focus{
      border-color: rgba(188,143,116,.65);
      box-shadow: 0 0 0 4px rgba(188,143,116,.18);
    }

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;border:1px solid rgba(62,36,32,.10);
      background:#fff;font-size:12px;color:var(--brown);font-weight:800;
    }
    .chip button{
      border:0;background:#fff8ef;color:var(--brown);
      border-radius:10px;cursor:pointer;padding:4px 8px;font-weight:900;
    }

    .divider{height:1px;background: #f1f1f1;margin:4px 0}
    .empty{
      padding:14px;border:1px dashed rgba(62,36,32,.18);
      border-radius:16px;background:#fff;color:var(--muted);
      line-height:1.8;font-size:13px;
    }

    .toast{
      position:fixed;left:16px;bottom:16px;background:#111827;color:#fff;
      padding:10px 12px;border-radius:14px;box-shadow: 0 14px 40px rgba(0,0,0,.25);
      display:none;z-index:2000;font-size:13px;
    }
    .toast.show{display:block}

    .kpi-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi{
      flex:1 1 220px;background:#fff;border-radius:16px;border:1px solid rgba(62,36,32,.08);
      box-shadow: 0 10px 28px rgba(62,36,32,.08);padding:12px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .kpi strong{display:block;color:var(--brown);font-weight:900;font-size:13px}
    .kpi span{color:var(--muted);font-size:12px}
    .kpi .num{font-weight:900;font-size:18px;color:var(--brown)}



    /* ===== Stock Table ===== */
    /* Tajawal for stock tab */
    #viewStock, #viewStock *{font-family:"Tajawal",system-ui,Arial !important;}

    .table-wrap{
      overflow:auto;
      border:1px solid #e6ded6;
      border-radius:14px;
      background:#fff;
      box-shadow: 0 10px 28px rgba(62,36,32,.08);
    }

    .stock-table{
      width:100%;
      border-collapse:collapse;
      min-width:1550px;
      background:#fff;
      table-layout:fixed;
      font-size:13px;
    }

    .stock-table thead th{
      position:sticky;
      top:0;
      z-index:2;
      background:#f9f4ef;
      color:var(--brown);
      font-weight:800;
      padding:12px 10px;
      border-bottom:1px solid #e6ded6;
      text-align:right;
      white-space:nowrap;
    }

    .stock-table tbody td{
      padding:11px 10px;
      border-bottom:1px solid #f0ebe6;
      color:var(--text);
      vertical-align:middle;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      background:#fff;
    }

    .stock-table tbody tr:nth-child(even) td{background:#fffaf5;}
    .stock-table tbody tr:hover td{background:#f3ece6;}

    .stock-table td.wrap{white-space:normal;line-height:1.7;}
    .stock-table td.center{text-align:center;font-weight:700;}
    .stock-table td.mono{direction:ltr;text-align:left;white-space:nowrap;font-family:inherit;}

    /* Stock table controls */
    .stock-ctrl{width:100%;padding:8px 10px;border:1px solid #e6ded6;border-radius:10px;background:#fff;font-size:13px;outline:none}
    .stock-ctrl:focus{border-color: var(--beige); box-shadow: 0 0 0 3px rgba(188,143,116,.18)}
    .stock-ctrl.small{padding:7px 10px;font-size:12px}
    .stock-ctrl[disabled]{background:#f7f3ef;color:#9aa3af}
    .stock-badge-mini{display:inline-block;padding:4px 10px;border-radius:999px;background:#f1e7dd;color:#3e2420;font-size:12px;white-space:nowrap}
    .stock-count{font-weight:800}

    .stock-meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    /* ===== Auth Gate (Inline Login) ===== */
    .auth-gate{
      position:fixed; inset:0; z-index:3000;
      background:linear-gradient(180deg, rgba(62,36,32,.92), rgba(47,28,25,.92));
      display:none; place-items:center; padding:16px;
    }
    .auth-gate.show{display:grid}
    .auth-card{
      width:min(520px, 100%);
      background:#fff;
      border-radius:20px;
      box-shadow: 0 22px 70px rgba(0,0,0,.35);
      border:1px solid rgba(62,36,32,.10);
      overflow:hidden;
    }
    .auth-head{
      padding:14px 16px;
      background:linear-gradient(180deg, #fff, #fff8ef);
      border-bottom:1px solid #f1f1f1;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .auth-head strong{color:var(--brown);font-weight:900}
    .auth-body{padding:16px; display:grid; gap:10px}
    .auth-foot{padding:12px 16px; background:#fff8ef; border-top:1px solid #f1f1f1; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap}
    .auth-note{color:var(--muted); font-size:12px; line-height:1.7}
    .auth-err{color:var(--danger); font-weight:900; font-size:13px; display:none}
    .auth-err.show{display:block}
    .auth-brand{
      display:flex; align-items:center; gap:10px;
    }
    .auth-badge{
      inline-size:38px; block-size:38px;
      border-radius:14px;
      background:linear-gradient(135deg,var(--beige),#d9b39a);
      box-shadow: 0 12px 24px rgba(188,143,116,.25);
    }
    .hide-app{display:none !important}
  </style>
</head>

<body>
  <!-- Inline Login Gate (Ø¨Ø¯ÙŠÙ„ login.html) -->
  <div class="auth-gate" id="authGate">
    <div class="auth-card">
      <div class="auth-head">
        <div class="auth-brand">
          <div class="auth-badge"></div>
          <div>
            <strong>MZJ Workspace</strong>
            <div class="auth-note">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div>
          </div>
        </div>
        <span class="pill" style="margin:0"><span class="dot"></span> Secure</span>
      </div>
      <div class="auth-body">
        <div class="auth-err" id="authErr">â€¦</div>
        <div>
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="loginEmail" type="email" autocomplete="username" placeholder="name@email.com" />
        </div>
        <div>
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <div class="auth-note">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†ÙØ³ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„/Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Firebase Auth Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ <b>mzj-workspace-c7d4e</b>.</div>
      </div>
      <div class="auth-foot">
        <button class="btn secondary" id="btnLoginDemo" type="button" style="display:none">Ø¯Ø®ÙˆÙ„ ØªØ¬Ø±ÙŠØ¨ÙŠ</button>
        <button class="btn" id="btnLogin" type="button">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      </div>
    </div>
  </div>

  <div class="app" id="app">
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand">
          <div class="brand-badge"></div>
          <div class="brand-title">
            <strong>MZJ Workspace</strong>
            <span>Tasks & Campaigns</span>
          </div>
        </div>
        <button class="toggle-btn" id="sbToggle" title="ÙØªØ­ / Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">â˜°</button>
      </div>

      <div class="sb-user">
        <div class="avatar" id="avatar">M</div>
        <div class="meta">
          <div class="name" id="whoName">...</div>
          <div class="role" id="whoRole">...</div>
        </div>
      </div>

      <div class="sb-nav">
        <div class="sb-link active" id="navHome">
          <div class="sb-ico">ğŸ </div>
          <div class="sb-text">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        </div>

        <div class="sb-link" id="navAgendas">
          <div class="sb-ico">ğŸ—‚ï¸</div>
          <div class="sb-text">Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª</div>
        </div>

        <div class="sb-link" id="navCampaigns">
          <div class="sb-ico">ğŸ“£</div>
          <div class="sb-text">Ø§Ù„Ø­Ù…Ù„Ø§Øª</div>
        </div>


        <div class="sb-link" id="navStock">
          <div class="sb-ico">ğŸš—</div>
          <div class="sb-text">stock</div>
        </div>

      </div>

      <div class="sb-foot">
        <a class="sb-link" href="javascript:void(0)" id="btnLogout">
          <div class="sb-ico">ğŸšª</div>
          <div class="sb-text">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
        </a>
        <div class="hint" style="color:rgba(255,255,255,.75);padding:6px 6px 0">
          Â© Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª â€” Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="page-head">
        <div class="title-wrap">
          <h1 id="pageTitle">Workspace â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª ÙˆØ§Ù„Ø­Ù…Ù„Ø§Øª</h1>
          <p id="pageDesc">Ø£Ù†Ø´Ø¦ Ø£Ø¬Ù†Ø¯Ø§Øª Ù„ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©/Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©ØŒ ÙˆØ£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø§Øª Ø¨ØªÙˆØ§Ø±ÙŠØ® ÙˆÙˆØµÙ ÙˆØ£Ø¹Ù…Ø¯Ø©â€¦ Ø«Ù… Ø£Ø¶Ù ØªØ§Ø³ÙƒØ§Øª Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ø¹Ù…ÙˆØ¯ Ø¨Ø³Ù‡ÙˆÙ„Ø©.</p>
        </div>

        <div class="actions" id="topActions">
          <button class="btn secondary sm" id="btnBack" style="display:none">â¬… Ø±Ø¬ÙˆØ¹</button>
          <button class="btn sm" id="btnCreateAgenda">â• Ø£Ø¬Ù†Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
          <button class="btn secondary sm" id="btnCreateCampaign">â• Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>
      </div>

      <section class="panel" id="viewHome">
        <div class="head">
          <strong>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</strong>
          <span class="muted" id="homeMeta">...</span>
        </div>
        <div class="body">
          <div class="home-grid">
            <div class="hero-card" id="goAgendas">
              <div class="hero-left">
                <h3 class="hero-title">Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª (Tasks)</h3>
                <p class="hero-desc">
                  Ø£Ù†Ø´Ø¦ Ø£Ø¬Ù†Ø¯Ø© Ø¨Ø§Ø³Ù… ÙˆØ­Ø¯Ø¯ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ÙƒØ±ÙˆØªØŒ Ø«Ù… Ø£Ø¶Ù ØªØ§Ø³ÙƒØ§Øª Ù„ÙƒÙ„ Ø¹Ù…ÙˆØ¯.
                  Ø§Ù„ØªØ§Ø³Ùƒ ÙŠØ­ØªÙˆÙŠ Unique Spec Key + ÙˆØµÙ + ØªØ§Ø±ÙŠØ® ØªØ³Ù„ÙŠÙ… + Ù…Ø³Ø¤ÙˆÙ„.
                </p>
                <div class="kpi-row">
                  <div class="kpi">
                    <div>
                      <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª</strong>
                      <span class="muted">Active</span>
                    </div>
                    <div class="num" id="kpiAgendas">0</div>
                  </div>
                  <div class="kpi">
                    <div>
                      <strong>ØªØ§Ø³ÙƒØ§Øª Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª</strong>
                      <span class="muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                    </div>
                    <div class="num" id="kpiAgendaTasks">0</div>
                  </div>
                </div>
              </div>
              <div class="hero-actions">
                <div class="pill"><span class="dot"></span> Board Ù…Ø±ØªØ¨</div>
                <button class="btn sm" type="button">ÙØªØ­ Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª</button>
              </div>
            </div>

            <div class="hero-card" id="goCampaigns">
              <div class="hero-left">
                <h3 class="hero-title">Ø§Ù„Ø­Ù…Ù„Ø§Øª (Campaigns)</h3>
                <p class="hero-desc">
                  Ø£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø© Ø¨Ø§Ø³Ù… ÙˆÙˆØµÙ + ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ©/Ù†Ù‡Ø§ÙŠØ© + Ø£Ø¹Ù…Ø¯Ø©ØŒ Ø«Ù… Ø£Ø¶Ù ØªØ§Ø³ÙƒØ§Øª Ù„ÙƒÙ„ Ø¹Ù…ÙˆØ¯.
                  Ø§Ù„ØªØ§Ø³Ùƒ ÙŠØ­ØªÙˆÙŠ Unique Spec Key + ÙˆØµÙ + ØªØ§Ø±ÙŠØ® ØªØ³Ù„ÙŠÙ… + Ø±ÙˆØ§Ø¨Ø· + Ù…Ø³Ø¤ÙˆÙ„.
                </p>
                <div class="kpi-row">
                  <div class="kpi">
                    <div>
                      <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù…Ù„Ø§Øª</strong>
                      <span class="muted">Active</span>
                    </div>
                    <div class="num" id="kpiCampaigns">0</div>
                  </div>
                  <div class="kpi">
                    <div>
                      <strong>ØªØ§Ø³ÙƒØ§Øª Ø§Ù„Ø­Ù…Ù„Ø§Øª</strong>
                      <span class="muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                    </div>
                    <div class="num" id="kpiCampaignTasks">0</div>
                  </div>
                </div>
              </div>
              <div class="hero-actions">
                <div class="pill"><span class="dot"></span> ØªÙˆØ§Ø±ÙŠØ® + Ø±ÙˆØ§Ø¨Ø·</div>
                <button class="btn sm" type="button">ÙØªØ­ Ø§Ù„Ø­Ù…Ù„Ø§Øª</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="panel" id="viewList" style="display:none">
        <div class="head">
          <strong id="listTitle">...</strong>
          <div class="actions">
            <button class="btn secondary sm" id="btnRefresh" type="button">âŸ³ ØªØ­Ø¯ÙŠØ«</button>
          </div>
        </div>
        <div class="body">
          <div class="empty" id="listEmpty" style="display:none">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.</div>
          <div class="list" id="listContainer"></div>
        </div>
      </section>

      <section class="panel" id="viewBoard" style="display:none">
        <div class="head">
          <div>
            <strong id="boardTitle">...</strong>
            <div class="muted" id="boardSub" style="font-size:12px;margin-top:6px"></div>
            <div id="boardFilterWrap" style="display:none;margin-top:10px">
              <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
              <select id="boardUserFilter" class="inp" style="min-width:260px">
                <option value="">Ø§Ù„ÙƒÙ„</option>
              </select>
            </div>
          </div>
          <div class="actions">
            <button class="btn ghost sm" id="btnEditBoard" type="button">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn danger sm" id="btnDeleteBoard" type="button">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
        <div class="body">
          <div class="board" id="boardCols"></div>
        </div>
      </section>

      <section class="panel" id="viewStock" style="display:none">
        <div class="head">
          <div class="stock-meta">
            <strong>stock</strong>
            <span class="muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b id="stockCount">0</b> Ø³ÙŠØ§Ø±Ø©</span>
            <input id="stockSearch" class="inp" style="min-width:260px" placeholder="Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ stock (Unique Spec Key)â€¦" />
            <button class="btn secondary sm" id="btnStockExport" type="button">â¬‡ï¸ ØªØµØ¯ÙŠØ± Excel</button>
          </div>
        </div>
        <div class="body">
          <div class="empty" id="stockEmpty" style="display:none">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
          <div class="table-wrap" id="stockTableWrap" style="display:none">
            <table class="stock-table" id="stockTable"></table>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Create/Edit Board Modal -->
  <div class="modal" id="boardModal">
    <div class="sheet">
      <div class="m-head">
        <strong id="boardModalTitle">...</strong>
        <button class="btn secondary xs" id="boardModalClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="m-body">
        <div class="grid2">
          <div>
            <label>Ø§Ù„Ù†ÙˆØ¹</label>
            <input id="boardType" readonly />
            <div class="hint" style="color:var(--muted)">Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¯Ø§Ø®Ù„ Collection: <b>workspaces</b>.</div>
          </div>
          <div>
            <label>Ø§Ø³Ù… (Ø§Ù„Ø£Ø¬Ù†Ø¯Ø© / Ø§Ù„Ø­Ù…Ù„Ø©)</label>
            <input id="boardName" placeholder="Ù…Ø«Ø§Ù„: ÙŠÙ†Ø§ÙŠØ± 2026 / Ø­Ù…Ù„Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø· - ÙØ¨Ø±Ø§ÙŠØ±"/>
          </div>
        </div>

        <div id="campaignFields" style="display:none">
          <label>ÙˆØµÙ Ø§Ù„Ø­Ù…Ù„Ø©</label>
          <textarea id="campaignDesc" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ø­Ù…Ù„Ø© Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­..."></textarea>
          <div class="grid2">
            <div>
              <label>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ù…Ù„Ø©</label>
              <input id="campaignStart" type="date"/>
            </div>
            <div>
              <label>ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ù…Ù„Ø©</label>
              <input id="campaignEnd" type="date"/>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div>
          <label>Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ø§Ù„ÙƒØ±ÙˆØª)</label>
          <div class="hint" style="color:var(--muted)">Ø£Ø¶Ù Ø£ÙƒØ«Ø± Ù…Ù† Ø¹Ù…ÙˆØ¯. Ù…Ø«Ø§Ù„: (Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª) (ØªØµÙ…ÙŠÙ… ØµÙˆØ±) (Ù…ÙˆØ´Ù†) ...</div>

          <div class="grid2" style="align-items:end">
            <div><input id="colInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø¹Ù…ÙˆØ¯ Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ©"/></div>
            <div style="display:flex;gap:10px;justify-content:flex-end">
              <button class="btn secondary sm" id="btnAddCol" type="button">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯</button>
              <button class="btn ghost sm" id="btnAddDefaults" type="button">Ø¥Ø¶Ø§ÙØ© Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
            </div>
          </div>

          <div class="chips" id="colsChips" style="margin-top:10px"></div>
        </div>
      </div>
      <div class="m-foot">
        <button class="btn secondary" id="boardCancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" id="boardSave" type="button">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- Task Modal -->
  <div class="modal" id="taskModal">
    <div class="sheet">
      <div class="m-head">
        <strong id="taskModalTitle">ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯</strong>
        <button class="btn secondary xs" id="taskModalClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="m-body">
        <div class="grid2">
          <div class="speckey-full">
            <label>Unique Spec Key</label>
            <input id="taskSpecKey" list="specKeyList" placeholder="Ø§Ø¨Ø­Ø« ÙˆØ§Ø®ØªØ± (Ø§Ù„Ø³ÙŠØ§Ø±Ø© | Ø§Ù„Ø¨ÙŠØ§Ù† | Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„)â€¦"/>
            <datalist id="specKeyList"></datalist>
            <div class="hint" style="color:var(--muted)">* ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† ØµÙØ­Ø©/Ù‚Ø§Ø¹Ø¯Ø© Unique Spec Key (Ø§Ù„Ù…Ø®Ø²ÙˆÙ†) â€” Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ ØµÙØ­Ø© ÙÙŠ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±.</div>
          </div>
          <!-- ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨ -->
          <div style="display:none">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</label>
            <input id="taskDue" type="date"/>
          </div>
        </div>

        <label>Ø§Ù„ÙˆØµÙ</label>
        <textarea id="taskDesc" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ ÙˆØ§Ø¶Ø­ Ù„Ù„ØªØ§Ø³Ùƒ..."></textarea>

        <div class="grid2">
          <div>
            <label>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (User)</label>
            <select id="taskAssignee">
              <option value="">â€” Ø§Ø®ØªØ± ÙŠÙˆØ²Ø± â€”</option>
            </select>
          </div>
          <div>
            <label>Ø§Ù„Ø¹Ù…ÙˆØ¯</label>
            <input id="taskColumn" readonly/>
          </div>
        </div>

        <div id="taskLinksWrap" style="display:none">
          <div class="divider"></div>
          <label>Ø±ÙˆØ§Ø¨Ø· Ù…Ø±ØªØ¨Ø·Ø© (Ù„Ù„Ø­Ù…Ù„Ø§Øª)</label>
          <div class="grid2" style="align-items:end">
            <div><input id="linkTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· â€” Ù…Ø«Ø§Ù„: Ù…Ù„Ù Ø¬ÙˆØ¬Ù„ Ø¯Ø±Ø§ÙŠÙ"/></div>
            <div><input id="linkUrl" placeholder="https://..."/></div>
          </div>
          <div style="display:flex;justify-content:flex-end;margin-top:10px">
            <button class="btn secondary sm" id="btnAddLink" type="button">Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø·</button>
          </div>
          <div class="chips" id="linksChips" style="margin-top:10px"></div>
        </div>

        <div class="divider"></div>
        <div class="hint" style="color:var(--muted)">Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ Ø¯Ø§Ø®Ù„ Collection: <b>workspace_tasks</b>.</div>
      </div>

      <div class="m-foot">
        <button class="btn danger" id="taskDelete" style="display:none" type="button">Ø­Ø°Ù</button>
        <button class="btn secondary" id="taskCancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" id="taskSave" type="button">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- Task Detail Modal -->
  <div class="modal" id="detailModal">
    <div class="sheet">
      <div class="m-head">
        <strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø³Ùƒ</strong>
        <button class="btn secondary xs" id="detailClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="m-body">
        <div class="grid2">
          <div><label>Unique Spec Key</label><input id="dSpecKey" readonly/></div>
          <!-- ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨ -->
          <div style="display:none"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</label><input id="dDue" readonly/></div>
        </div>
        <div class="grid2">
          <div><label>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label><input id="dAssignee" readonly/></div>
          <div><label>Ø§Ù„Ø¹Ù…ÙˆØ¯</label><input id="dColumn" readonly/></div>
        </div>
        <label>Ø§Ù„ÙˆØµÙ</label>
        <textarea id="dDesc" readonly></textarea>

        <div id="dLinksBlock" style="display:none">
          <div class="divider"></div>
          <label>Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</label>
          <div class="chips" id="dLinks"></div>
        </div>
      </div>
      <div class="m-foot">
        <button class="btn secondary" id="detailEdit" type="button">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn danger" id="detailDelete" type="button">Ø­Ø°Ù</button>
        <button class="btn" id="detailDone" type="button">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</button>
        <button class="btn" id="detailOk" type="button">ØªÙ…Ø§Ù…</button>
      </div>
    </div>
  </div>

  

  <!-- Stock Colors Modal (click count) -->
  <div class="modal" id="colorsModal">
    <div class="sheet" style="max-width:900px">
      <div class="m-head">
        <strong>Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø­Ø³Ø¨ Unique Spec Key)</strong>
        <button class="btn secondary xs" id="colorsClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="m-body">
        <label>Unique Spec Key</label>
        <input id="cmSpecKey" readonly/>
        <div class="grid2" style="margin-top:12px">
          <div>
            <label>Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©</label>
            <div class="chips" id="cmExt"></div>
          </div>
          <div>
            <label>Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©</label>
            <div class="chips" id="cmInt"></div>
          </div>
        </div>
        <div class="hint" style="color:var(--muted);margin-top:10px">* Ù‡Ø°Ù‡ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙŠØªÙ… Ù‚Ø±Ø§Ø¡ØªÙ‡Ø§ Ù…Ù† mzj-agenda (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·).</div>
      </div>
      <div class="m-foot">
        <button class="btn" id="colorsOk" type="button">ØªÙ…Ø§Ù…</button>
      </div>
    </div>
  </div>

  <!-- Finish Task Modal -->
  <div class="modal" id="finishModal">
    <div class="sheet" style="max-width:980px">
      <div class="m-head">
        <strong>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ§Ø³Ùƒ</strong>
        <button class="btn secondary xs" id="finishClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="m-body">
        <label>Unique Spec Key</label>
        <input id="fmSpecKey" readonly/>

        <div class="grid2" style="margin-top:12px">
          <div>
            <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ†ØªØ§Ø¬</label>
            <select id="fmMontageDetails">
              <option value="">-</option>
              <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
              <option value="Ù„Ø§">Ù„Ø§</option>
            </select>
            <div class="hint" style="color:var(--muted);margin-top:6px">Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Tab stock ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§: Ù…ÙˆÙ†ØªØ§Ø¬ = Ù†Ø¹Ù… + ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ†ØªØ§Ø¬ Ø­Ø³Ø¨ Ø§Ø®ØªÙŠØ§Ø±Ùƒ.</div>
          </div>
          <div>
            <label>Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„ØªØ§Ø³Ùƒ</label>
            <button class="btn secondary sm" id="fmAddColor" type="button">+ Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ† Ù…Ø³ØªØ®Ø¯Ù…</button>
          </div>
        </div>

        <div id="fmColorsWrap" style="margin-top:10px"></div>
        <div class="hint" style="color:var(--muted);margin-top:10px">* Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† ØªÙØ¨Ù†Ù‰ Ø­Ø³Ø¨ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù†ÙØ³ Unique Spec Key (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· Ù…Ù† mzj-agenda).</div>
      </div>
      <div class="m-foot">
        <button class="btn secondary" id="finishCancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" id="finishSave" type="button">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</button>
      </div>
    </div>
  </div>

<div class="toast" id="toast">...</div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut, signInAnonymously,
      signInWithEmailAndPassword, setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs,
      addDoc, setDoc, updateDoc, deleteDoc,
      query, where, orderBy, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDXXDsJKnKb_0HynSTnP22QYc0yrUdx-cw",
      authDomain: "mzj-workspace-c7d4e.firebaseapp.com",
      projectId: "mzj-workspace-c7d4e",
      storageBucket: "mzj-workspace-c7d4e.firebasestorage.app",
      messagingSenderId: "1080687990992",
      appId: "1:1080687990992:web:4a496249bbf330fc37a6d5"
    };

  // ===== Unique Spec Key Source (Agenda DB) =====
  // ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ÙÙ‚Ø· Ù„Ø¬Ù„Ø¨ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù€ Spec Key Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ§Ø³Ùƒ (Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©).
  const agendaFirebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };


    // Workspace App (Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
    if(!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    // Agenda/Stock App (Ù…Ø´Ø±ÙˆØ¹ Ù…Ø®ØªÙ„Ù) â€” Ù„ØªØ¹Ø¨ÙŠÙ”Ø© Unique Spec Key
    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§Ø²Ù… Anonymous Auth ÙŠÙƒÙˆÙ† Ù…ÙØ¹Ù‘Ù„ ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ mzj-agenda + Rules ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©.
    const agendaApp = initializeApp(agendaFirebaseConfig, "agenda");
    const agendaAuth = getAuth(agendaApp);
    const agendaDb = getFirestore(agendaApp);

    const $ = (id)=> document.getElementById(id);
    const appEl = $("app");
    const toastEl = $("toast");

    // ===== Auth Gate helpers (Ø¨Ø¯ÙˆÙ† ØµÙØ­Ø© login.html) =====
    const authGate = $("authGate");
    const authErr = $("authErr");
    const loginEmail = $("loginEmail");
    const loginPass = $("loginPass");
    const btnLogin = $("btnLogin");

    function showAuth(msg=null){
      authErr.classList.toggle("show", !!msg);
      authErr.textContent = msg || "";
      authGate.classList.add("show");
      appEl.classList.add("hide-app");
    }
    function hideAuth(){
      authGate.classList.remove("show");
      appEl.classList.remove("hide-app");
      authErr.classList.remove("show");
    }

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=> toastEl.classList.remove("show"), 2200);
    }
    function escapeHtml(s){
      return String(s??"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    
    
    // Admin emails (Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª + Ù…Ø²Ø§Ù…Ù†Ø© Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù€ Workspace)
    const ADMIN_EMAILS = [
      "hossamzayan10@gmail.com",
      "an9036663@gmail.com",
      "mr.ahmed_rashed@outlook.sa"
    ];
    function isAdminEmail(email){
      const e = String(email||"").toLowerCase().trim();
      return ADMIN_EMAILS.includes(e);
    }

    // Cache Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù€ Workspace (Ù†ÙØ³ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
    // ÙŠØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø­Ø¯Ø«Ø© Ù…Ù† stock Ù‡Ù†Ø§ Ù„ØªØ³ØªØ®Ø¯Ù… Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„Ù‰ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    const SPEC_CACHE_DOC = doc(db, "spec_keys_cache", "v1");
    let lastStockHash = "";
    async function upsertSpecCache(stockArr){
      try{
        const email = auth.currentUser?.email || "";
        if(!isAdminEmail(email)) return; // ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙƒØ§Ø´ Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
        const payload = Array.isArray(stockArr) ? stockArr : [];
        const h = await stockHash(payload);
        if(h && h === lastStockHash) return;
        lastStockHash = h;
        await setDoc(SPEC_CACHE_DOC, {
          stock: payload,
          updatedAt: serverTimestamp(),
          updatedBy: email
        }, { merge:true });
      }catch(e){
        console.warn("upsertSpecCache failed", e);
      }
    }
    function stockHash(arr){
      try{
        // hash Ø®ÙÙŠÙ Ù„ØªÙØ§Ø¯ÙŠ ÙƒØªØ§Ø¨Ø© Ù…ØªÙƒØ±Ø±Ø©
        const txt = JSON.stringify(arr);
        let hash = 0;
        for(let i=0;i<txt.length;i++){
          hash = ((hash<<5)-hash) + txt.charCodeAt(i);
          hash |= 0;
        }
        return Promise.resolve(String(hash));
      }catch(e){
        return Promise.resolve("");
      }
    }

// ===== Spec Key Options (Ø¨Ø¯ÙˆÙ† Ø£Ù„ÙˆØ§Ù†) =====
    const SPEC_DATALIST_ID = "specKeyList";
    // ÙƒÙ„ Ø§Ù„Ù€ Spec Keys Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø¨Ø¹Ø¯ ÙÙ„ØªØ± Ø§Ù„Ø£Ù…Ø§ÙƒÙ†) Ù‚Ø¨Ù„ ÙÙ„ØªØ± Ø§Ù„Ù…ÙˆÙ†ØªØ§Ø¬
    let SPEC_KEY_ALL = [];
    // Ø§Ù„Ù„ÙŠ Ù‡Ù†Ø¸Ù‡Ø±Ù‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø§ØªØ§ Ù„ÙŠØ³Øª
    let SPEC_KEY_OPTIONS = []
    let SPEC_KEY_SET = new Set();
    let agendaUnsub = null;

    let AGENDA_STOCK = [];

    function cleanSpec(v){
      return String(v ?? "").replace(/[--]/g,"").replace(/\s+/g," ").trim();
    }

    function buildSpecKeyNoColors(rec){
      const car = cleanSpec(rec.car);
      const variant = cleanSpec(rec.variant);
      const year = cleanSpec(rec.modelYear);
      const parts = [car, variant, year].map(x=> x || "-");
      return parts.join(" | ");
    }

    const SOLD_STATES_SPEC = ["Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„ÙˆÙƒØ§Ù„Ø©"];
    function isSoldRowForSpec(rec){
      const placeRaw = cleanSpec(rec.place || rec.location || rec["Ø§Ù„Ù…ÙƒØ§Ù†"] || "");
      if(!placeRaw) return false;
      return SOLD_STATES_SPEC.some(st => placeRaw.includes(st));
    }

    // ÙŠØ¬Ù‡Ø² ÙƒÙ„ Ø§Ù„Ù€ Spec Keys Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø¨Ø¯ÙˆÙ† Ø§Ù„ÙˆÙƒØ§Ù„Ø©/Ø§Ù„Ù…Ø¨Ø§Ø¹) Ø«Ù… ÙŠØ·Ø¨Ù‚ ÙÙ„ØªØ± "ØºÙŠØ± Ù…Ø¹Ù…ÙˆÙ„ Ù„Ù‡Ø§ Ù…ÙˆÙ†ØªØ§Ø¬"
    function setSpecKeyOptionsFromStock(stockArr){
      try{
        const set = new Set();
        for(const r of (Array.isArray(stockArr)?stockArr:[])){
          if(isSoldRowForSpec(r)) continue;
          const key = buildSpecKeyNoColors(r);
          if(key && key !== "- | - | -") set.add(key);
        }
        SPEC_KEY_ALL = Array.from(set).sort((a,b)=> a.localeCompare(b,"ar"));
        applySpecKeyNotMontagedFilter();
      }catch(e){
        console.warn("setSpecKeyOptionsFromStock error", e);
      }
    }

    // ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù„ÙŠ "Ù„Ø³Ø© Ù…Ø´ Ù…Ø¹Ù…ÙˆÙ„Ù‡Ø§ Ù…ÙˆÙ†ØªØ§Ø¬" Ø­Ø³Ø¨ stock_tasks ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ workspace
    function applySpecKeyNotMontagedFilter(){
      try{
        // Ù„Ùˆ Ù…Ø´ Ù„Ø§Ù‚ÙŠÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù‡Ø§Ù… Ù„Ø³Ù‡ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ Ù…Ø¤Ù‚ØªÙ‹Ø§
        const list = Array.isArray(SPEC_KEY_ALL) ? SPEC_KEY_ALL : [];
        if(!STOCK_TASKS_MAP || STOCK_TASKS_MAP.size === 0){
          SPEC_KEY_OPTIONS = list;
        }else{
          SPEC_KEY_OPTIONS = list.filter(k=>{
            const t = STOCK_TASKS_MAP.get(String(k)) || {};
            // ÙŠØ¹ØªØ¨Ø± "ØªÙ… Ø§Ù„Ù…ÙˆÙ†ØªØ§Ø¬" ÙÙ‚Ø· Ù„Ùˆ montage == Ù†Ø¹Ù…
            return String(t.montage || "").trim() !== "Ù†Ø¹Ù…";
          });
        }
        renderSpecKeyDatalist();
      }catch(e){
        console.warn("applySpecKeyNotMontagedFilter error", e);
        SPEC_KEY_OPTIONS = Array.isArray(SPEC_KEY_ALL) ? SPEC_KEY_ALL : [];
        renderSpecKeyDatalist();
      }
    }

    function renderSpecKeyDatalist(){
      const dl = document.getElementById(SPEC_DATALIST_ID);
      if(!dl) return;
      SPEC_KEY_SET = new Set((SPEC_KEY_OPTIONS||[]).map(k=>String(k).trim()));
      dl.innerHTML = SPEC_KEY_OPTIONS.map(k=> `<option value="${escapeAttr(k)}"></option>`).join("");
    }

    // init live source
    
    function initLocalSpecCache(){
      try{
        onSnapshot(SPEC_CACHE_DOC, (snap)=>{
          if(!snap.exists()) return;
          const d = snap.data() || {};
          if(Array.isArray(d.stock) && d.stock.length){
            setSpecKeyOptionsFromStock(d.stock);
          }
        });
      }catch(e){
        console.warn("initLocalSpecCache failed", e);
      }
    }

function initSpecKeySource(){
      try{
        // Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† ÙÙŠ Auth Ø¯Ø§Ø®Ù„ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Firebase Project Ù…Ø®ØªÙ„Ù)
        // Ù‡Ù†Ø³ØªØ®Ø¯Ù… Anonymous Auth Ø¹Ù„Ø´Ø§Ù† Ù†Ù‚Ø¯Ø± Ù†Ù‚Ø±Ø£ Ø§Ù„Ø¯Ø§ØªØ§ (Ù„Ùˆ Anonymous Ù…ÙØ¹Ù‘Ù„ ÙÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹).
        signInAnonymously(agendaAuth).then(()=>{
          const stateRef = doc(agendaDb, "mzj_admin_state", "v1");
          if(agendaUnsub) agendaUnsub();
          agendaUnsub = onSnapshot(stateRef, (snap)=>{
            if(!snap.exists()) return;
            const d = snap.data() || {};
            setSpecKeyOptionsFromStock(d.stock || []);
            AGENDA_STOCK = Array.isArray(d.stock) ? d.stock : [];
            if(MODE==="stock") renderStockTab();
            // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø­Ø¯Ø«Ø© Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù€ Workspace
            upsertSpecCache(d.stock || []);
          }, (err)=>{
            console.warn("SpecKey source snapshot error", err);
            toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Unique Spec Key (ØªØ­Ù‚Ù‚ Ù…Ù† Rules/Anonymous Auth ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)");
          });
        }).catch((err)=>{
          console.warn("agenda anonymous auth failed", err);
          toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Unique Spec Key (Anonymous Auth ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)");
        });
      }catch(e){
        console.warn("initSpecKeySource failed", e);
        toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Unique Spec Key");
      }
    }

    function escapeAttr(s){ return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;"); }
function initials(name){
      const n = (name||"M").trim();
      const parts = n.split(/\s+/).filter(Boolean);
      if(parts.length===1) return parts[0][0].toUpperCase();
      return (parts[0][0]+parts[1][0]).toUpperCase();
    }

    $("sbToggle").addEventListener("click", ()=>{
      appEl.classList.toggle("collapsed");
      localStorage.setItem("ws_sb_collapsed", appEl.classList.contains("collapsed") ? "1" : "0");
    });
    if(localStorage.getItem("ws_sb_collapsed")==="1") appEl.classList.add("collapsed");

    const views = { home: $("viewHome"), list: $("viewList"), board: $("viewBoard"), stock: $("viewStock") };

    // Last rendered rows for Excel export (stock tab)
    let __LAST_STOCK_ROWS = [];


    // stock tab search (ÙÙ„ØªØ± ÙÙˆØ±ÙŠ Ø¯Ø§Ø®Ù„ Ø¬Ø¯ÙˆÙ„ stock)
    const stockSearchEl = document.getElementById('stockSearch');
    if(stockSearchEl){
      stockSearchEl.addEventListener('input', ()=>{
        if(MODE==='stock') renderStockTab();
      });
    }

    // Export Excel (stock tab)
    const btnStockExport = document.getElementById('btnStockExport');
    if(btnStockExport){
      btnStockExport.addEventListener('click', ()=>{
        try{
          exportStockToExcel(__LAST_STOCK_ROWS);
        }catch(err){
          console.error(err);
          toast('âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Excel');
        }
      });
    }

    function exportStockToExcel(rows){
      if(!rows || !rows.length){
        toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
        return;
      }
      if(typeof XLSX==='undefined'){
        toast('âš ï¸ Ù…ÙƒØªØ¨Ø© Excel Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§');
        return;
      }
      const data = rows.map((r,i)=>({
        'Ù…': i+1,
        'Unique Spec Key': r.specKey||'',
        'Ø§Ù„Ø¹Ø¯Ø¯': r.count||0,
        'ØªØµÙˆÙŠØ±': r.photo||'',
        'Ù…ÙˆÙ†ØªØ§Ø¬': r.montage||'',
        'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ†ØªØ§Ø¬': r.montageDetails||'',
        'Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©': r.inAgenda||'',
        'Ø§Ù„Ø´Ù‡Ø±': r.agendaMonth||'',
        'Ø§Ù„Ø³Ù†Ø©': r.agendaYear||''
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'stock');
      const now = new Date();
      const pad = (n)=> String(n).padStart(2,'0');
      const fname = `stock_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.xlsx`;
      XLSX.writeFile(wb, fname);
    }

    function showView(key){
      Object.values(views).forEach(v=> v.style.display="none");
      views[key].style.display="";
    }

    let CURRENT_USER = null;
    let CURRENT_ROLE = "member";
    let USERS = [];

    let MODE = "home";
    let LIST_TYPE = null;
    let CURRENT_WORKSPACE = null;
    let CURRENT_TASK = null;

    // Board tasks filter (agenda only)
    let BOARD_USER_FILTER_UID = "";
    let BOARD_TASKS_ALL = [];

    let unsubWorkspaces = null;
    let unsubTasks = null;

    $("btnCreateAgenda").addEventListener("click", ()=> openBoardModal("agenda", "create"));
    $("btnCreateCampaign").addEventListener("click", ()=> openBoardModal("campaign", "create"));
    $("btnBack").addEventListener("click", ()=> {
      if(MODE==="board") openList(LIST_TYPE);
      else openHome();
    });

    function setNavActive(which){
      ["navHome","navAgendas","navCampaigns","navStock"].forEach(id=>{
        $(id).classList.toggle("active", id===which);
      });
    }
    $("navHome").addEventListener("click", ()=> openHome());
    $("navAgendas").addEventListener("click", ()=> openList("agenda"));
    $("navCampaigns").addEventListener("click", ()=> openList("campaign"));

    $("navStock").addEventListener("click", ()=> openStock());

    $("goAgendas").addEventListener("click", ()=> openList("agenda"));
    $("goCampaigns").addEventListener("click", ()=> openList("campaign"));

    $("btnLogout").addEventListener("click", async ()=>{
      await signOut(auth);
      showAuth("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬. Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
    });

    // ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ (Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ø±ÙŠÙØ±ÙŠØ´ Ù…Ø§ÙŠØ±Ø¬Ø¹Ùƒ Ù„Ø£ÙŠ ØµÙØ­Ø©)
    setPersistence(auth, browserLocalPersistence).catch((e)=>{
      console.warn("setPersistence failed", e);
    });

    async function doLogin(){
      const email = (loginEmail.value||"").trim();
      const pass = (loginPass.value||"").trim();
      if(!email || !pass) return showAuth("Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
      btnLogin.disabled = true;
      btnLogin.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...";
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        hideAuth();
      }catch(err){
        console.warn("login failed", err);
        const code = err?.code || "";
        let msg = "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
        if(code.includes("auth/invalid-credential")) msg = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
        if(code.includes("auth/user-not-found")) msg = "Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
        if(code.includes("auth/wrong-password")) msg = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
        if(code.includes("auth/too-many-requests")) msg = "Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©. Ø¬Ø±Ù‘Ø¨ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„.";
        showAuth(msg);
      }finally{
        btnLogin.disabled = false;
        btnLogin.textContent = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
      }
    }

    btnLogin.addEventListener("click", doLogin);
    loginPass.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
    loginEmail.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ showAuth(); return; }
      CURRENT_USER = user;
      hideAuth();

      let displayName = user.email || "Ù…Ø³ØªØ®Ø¯Ù…";
      try{
        const uSnap = await getDoc(doc(db, "users", user.uid));
        if(uSnap.exists()){
          const ud = uSnap.data() || {};
          displayName = ud.name || ud.username || user.email || "Ù…Ø³ØªØ®Ø¯Ù…";
          CURRENT_ROLE = ud.role || "member";
        }
      }catch{}

      $("whoName").textContent = displayName;
      $("whoRole").textContent = (CURRENT_ROLE==="admin" ? "Ù…Ø¯ÙŠØ±" : "Ø¹Ø¶Ùˆ");
      $("avatar").textContent = initials(displayName);

      await loadUsers();
      // Ù…Ù‡Ø§Ù… Tab stock (Ù„Ø§ ØªÙ…Ø³ mzj-agenda) â€” Ù†Ø­ØªØ§Ø¬Ù‡Ø§ Ù„ØªØµÙÙŠØ© Unique Spec Key "Ø¨Ø¯ÙˆÙ† Ù…ÙˆÙ†ØªØ§Ø¬"
      await loadStockTasksOnce();
      openHome();
      listenKPIs();

      // Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù€ Spec Key (1) ÙƒØ§Ø´ Ù…Ø­Ù„ÙŠ Ø¯Ø§Ø®Ù„ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù€ Workspace + (2) Ù…ØµØ¯Ø± Ø­ÙŠ Ù…Ù† Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù€ Agenda
      initLocalSpecCache();
      initSpecKeySource();
    });

    async function loadUsers(){
      USERS = [];
      try{
        const snap = await getDocs(collection(db,"users"));
        snap.forEach(d=>{
          const u = d.data()||{};
          USERS.push({
            uid: d.id,
            name: u.name || u.username || u.email || d.id.slice(0,6),
            role: u.role || "member",
            email: u.email || null
          });
        });
      }catch(err){ console.warn("users load failed", err); }

      const sel = $("taskAssignee");
      sel.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± ÙŠÙˆØ²Ø± â€”</option>`;
      USERS.slice().sort((a,b)=> (a.name||"").localeCompare(b.name||"", "ar")).forEach(u=>{
        const opt = document.createElement("option");
        opt.value = u.uid;
        opt.textContent = u.name + (u.role ? ` (${u.role})` : "");
        sel.appendChild(opt);
      });
    }

    let unsubKpiWs=null, unsubKpiTasks=null;
    function listenKPIs(){
      if(unsubKpiWs) unsubKpiWs();
      if(unsubKpiTasks) unsubKpiTasks();

      unsubKpiWs = onSnapshot(collection(db,"workspaces"), (snap)=>{
        let agendas=0, campaigns=0;
        snap.forEach(d=>{
          const x = d.data()||{};
          if(x.active===false) return;
          if(x.type==="agenda") agendas++;
          if(x.type==="campaign") campaigns++;
        });
        $("kpiAgendas").textContent = agendas;
        $("kpiCampaigns").textContent = campaigns;
      });

      unsubKpiTasks = onSnapshot(collection(db,"workspace_tasks"), (snap)=>{
        let a=0,c=0;
        snap.forEach(d=>{
          const t=d.data()||{};
          if(t.type==="agenda") a++;
          if(t.type==="campaign") c++;
        });
        $("kpiAgendaTasks").textContent = a;
        $("kpiCampaignTasks").textContent = c;
      });
    }



    function openStock(){
      MODE="stock"; LIST_TYPE=null; CURRENT_WORKSPACE=null;
      if(unsubWorkspaces){unsubWorkspaces();unsubWorkspaces=null;}
      if(unsubTasks){unsubTasks();unsubTasks=null;}

      setNavActive("navStock");
      $("pageTitle").textContent = "stock";
      $("pageDesc").textContent  = "";
      $("btnBack").style.display="none";
      $("btnCreateAgenda").style.display="none";
      $("btnCreateCampaign").style.display="none";

      showView("stock");
      renderStockTab();
    }

    // Ù†ÙØ³ Ù…Ù†Ø·Ù‚ ÙÙ„ØªØ± ØµÙØ­Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:
    // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù„ÙŠ Ù…ÙƒØ§Ù†Ù‡Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰:
    // (Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…) Ø£Ùˆ (Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…)
    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø£Ø­ÙŠØ§Ù†Ù‹Ø§ Ø¨ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Øµ ÙÙŠÙ‡ Ù…Ø³Ø§ÙØ§Øª ØºÙŠØ± Ù…Ø±Ø¦ÙŠØ©/ØªØ´ÙƒÙŠÙ„/ÙƒØ´ÙŠØ¯Ø©ØŒ ÙÙ†Ø¹Ù…Ù„ Normalization Ù‚ÙˆÙŠ.
    function normalizeArabicText(input){
      const s = String(input ?? "")
        .replace(/\u00A0/g, " ")               // NBSP
        .replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069]/g, "") // Ø§ØªØ¬Ø§Ù‡Ø§Øª
        .replace(/[\u064B-\u065F\u0670]/g, "") // ØªØ´ÙƒÙŠÙ„
        .replace(/\u0640/g, "")               // ÙƒØ´ÙŠØ¯Ø©
        .replace(/_/g, " ")
        .replace(/\s+/g, " ")
        .trim();
      return s;
    }

    function extractLocationValue(rec){
      if(!rec || typeof rec !== "object") return "";
      const raw = (rec.location ?? rec.place ?? rec["Ø§Ù„Ù…ÙƒØ§Ù†"] ?? rec["place"] ?? rec["Location"] ?? rec["LOC"] ?? rec["loc"]);
      if(raw == null) return "";
      if(typeof raw === "string" || typeof raw === "number") return String(raw);
      if(Array.isArray(raw)) return raw.map(x=> String(x ?? "")).join(" ");
      if(typeof raw === "object"){
        // Ø¨Ø¹Ø¶ Ø§Ù„Ø¯Ø§ØªØ§ Ø¨ØªÙƒÙˆÙ† Object Ø¨Ø¯Ù„ Ù†Øµ
        const cand = raw.name ?? raw.label ?? raw.value ?? raw.text ?? raw.title;
        if(cand != null) return String(cand);
        try{ return JSON.stringify(raw); }catch(e){ return ""; }
      }
      return String(raw);
    }

    function isExcludedByInventoryFilter(rec){
      // Ù†ÙØ³ Ù…Ù†Ø·Ù‚ ØµÙØ­Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø´Ø±Ø· "Ø¨Ø¯ÙˆÙ† Ø§Ù„ÙˆÙƒØ§Ù„Ø©" Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ:
      // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯:
      // 1) Ø£ÙŠ Ù…ÙƒØ§Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ "Ø§Ù„ÙˆÙƒØ§Ù„Ø© :"
      // 2) Ø£ÙŠ Ù…ÙƒØ§Ù† ÙŠØ­ØªÙˆÙŠ "Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…" Ø£Ùˆ "Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"
      const locRaw = extractLocationValue(rec);
      const loc = normalizeArabicText(locRaw);
      if(!loc) return false;
      const isAgency = loc.startsWith("Ø§Ù„ÙˆÙƒØ§Ù„Ø© :");
      const isUnder  = loc.includes("Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…");
      const isDone   = loc.includes("Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…");
      return isAgency || isUnder || isDone;
    }

    // ===== Stock Aggregation (SpecKey) + Tasks Meta (Workspace DB) =====
    let STOCK_TASKS_MAP = new Map();
    let STOCK_TASKS_LOADED = false;

    const MONTHS_AR = [
      "ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ",
      "ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"
    ];

    function stockTaskDocId(specKey){
      // Firestore doc ids cannot contain '/'
      return encodeURIComponent(String(specKey||""));
    }

    async function loadStockTasksOnce(){
      if(STOCK_TASKS_LOADED) return;
      STOCK_TASKS_LOADED = true;
      STOCK_TASKS_MAP = new Map();
      try{
        const snap = await getDocs(collection(db, "stock_tasks"));
        snap.forEach(d=>{
          const v = d.data() || {};
          const k = v.specKey || decodeURIComponent(d.id);
          if(k) STOCK_TASKS_MAP.set(String(k), { ...v, _id: d.id });
        });
      }catch(e){
        console.warn('loadStockTasksOnce', e);
      }finally{
        // Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ù…Ù‡Ø§Ù… Ø§Ù„Ø§Ø³ØªÙˆÙƒØŒ Ø·Ø¨Ù‚ ÙÙ„ØªØ± "ØºÙŠØ± Ù…Ø¹Ù…ÙˆÙ„ Ù„Ù‡Ø§ Ù…ÙˆÙ†ØªØ§Ø¬" Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø§ØªØ§ Ù„ÙŠØ³Øª
        try{ applySpecKeyNotMontagedFilter(); }catch(_e){}
      }
    }

    let stockSaveTimers = new Map();
    function scheduleSaveStockTask(specKey, patch){
      const key = String(specKey||"");
      if(!key) return;
      const prev = STOCK_TASKS_MAP.get(key) || { specKey: key };
      const next = { ...prev, ...patch, specKey: key, updatedAt: serverTimestamp() };
      STOCK_TASKS_MAP.set(key, next);
      // Ø­Ø¯Ø« Ø§Ù„Ø¯Ø§ØªØ§ Ù„ÙŠØ³Øª ÙÙˆØ±Ù‹Ø§ (Ù„Ø£Ù†Ù†Ø§ Ø¨Ù†ÙÙ„ØªØ± "ØºÙŠØ± Ù…Ø¹Ù…ÙˆÙ„ Ù„Ù‡Ø§ Ù…ÙˆÙ†ØªØ§Ø¬")
      try{ applySpecKeyNotMontagedFilter(); }catch(_e){}

      // debounce per row
      if(stockSaveTimers.has(key)) clearTimeout(stockSaveTimers.get(key));
      stockSaveTimers.set(key, setTimeout(async ()=>{
        try{
          await setDoc(doc(db, "stock_tasks", stockTaskDocId(key)), next, { merge:true });
        }catch(e){
          console.warn('saveStockTask', e);
        }
      }, 350));
    }

    function ynSelect(value=""){
      const v = String(value||"");
      const y = v === "Ù†Ø¹Ù…" ? "selected" : "";
      const n = v === "Ù„Ø§" ? "selected" : "";
      return `<select class="stock-ctrl small" data-type="yn"><option value="">â€”</option><option value="Ù†Ø¹Ù…" ${y}>Ù†Ø¹Ù…</option><option value="Ù„Ø§" ${n}>Ù„Ø§</option></select>`;
    }

    function montageDetailsSelect(value=""){
      const v = String(value||"");
      const a = v === "ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª" ? "selected" : "";
      const b = v === "ØµÙˆØ± ÙÙ‚Ø·" ? "selected" : "";
      return `<select class="stock-ctrl small" data-type="montageDetails"><option value="">â€”</option><option value="ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª" ${a}>ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª</option><option value="ØµÙˆØ± ÙÙ‚Ø·" ${b}>ØµÙˆØ± ÙÙ‚Ø·</option></select>`;
    }

    function monthSelect(value=""){
      const v = String(value||"");
      return `<select class="stock-ctrl small" data-type="month"><option value="">â€”</option>${MONTHS_AR.map(m=>`<option value="${escapeAttr(m)}" ${(m===v)?'selected':''}>${escapeHtml(m)}</option>`).join('')}</select>`;
    }

    function yearInput(value=""){
      const v = String(value||"");
      return `<input class="stock-ctrl small" data-type="year" inputmode="numeric" placeholder="Ø§Ù„Ø³Ù†Ø©" value="${escapeAttr(v)}" />`;
    }

    async function renderStockTab(){
      const emptyEl = $("stockEmpty");
      const wrapEl  = $("stockTableWrap");
      const tableEl = $("stockTable");
      const searchEl = document.getElementById('stockSearch');

      const arr = Array.isArray(AGENDA_STOCK) ? AGENDA_STOCK : [];
      // ÙÙ„ØªØ± stock (Ø¨Ø¯ÙˆÙ† Ø§Ù„ÙˆÙƒØ§Ù„Ø© + Ø¨Ø¯ÙˆÙ† Ù…Ø¨Ø§Ø¹ ØªØ­Øª/ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…)
      const filtered = arr.filter(r => !isExcludedByInventoryFilter(r));

      // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Unique Spec Key (Ø¨Ø¯ÙˆÙ† Ø£Ù„ÙˆØ§Ù†)
      const groups = new Map();
      for(const r of filtered){
        const key = buildSpecKeyNoColors({
          car: r.car ?? r["Ø§Ù„Ø³ÙŠØ§Ø±Ø©"],
          variant: r.variant ?? r["Ø§Ù„Ø¨ÙŠØ§Ù†"],
          modelYear: r.modelYear ?? r["Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„"],
        });
        if(!key || key === "- | - | -") continue;
        const g = groups.get(key) || { specKey:key, count:0 };
        g.count += 1;
        groups.set(key, g);
      }

      let rows = Array.from(groups.values());

      // Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ SpecKey
      const q = normalizeArabicText(searchEl?.value || "");
      if(q){
        rows = rows.filter(r => normalizeArabicText(r.specKey).includes(q));
      }

      // ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠ
      rows.sort((a,b)=> a.specKey.localeCompare(b.specKey,'ar',{numeric:true,sensitivity:'base'}));

      $("stockCount").textContent = rows.reduce((s,r)=> s + (r.count||0), 0);

      if(!rows.length){
        emptyEl.style.display = "";
        wrapEl.style.display = "none";
        tableEl.innerHTML = "";
        return;
      }

      emptyEl.style.display = "none";
      wrapEl.style.display = "";

      // Ø­Ù…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
      await loadStockTasksOnce();

      const months = [
        "ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ",
        "ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"
      ];

      const yesNoOptions = (val)=>
        `
          <option value="" ${!val?'selected':''}>-</option>
          <option value="Ù†Ø¹Ù…" ${val==='Ù†Ø¹Ù…'?'selected':''}>Ù†Ø¹Ù…</option>
          <option value="Ù„Ø§" ${val==='Ù„Ø§'?'selected':''}>Ù„Ø§</option>`;

      const montageDetailsOptions = (val)=>
        `
          <option value="" ${!val?'selected':''}>-</option>
          <option value="ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª: Ù†Ø¹Ù…" ${val==='ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª: Ù†Ø¹Ù…'?'selected':''}>ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª: Ù†Ø¹Ù…</option>
          <option value="ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª: Ù„Ø§" ${val==='ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª: Ù„Ø§'?'selected':''}>ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª: Ù„Ø§</option>`;

      const cols = [
        {k:'idx',  label:'Ù…', w:70},
        {k:'spec', label:'Unique Spec Key (Ø§Ù„Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®)', w:520},
        {k:'count',label:'Ø§Ù„Ø¹Ø¯Ø¯', w:90},
        {k:'photo',label:'ØªØµÙˆÙŠØ±', w:140},
        {k:'montage',label:'Ù…ÙˆÙ†ØªØ§Ø¬', w:140},
        {k:'montageDetails',label:'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ†ØªØ§Ø¬', w:240},
        {k:'inAgenda',label:'Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©', w:170},
        {k:'agendaMonth',label:'Ø§Ù„Ø´Ù‡Ø±', w:160},
        {k:'agendaYear',label:'Ø§Ù„Ø³Ù†Ø©', w:120},
      ];

      const colgroup = `<colgroup>${cols.map(c=>`<col style="width:${c.w}px">`).join('')}</colgroup>`;
      const thead = `<thead><tr>${cols.map(c=>`<th>${escapeHtml(c.label)}</th>`).join('')}</tr></thead>`;



      // Prepare rows for Excel export (merge saved controls)
      __LAST_STOCK_ROWS = rows.map(r=>{
        const saved = STOCK_TASKS_MAP.get(r.specKey) || {};
        return {
          specKey: r.specKey,
          count: r.count || 0,
          photo: saved.photo || '',
          montage: saved.montage || '',
          montageDetails: saved.montageDetails || '',
          inAgenda: saved.inAgenda || '',
          agendaMonth: saved.agendaMonth || '',
          agendaYear: saved.agendaYear || ''
        };
      });
      const tbody = `<tbody>${rows.map((r,i)=>{
        const specKey = r.specKey;
        const saved = STOCK_TASKS_MAP.get(specKey) || {};
        const photo = saved.photo || '';
        const montage = saved.montage || '';
        const montageDetails = saved.montageDetails || '';
        const inAgenda = saved.inAgenda || '';
        const agendaMonth = saved.agendaMonth || '';
        const agendaYear = saved.agendaYear || '';

        const montageDisabled = montage !== 'Ù†Ø¹Ù…';
        const agendaDisabled = inAgenda !== 'Ù†Ø¹Ù…';

        return `
          <tr data-spec="${escapeAttr(specKey)}">
            <td class="center">${i+1}</td>
            <td class="wrap">
              <button type="button" class="btn secondary xs" data-copy="1" style="width:100%;justify-content:space-between;gap:8px">
                <span style="text-align:right;white-space:normal;line-height:1.6">${escapeHtml(specKey)}</span>
                <span class="stock-badge-mini">Ù†Ø³Ø®</span>
              </button>
            </td>
            <td class="center">
              <button type="button" class="btn secondary xs stock-count-btn" data-show-colors="1" title="Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù„ÙˆØ§Ù†" style="min-width:44px;justify-content:center">
                <span class="stock-badge-mini stock-count">${r.count}</span>
              </button>
            </td>
            <td>
              <select class="stock-ctrl" data-field="photo">${yesNoOptions(photo)}</select>
            </td>
            <td>
              <select class="stock-ctrl" data-field="montage">${yesNoOptions(montage)}</select>
            </td>
            <td>
              <select class="stock-ctrl" data-field="montageDetails" ${montageDisabled ? 'disabled' : ''}>
                ${montageDetailsOptions(montageDetails)}
              </select>
            </td>
            <td>
              <select class="stock-ctrl" data-field="inAgenda">${yesNoOptions(inAgenda)}</select>
            </td>
            <td>
              <select class="stock-ctrl" data-field="agendaMonth" ${agendaDisabled ? 'disabled' : ''}>
                <option value="" ${!agendaMonth?'selected':''}>-</option>
                ${months.map(m=>`<option value="${escapeAttr(m)}" ${agendaMonth===m?'selected':''}>${escapeHtml(m)}</option>`).join('')}
              </select>
            </td>
            <td>
              <input class="stock-ctrl small" data-field="agendaYear" type="number" min="2000" max="2100" placeholder="YYYY" value="${escapeAttr(agendaYear)}" ${agendaDisabled ? 'disabled' : ''}/>
            </td>
          </tr>`;
      }).join('')}</tbody>`;

      tableEl.innerHTML = colgroup + thead + tbody;

      // Delegation: copy + save
      tableEl.onclick = (ev)=>{
        const tr = ev.target.closest('tr');
        const key = tr?.getAttribute('data-spec') || '';

        const copyBtn = ev.target.closest('[data-copy]');
        if(copyBtn){
          if(key){
            navigator.clipboard.writeText(key).then(()=> toast('ØªÙ… Ø§Ù„Ù†Ø³Ø®')).catch(()=> toast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ø³Ø®'));
          }
          return;
        }

        const colorsBtn = ev.target.closest('[data-show-colors]');
        if(colorsBtn){
          if(key) openColorsModal(key);
          return;
        }
      };

      tableEl.onchange = (ev)=>{
        const el = ev.target;
        if(!(el instanceof HTMLSelectElement)) return;
        const tr = el.closest('tr');
        const key = tr?.getAttribute('data-spec') || '';
        const field = el.getAttribute('data-field');
        if(!key || !field) return;

        const value = el.value || '';
        scheduleSaveStockTask(key, { [field]: value });

        // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø¨Ø¹Ø©
        if(field === 'montage'){
          const md = tr.querySelector('[data-field="montageDetails"]');
          if(md){
            md.disabled = (value !== 'Ù†Ø¹Ù…');
            if(md.disabled){
              md.value = '';
              scheduleSaveStockTask(key, { montageDetails: '' });
            }
          }
        }
        if(field === 'inAgenda'){
          const m = tr.querySelector('[data-field="agendaMonth"]');
          const y = tr.querySelector('[data-field="agendaYear"]');
          const dis = (value !== 'Ù†Ø¹Ù…');
          if(m){
            m.disabled = dis;
            if(dis){ m.value=''; scheduleSaveStockTask(key,{agendaMonth:''}); }
          }
          if(y){
            y.disabled = dis;
            if(dis){ y.value=''; scheduleSaveStockTask(key,{agendaYear:''}); }
          }
        }
      };

      tableEl.oninput = (ev)=>{
        const el = ev.target;
        if(!(el instanceof HTMLInputElement)) return;
        const tr = el.closest('tr');
        const key = tr?.getAttribute('data-spec') || '';
        const field = el.getAttribute('data-field');
        if(!key || field !== 'agendaYear') return;
        const v = String(el.value || '').trim();
        scheduleSaveStockTask(key, { agendaYear: v });
      };
    }

    function openHome(){
      MODE="home"; LIST_TYPE=null; CURRENT_WORKSPACE=null;
      if(unsubWorkspaces){unsubWorkspaces();unsubWorkspaces=null;}
      if(unsubTasks){unsubTasks();unsubTasks=null;}

      setNavActive("navHome");
      $("pageTitle").textContent = "Workspace â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª ÙˆØ§Ù„Ø­Ù…Ù„Ø§Øª";
      $("pageDesc").textContent = "Ø£Ù†Ø´Ø¦ Ø£Ø¬Ù†Ø¯Ø§Øª Ù„Ù„Ù…Ù‡Ø§Ù… Ø£Ùˆ Ø­Ù…Ù„Ø§Øª Ø¨ØªÙˆØ§Ø±ÙŠØ® ÙˆÙˆØµÙâ€¦ Ø«Ù… Ø£Ø¶Ù ØªØ§Ø³ÙƒØ§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©.";
      $("btnBack").style.display="none";
      $("btnCreateAgenda").style.display="";
      $("btnCreateCampaign").style.display="";
      $("homeMeta").textContent = "Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (mzj-workspace-c7d4e)";
      showView("home");
    }

    $("btnRefresh").addEventListener("click", ()=> { if(LIST_TYPE) openList(LIST_TYPE); });

    // Board filter (agenda): show tasks for selected user
    $("boardUserFilter").addEventListener("change", (e)=>{
      BOARD_USER_FILTER_UID = String(e.target.value||"");
      if(MODE==="board" && CURRENT_WORKSPACE){
        renderBoardColumns(CURRENT_WORKSPACE, applyBoardUserFilter(BOARD_TASKS_ALL));
      }
    });

    function openList(type){
      MODE = type==="agenda" ? "agendas" : "campaigns";
      LIST_TYPE = type;
      CURRENT_WORKSPACE = null;
      if(unsubTasks){unsubTasks();unsubTasks=null;}

      setNavActive(type==="agenda" ? "navAgendas" : "navCampaigns");

      $("btnBack").style.display="";
      $("btnCreateAgenda").style.display = type==="agenda" ? "" : "none";
      $("btnCreateCampaign").style.display = type==="campaign" ? "" : "none";

      $("pageTitle").textContent = type==="agenda" ? "Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª" : "Ø§Ù„Ø­Ù…Ù„Ø§Øª";
      $("pageDesc").textContent  = type==="agenda"
        ? "Ø§Ø®ØªØ± Ø£Ø¬Ù†Ø¯Ø© Ø£Ùˆ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©. Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø³ØªØ¬Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØªØ¶ÙŠÙ ØªØ§Ø³ÙƒØ§Øª Ø¨Ø³Ù‡ÙˆÙ„Ø©."
        : "Ø§Ø®ØªØ± Ø­Ù…Ù„Ø© Ø£Ùˆ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ ÙˆØµÙ + ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ©/Ù†Ù‡Ø§ÙŠØ© + Ø£Ø¹Ù…Ø¯Ø©.";

      $("listTitle").textContent = type==="agenda" ? "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª" : "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ù…Ù„Ø§Øª";

      showView("list");
      listenWorkspaces(type);
    }

    function listenWorkspaces(type){
      if(unsubWorkspaces){unsubWorkspaces();unsubWorkspaces=null;}

      const qy = query(
        collection(db,"workspaces"),
        where("type","==", type)
      );
unsubWorkspaces = onSnapshot(qy, (snap)=>{
        let items=[];
        snap.forEach(d=> items.push({ id:d.id, ...(d.data()||{}) }));
        // ØªØµÙÙŠØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·Ø© + ØªØ±ØªÙŠØ¨ Ù…Ø­Ù„ÙŠ Ù„ØªÙØ§Ø¯ÙŠ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù€ Composite Index
        items = items.filter(x=> x.active !== false);
        items.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
        renderList(type, items);
      }, (err)=>{
        console.error(err);
        toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©");
      });
    }

    function renderList(type, items){
      const container = $("listContainer");
      const empty = $("listEmpty");
      container.innerHTML = "";
      empty.style.display = items.length ? "none" : "";

      items.forEach(x=>{
        const el = document.createElement("div");
        el.className = "list-item";

        const columnsCount = Array.isArray(x.columns) ? x.columns.length : 0;
        let sub = "";
        if(type==="agenda"){
          sub = `Ø£Ø¹Ù…Ø¯Ø©: ${columnsCount}`;
        }else{
          const s = x.startDate || "â€”";
          const e = x.endDate || "â€”";
          sub = `Ø§Ù„ÙØªØ±Ø©: ${s} â†’ ${e} | Ø£Ø¹Ù…Ø¯Ø©: ${columnsCount}`;
        }

        const desc = type==="campaign" ? (x.description||"") : "";
        el.innerHTML = `
          <div class="li-main">
            <p class="li-title">${escapeHtml(x.name||"Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")}</p>
            <p class="li-sub">${escapeHtml(desc ? (desc + " â€” " + sub) : sub)}</p>
          </div>
          <div class="li-right">
            <span class="tag"><span class="mini"></span>${type==="agenda"?"Agenda":"Campaign"}</span>
            <button class="btn sm secondary" data-open="1" type="button">ÙØªØ­</button>
          </div>
        `;

        el.querySelector('[data-open="1"]').addEventListener("click", (e)=>{
          e.stopPropagation();
          openBoard(x);
        });

        el.addEventListener("click", ()=> openBoard(x));
        container.appendChild(el);
      });
    }

    function openBoard(workspace){
      MODE="board";
      CURRENT_WORKSPACE = workspace;

      $("btnBack").style.display="";
      $("btnCreateAgenda").style.display="none";
      $("btnCreateCampaign").style.display="none";

      $("pageTitle").textContent = workspace.type==="agenda" ? "Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©" : "Ù„ÙˆØ­Ø© Ø§Ù„Ø­Ù…Ù„Ø©";
      $("pageDesc").textContent  = "Ø§Ø¶ØºØ· â• Ø¯Ø§Ø®Ù„ Ø£ÙŠ Ø¹Ù…ÙˆØ¯ Ù„Ø¥Ø¶Ø§ÙØ© ØªØ§Ø³Ùƒ. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø³Ùƒ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø£Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.";

      $("boardTitle").textContent = workspace.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
      if(workspace.type==="campaign"){
        const s = workspace.startDate || "â€”";
        const e = workspace.endDate || "â€”";
        const d = workspace.description ? workspace.description : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ";
        $("boardSub").textContent = `Ø§Ù„ÙØªØ±Ø©: ${s} â†’ ${e} | ${d}`;
      }else{
        $("boardSub").textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: ${(workspace.columns||[]).length}`;
      }

      // Agenda-only: filter tasks by assignee
      const bfWrap = $("boardFilterWrap");
      const bfSel = $("boardUserFilter");
      if(workspace.type === "agenda"){
        bfWrap.style.display = "";
        // rebuild options each time (users may update)
        const cur = BOARD_USER_FILTER_UID || "";
        bfSel.innerHTML = `<option value="">Ø§Ù„ÙƒÙ„</option>`;
        USERS.slice().sort((a,b)=>(a.name||"").localeCompare(b.name||"","ar")).forEach(u=>{
          const opt = document.createElement("option");
          opt.value = u.uid;
          opt.textContent = u.name;
          bfSel.appendChild(opt);
        });
        bfSel.value = cur;
      }else{
        bfWrap.style.display = "none";
        BOARD_USER_FILTER_UID = "";
      }

      // show VIN for the selected spec key
      
      showView("board");

      $("btnEditBoard").onclick = ()=> openBoardModal(workspace.type, "edit", workspace);
      $("btnDeleteBoard").onclick = ()=> deleteWorkspace(workspace);

      renderBoardColumns(workspace, []);
      listenTasksForWorkspace(workspace.id);
    }

    function applyBoardUserFilter(tasks){
      const arr = Array.isArray(tasks)?tasks:[];
      if(!CURRENT_WORKSPACE || CURRENT_WORKSPACE.type!=="agenda") return arr;
      const uid = String(BOARD_USER_FILTER_UID||"");
      if(!uid) return arr;
      return arr.filter(t=> String(t.assigneeUid||"") === uid);
    }

    function renderBoardColumns(workspace, tasks){
      const colsEl = $("boardCols");
      colsEl.innerHTML = "";

      const cols = Array.isArray(workspace.columns) && workspace.columns.length ? workspace.columns : ["Ù‚Ø§Ø¦Ù…Ø©"];
      const byCol = {};
      cols.forEach(c=> byCol[c]=[]);
      tasks.forEach(t=>{
        const c = t.column || cols[0];
        if(!byCol[c]) byCol[c]=[];
        byCol[c].push(t);
      });

      cols.forEach(colName=>{
        const col = document.createElement("section");
        col.className = "col";
        if(String(colName||'').includes('ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡')) col.classList.add('done-col');
        if(/ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡/.test(colName)) col.classList.add("done-col");

        const list = byCol[colName] || [];
        const head = document.createElement("div");
        head.className = "col-head";
        head.innerHTML = `
          <div class="col-title">
            <span>${escapeHtml(colName)}</span>
            <span class="count-badge">${list.length}</span>
          </div>
          <button class="btn secondary xs" type="button">â• ØªØ§Ø³Ùƒ</button>
        `;
        head.querySelector("button").addEventListener("click", (e)=>{
          e.stopPropagation();
          openTaskModal("create", { workspace, column: colName });
        });

        const body = document.createElement("div");
        body.className = "col-body";

        if(!list.length){
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.style.fontSize = "12px";
          empty.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ§Ø³ÙƒØ§Øª Ù‡Ù†Ø§. Ø§Ø¶ØºØ· â• Ù„Ø¥Ø¶Ø§ÙØ© ØªØ§Ø³Ùƒ.";
          body.appendChild(empty);
        }else{
          list.slice().sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)).forEach(t=>{
            const card = document.createElement("div");
            card.className = "task-card";

            const assignee = t.assigneeName || "â€”";
            const due = t.due || "â€”";
            const specKey = t.specKey || "â€”";

            card.innerHTML = `
              <p class="t-title">${escapeHtml(specKey)}</p>
              <div class="t-meta">
                <span class="badge"><span class="dot"></span>${escapeHtml(assignee)}</span>
                <span class="badge" style="background:#fff;border-color:rgba(62,36,32,.10)"><span class="dot" style="background:#6b7280"></span>ğŸ“… ${escapeHtml(due)}</span>
              </div>
            `;

            card.addEventListener("click", ()=> openTaskDetail(t));
            body.appendChild(card);
          });
        }

        col.appendChild(head);
        col.appendChild(body);
        colsEl.appendChild(col);
      });
    }

    function listenTasksForWorkspace(workspaceId){
      if(unsubTasks){unsubTasks();unsubTasks=null;}
      // Ù…Ù„Ø§Ø­Ø¸Ø©: where + orderBy ÙŠØ­ØªØ§Ø¬ Composite IndexØŒ ÙÙ‡Ù†Ø³Ø­Ø¨ Ø¨Ø¯ÙˆÙ† orderBy ÙˆÙ†Ø±ØªÙ‘Ø¨ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ù€ Index
      const qy = query(
        collection(db,"workspace_tasks"),
        where("workspaceId","==", workspaceId)
      );
      unsubTasks = onSnapshot(qy, (snap)=>{
        let tasks=[];
        snap.forEach(d=> tasks.push({ id:d.id, ...(d.data()||{}) }));
        // ØªØ±ØªÙŠØ¨ Ù…Ø­Ù„ÙŠ Ø¨Ø§Ù„Ø£Ø­Ø¯Ø« (createdAt)
        tasks.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
        BOARD_TASKS_ALL = tasks;
        renderBoardColumns(CURRENT_WORKSPACE, applyBoardUserFilter(tasks));
      }, (err)=>{
        console.error(err);
        const msg = (err?.code ? (err.code + " â€” ") : "") + (err?.message || "");
        toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ§Ø³ÙƒØ§Øª: " + (msg || "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª/Rules"));
      });
    }

    // Board modal
    const boardModal = $("boardModal");
    const boardType = $("boardType");
    const boardName = $("boardName");
    const campaignFields = $("campaignFields");
    const campaignDesc = $("campaignDesc");
    const campaignStart = $("campaignStart");
    const campaignEnd = $("campaignEnd");
    const colInput = $("colInput");
    const colsChips = $("colsChips");

    let BOARD_MODAL_MODE = "create";
    let BOARD_MODAL_TYPE = "agenda";
    let BOARD_EDIT_ID = null;
    let COLUMNS_TMP = [];

    const DEFAULT_AGENDA_COLS = ["Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª","Ø±ÙŠÙ„ Ù‚ØµÙŠØ±","ØªØµÙ…ÙŠÙ… ØµÙˆØ±","ÙŠÙˆØªÙŠÙˆØ¨","ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"];
    const DEFAULT_CAMPAIGN_COLS = ["Ø±ÙŠÙ„Ø² - ÙƒØ§Ø´","Ù…ÙˆØ´Ù† - ÙƒØ§Ø´","Ø¬Ø±Ø§ÙÙŠÙƒ - ÙƒØ§Ø´","Ø±ÙŠÙ„Ø² Ø§Ù‚Ø³Ø§Ø·","Ai Ø§Ù‚Ø³Ø§Ø·","Ø¬Ø±Ø§ÙÙŠÙƒ - Ø§Ù‚Ø³Ø§Ø·","Ø´Ø±ÙƒØ§Øª - Ù„ÙŠÙ†ÙƒØ¯ Ø§Ù†"];

    $("boardModalClose").addEventListener("click", ()=> closeBoardModal());
    $("boardCancel").addEventListener("click", ()=> closeBoardModal());
    boardModal.addEventListener("click", (e)=> { if(e.target===boardModal) closeBoardModal(); });

    $("btnAddCol").addEventListener("click", ()=>{
      const v = (colInput.value||"").trim();
      if(!v) return;
      addCol(v);
      colInput.value="";
    });
    $("btnAddDefaults").addEventListener("click", ()=>{
      const defs = BOARD_MODAL_TYPE==="agenda" ? DEFAULT_AGENDA_COLS : DEFAULT_CAMPAIGN_COLS;
      defs.forEach(addCol);
    });

    function addCol(name){
      const v = (name||"").trim();
      if(!v) return;
      if(COLUMNS_TMP.includes(v)) return;
      COLUMNS_TMP.push(v);
      renderColChips();
    }
    function removeCol(name){
      COLUMNS_TMP = COLUMNS_TMP.filter(x=> x!==name);
      renderColChips();
    }
    function renderColChips(){
      colsChips.innerHTML = "";
      if(!COLUMNS_TMP.length){
        colsChips.innerHTML = `<div class="empty" style="padding:10px;font-size:12px">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø¹Ø¯.</div>`;
        return;
      }
      COLUMNS_TMP.forEach(c=>{
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.innerHTML = `${escapeHtml(c)} <button type="button" title="Ø­Ø°Ù">âœ•</button>`;
        chip.querySelector("button").addEventListener("click", ()=> removeCol(c));
        colsChips.appendChild(chip);
      });
    }

    function openBoardModal(type, mode, workspace=null){
      BOARD_MODAL_TYPE = type;
      BOARD_MODAL_MODE = mode;
      BOARD_EDIT_ID = workspace?.id || null;

      boardType.value = (type==="agenda" ? "Ø£Ø¬Ù†Ø¯Ø© (Tasks)" : "Ø­Ù…Ù„Ø© (Campaign)");
      $("boardModalTitle").textContent = mode==="create"
        ? (type==="agenda" ? "Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø¬Ù†Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©" : "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©")
        : (type==="agenda" ? "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©" : "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø©");

      campaignFields.style.display = (type==="campaign") ? "" : "none";

      boardName.value = workspace?.name || "";
      campaignDesc.value = workspace?.description || "";
      campaignStart.value = workspace?.startDate || "";
      campaignEnd.value = workspace?.endDate || "";

      COLUMNS_TMP = Array.isArray(workspace?.columns) ? [...workspace.columns] : [];
      renderColChips();

      boardModal.classList.add("show");
    }

    function closeBoardModal(){
      boardModal.classList.remove("show");
      BOARD_EDIT_ID = null;
      COLUMNS_TMP = [];
      colInput.value = "";
    }

    $("boardSave").addEventListener("click", async ()=>{
      const name = (boardName.value||"").trim();
      if(!name) return toast("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©/Ø§Ù„Ø­Ù…Ù„Ø©");
      if(!COLUMNS_TMP.length) return toast("Ø£Ø¶Ù Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");

      const payload = {
        type: BOARD_MODAL_TYPE,
        name,
        columns: COLUMNS_TMP,
        active: true
      };

      if(BOARD_MODAL_TYPE==="campaign"){
        payload.description = (campaignDesc.value||"").trim() || null;
        payload.startDate = campaignStart.value || null;
        payload.endDate = campaignEnd.value || null;
      }

      try{
        if(BOARD_MODAL_MODE==="create"){
          payload.createdAt = serverTimestamp();
          payload.createdBy = CURRENT_USER?.uid || null;
          await addDoc(collection(db,"workspaces"), payload);
          toast("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ±");
        }else{
          if(!BOARD_EDIT_ID) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ID Ù„Ù„ØªØ¹Ø¯ÙŠÙ„");
          await updateDoc(doc(db,"workspaces", BOARD_EDIT_ID), payload);
          toast("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
        }
        closeBoardModal();
      }catch(err){
        console.error(err);
        const msg = (err?.code ? (err.code + " â€” ") : "") + (err?.message || "");
        toast("âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + (msg || "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Firestore Rules)"));
      }
    });

    async function deleteWorkspace(workspace){
      if(!workspace?.id) return;
      if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù (Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©/Ø§Ù„Ø­Ù…Ù„Ø©)ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù„ÙˆØ­Ø© ÙÙ‚Ø·ØŒ ÙˆØ§Ù„ØªØ§Ø³ÙƒØ§Øª Ø³ØªØ¸Ù„ (Ø¥Ù„Ø§ Ù„Ùˆ Ø·Ù„Ø¨Øª Ø­Ø°ÙÙ‡Ø§).")) return;

      try{
        await deleteDoc(doc(db,"workspaces", workspace.id));
        toast("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù");
        openList(workspace.type);
      }catch(err){
        console.error(err);
        toast("âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù");
      }
    }

    // Task modal
    const taskModal = $("taskModal");
    const taskSpecKey = $("taskSpecKey");
const taskDesc = $("taskDesc");
    // ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…
    const taskDue = $("taskDue");
    const taskAssignee = $("taskAssignee");
    const taskColumn = $("taskColumn");
    const taskLinksWrap = $("taskLinksWrap");
    const linkTitle = $("linkTitle");
    const linkUrl = $("linkUrl");
    const linksChips = $("linksChips");

    let TASK_MODE = "create";
    let TASK_CTX = null;
    let LINKS_TMP = [];

    $("taskModalClose").addEventListener("click", ()=> closeTaskModal());
    $("taskCancel").addEventListener("click", ()=> closeTaskModal());
    taskModal.addEventListener("click", (e)=> { if(e.target===taskModal) closeTaskModal(); });

    function isSpecKeyAllowed(v){
      const x = String(v||"").trim();
      if(!x) return false;
      return (SPEC_KEY_SET && SPEC_KEY_SET.has(x));
    }

    // Ù…Ù†Ø¹ ÙƒØªØ§Ø¨Ø© Spec Key Ø®Ø§Ø±Ø¬ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø­ØªÙ‰ Ù„Ùˆ ÙƒØªØ¨Ù‡Ø§ ÙŠØ¯ÙˆÙŠÙ‹Ø§)
    taskSpecKey.addEventListener("change", ()=>{
      const v = (taskSpecKey.value||"").trim();
      if(!v) return;
      // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ§Ø³Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      if(TASK_MODE!=="create" && CURRENT_TASK?.specKey && v===String(CURRENT_TASK.specKey).trim()) return;
      if(!isSpecKeyAllowed(v)){
        taskSpecKey.value = "";
        toast("Ø§Ø®ØªØ± Unique Spec Key Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙ‚Ø·");
      }
    });

    taskSpecKey.addEventListener("blur", ()=>{
      const v = (taskSpecKey.value||"").trim();
      if(!v) return;
      if(TASK_MODE!=="create" && CURRENT_TASK?.specKey && v===String(CURRENT_TASK.specKey).trim()) return;
      if(!isSpecKeyAllowed(v)){
        taskSpecKey.value = "";
        toast("Ø§Ø®ØªØ± Unique Spec Key Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙ‚Ø·");
      }
    });
    $("btnAddLink").addEventListener("click", ()=>{
      const t = (linkTitle.value||"").trim() || "Ø±Ø§Ø¨Ø·";
      const u = (linkUrl.value||"").trim();
      if(!u || !/^https?:\/\//i.test(u)) return toast("Ø§ÙƒØªØ¨ Ø±Ø§Ø¨Ø· ÙŠØ¨Ø¯Ø£ Ø¨Ù€ http(s)://");
      LINKS_TMP.push({ title:t, url:u });
      linkTitle.value=""; linkUrl.value="";
      renderLinksChips();
    });

    function renderLinksChips(){
      linksChips.innerHTML="";
      if(!LINKS_TMP.length){
        linksChips.innerHTML = `<div class="empty" style="padding:10px;font-size:12px">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø±ÙˆØ§Ø¨Ø· Ø¨Ø¹Ø¯.</div>`;
        return;
      }
      LINKS_TMP.forEach((l,idx)=>{
        const chip = document.createElement("span");
        chip.className="chip";
        chip.innerHTML = `
          ğŸ”— ${escapeHtml(l.title)}
          <a href="${escapeHtml(l.url)}" target="_blank" rel="noopener" style="color:var(--brown);text-decoration:underline;font-weight:800">ÙØªØ­</a>
          <button type="button" title="Ø­Ø°Ù">âœ•</button>
        `;
        chip.querySelector("button").addEventListener("click", ()=>{
          LINKS_TMP.splice(idx,1);
          renderLinksChips();
        });
        linksChips.appendChild(chip);
      });
    }

    function openTaskModal(mode, ctxOrTask){
      TASK_MODE = mode;

      if(mode==="create"){
        TASK_CTX = ctxOrTask; // {workspace, column}
        CURRENT_TASK = null;

        $("taskModalTitle").textContent = "ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯";
        $("taskDelete").style.display="none";

        taskColumn.value = TASK_CTX.column;
        taskSpecKey.value = "";
        taskDesc.value = "";
        taskDue.value = "";
        taskAssignee.value = "";

        
        const isCampaign = TASK_CTX.workspace.type==="campaign";
        taskLinksWrap.style.display = isCampaign ? "" : "none";
        LINKS_TMP = [];
        renderLinksChips();
      }else{
        CURRENT_TASK = ctxOrTask;
        TASK_CTX = { workspace: CURRENT_WORKSPACE, column: CURRENT_TASK.column };

        $("taskModalTitle").textContent = "ØªØ¹Ø¯ÙŠÙ„ ØªØ§Ø³Ùƒ";
        $("taskDelete").style.display="";

        taskColumn.value = CURRENT_TASK.column || "";
        taskSpecKey.value = CURRENT_TASK.specKey || "";
        taskDesc.value = CURRENT_TASK.description || "";
        taskDue.value = "";
        taskAssignee.value = CURRENT_TASK.assigneeUid || "";

        
        const isCampaign = CURRENT_TASK.type==="campaign";
        taskLinksWrap.style.display = isCampaign ? "" : "none";
        LINKS_TMP = Array.isArray(CURRENT_TASK.links) ? [...CURRENT_TASK.links] : [];
        renderLinksChips();
      }

      taskModal.classList.add("show");
    }

    function closeTaskModal(){
      taskModal.classList.remove("show");
      TASK_CTX = null;
      LINKS_TMP = [];
    }

    $("taskSave").addEventListener("click", async ()=>{
      const specKey = (taskSpecKey.value||"").trim();
      const description = (taskDesc.value||"").trim() || null;
      // ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…
      const due = null;
      const assigneeUid = taskAssignee.value || null;
      const assigneeObj = USERS.find(u=> u.uid===assigneeUid);
      const assigneeName = assigneeObj?.name || null;

      if(!specKey) return toast("Ø§ÙƒØªØ¨ Unique Spec Key");
      // Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (ØºÙŠØ± Ù…Ø¹Ù…ÙˆÙ„ Ù„Ù‡Ø§ Ù…ÙˆÙ†ØªØ§Ø¬)
      const allowed = (SPEC_KEY_SET && SPEC_KEY_SET.has(specKey));
      const editingSame = (TASK_MODE!=="create" && CURRENT_TASK?.specKey && specKey===String(CURRENT_TASK.specKey).trim());
      if(!allowed && !editingSame) return toast("Ø§Ø®ØªØ± Unique Spec Key Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙ‚Ø·");
      if(!TASK_CTX?.workspace?.id) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Workspace Ù…Ø­Ø¯Ø¯");
      if(!TASK_CTX?.column) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…ÙˆØ¯");

      const isCampaign = TASK_CTX.workspace.type==="campaign";

      const payload = {
        workspaceId: TASK_CTX.workspace.id,
        type: TASK_CTX.workspace.type,
        column: TASK_CTX.column,
        specKey,
        description,
        // due removed
        assigneeUid,
        assigneeName
      };

      if(isCampaign) payload.links = LINKS_TMP.length ? LINKS_TMP : [];

      try{
        if(TASK_MODE==="create"){
          payload.createdAt = serverTimestamp();
          payload.createdBy = CURRENT_USER?.uid || null;
          await addDoc(collection(db,"workspace_tasks"), payload);
          toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ");
        }else{
          if(!CURRENT_TASK?.id) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ID Ù„Ù„ØªØ¹Ø¯ÙŠÙ„");
          await updateDoc(doc(db,"workspace_tasks", CURRENT_TASK.id), payload);
          toast("âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ø³Ùƒ");
        }
        closeTaskModal();
      }catch(err){
        console.error(err);
        const msg = (err?.code ? (err.code + " â€” ") : "") + (err?.message || "");
        toast("âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ: " + (msg || "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Firestore Rules)"));
      }
    });

    $("taskDelete").addEventListener("click", async ()=>{
      if(!CURRENT_TASK?.id) return;
      if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØªØ§Ø³ÙƒØŸ")) return;
      try{
        await deleteDoc(doc(db,"workspace_tasks", CURRENT_TASK.id));
        toast("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ§Ø³Ùƒ");
        closeTaskModal();
        closeDetail();
      }catch(err){
        console.error(err);
        toast("âš ï¸ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØªØ§Ø³Ùƒ");
      }
    });

    // Detail
    const detailModal = $("detailModal");
    function openTaskDetail(task){
      CURRENT_TASK = task;

      $("dSpecKey").value = task.specKey || "";
      $("dDue").value = "";
      $("dAssignee").value = task.assigneeName || "â€”";
      $("dColumn").value = task.column || "";
      $("dDesc").value = task.description || "";

      const linksBlock = $("dLinksBlock");
      const dLinks = $("dLinks");
      dLinks.innerHTML="";

      if(task.type==="campaign" && Array.isArray(task.links) && task.links.length){
        linksBlock.style.display="";
        task.links.forEach(l=>{
          const chip = document.createElement("span");
          chip.className="chip";
          chip.innerHTML = `ğŸ”— <a href="${escapeHtml(l.url)}" target="_blank" rel="noopener" style="color:var(--brown);text-decoration:underline;font-weight:900">${escapeHtml(l.title||l.url)}</a>`;
          dLinks.appendChild(chip);
        });
      }else{
        linksBlock.style.display="none";
      }

      detailModal.classList.add("show");
    }
    function closeDetail(){ detailModal.classList.remove("show"); }

    $("detailClose").addEventListener("click", closeDetail);
    $("detailOk").addEventListener("click", closeDetail);
    detailModal.addEventListener("click", (e)=> { if(e.target===detailModal) closeDetail(); });

    $("detailEdit").addEventListener("click", ()=>{
      if(!CURRENT_TASK) return;
      closeDetail();
      openTaskModal("edit", CURRENT_TASK);
    });

    $("detailDelete").addEventListener("click", async ()=>{
      if(!CURRENT_TASK?.id) return;
      if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØªØ§Ø³ÙƒØŸ")) return;
      try{
        await deleteDoc(doc(db,"workspace_tasks", CURRENT_TASK.id));
        toast("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ§Ø³Ùƒ");
        closeDetail();
      }catch(err){
        console.error(err);
        toast("âš ï¸ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØªØ§Ø³Ùƒ");
      }
    });
    // ==================================================
    // Stock Colors Modal + Finish Task Flow
    // ==================================================

    const colorsModal = $("colorsModal");
    const cmSpecKey = $("cmSpecKey");
    const cmExt = $("cmExt");
    const cmInt = $("cmInt");

    const finishModal = $("finishModal");
    const fmSpecKey = $("fmSpecKey");
    const fmMontageDetails = $("fmMontageDetails");
    const fmColorsWrap = $("fmColorsWrap");
    const fmAddColor = $("fmAddColor");

    function uniqSorted(arr){
      return Array.from(new Set((arr||[]).map(v=>String(v||"").trim()).filter(Boolean)))
        .sort((a,b)=> a.localeCompare(b,"ar",{numeric:true,sensitivity:"base"}));
    }

    function getColorsForSpecKey(specKey){
      const key = String(specKey||"").trim();
      const arr = Array.isArray(AGENDA_STOCK) ? AGENDA_STOCK : [];
      const filtered = arr.filter(r => !isExcludedByInventoryFilter(r));
      const ext=[]; const intr=[];
      for(const r of filtered){
        const k = buildSpecKeyNoColors({
          car: r.car ?? r["Ø§Ù„Ø³ÙŠØ§Ø±Ø©"],
          variant: r.variant ?? r["Ø§Ù„Ø¨ÙŠØ§Ù†"],
          modelYear: r.modelYear ?? r["Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„"],
        });
        if(k !== key) continue;
        const e = (r.extColor ?? r["Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ"] ?? r.extcolor ?? r.colorExt ?? r["extColor"] ?? "");
        const i = (r.intColor ?? r["Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ"] ?? r.intcolor ?? r.colorInt ?? r["intColor"] ?? "");
        if(e) ext.push(e);
        if(i) intr.push(i);
      }
      return { ext: uniqSorted(ext), int: uniqSorted(intr) };
    }

    function renderChips(target, items){
      if(!target) return;
      const arr = items || [];
      if(!arr.length){ target.innerHTML = `<span class="hint" style="color:var(--muted)">â€”</span>`; return; }
      target.innerHTML = arr.map(v=> `<span class="chip">${escapeHtml(v)}</span>`).join("");
    }

    function openColorsModal(specKey){
      const key = String(specKey||"").trim();
      if(!key) return;
      const c = getColorsForSpecKey(key);
      cmSpecKey.value = key;
      renderChips(cmExt, c.ext);
      renderChips(cmInt, c.int);
      colorsModal.classList.add("show");
    }
    function closeColorsModal(){ colorsModal.classList.remove("show"); }
    $("colorsClose").addEventListener("click", closeColorsModal);
    $("colorsOk").addEventListener("click", closeColorsModal);
    colorsModal.addEventListener("click", (e)=>{ if(e.target===colorsModal) closeColorsModal(); });

    // ----- Finish modal -----
    let FINISH_COLORS = [];
    let FINISH_COLORS_META = { ext:[], int:[] };

    function colorRowTemplate(idx, extVal="", intVal=""){
      const extOpts = [""].concat(FINISH_COLORS_META.ext).map(v=>
        `<option value="${escapeAttr(v)}" ${v===extVal?"selected":""}>${v?escapeHtml(v):"-"}</option>`).join("");
      const intOpts = [""].concat(FINISH_COLORS_META.int).map(v=>
        `<option value="${escapeAttr(v)}" ${v===intVal?"selected":""}>${v?escapeHtml(v):"-"}</option>`).join("");
      return `
        <div class="card" data-color-row="${idx}" style="padding:12px;margin-bottom:10px">
          <div class="grid2" style="align-items:end">
            <div>
              <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</label>
              <select class="fm-ext" data-idx="${idx}">${extOpts}</select>
            </div>
            <div>
              <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</label>
              <select class="fm-int" data-idx="${idx}">${intOpts}</select>
            </div>
          </div>
          <div style="display:flex;justify-content:flex-end;margin-top:10px">
            <button type="button" class="btn danger xs" data-remove-color="${idx}">Ø­Ø°Ù Ø§Ù„Ù„ÙˆÙ†</button>
          </div>
        </div>`;
    }

    function renderFinishColors(){
      if(!fmColorsWrap) return;
      if(!FINISH_COLORS.length){
        fmColorsWrap.innerHTML = `<div class="hint" style="color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù„ÙˆØ§Ù† Ù…Ø¶Ø§ÙØ© â€” Ø§Ø¶ØºØ· "+ Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ† Ù…Ø³ØªØ®Ø¯Ù…"</div>`;
        return;
      }
      fmColorsWrap.innerHTML = FINISH_COLORS.map((r,idx)=> colorRowTemplate(idx, r.extColor||"", r.intColor||"")).join("");
    }

    function openFinishModalForTask(task){
      if(!task?.id) return;
      const key = String(task.specKey||"").trim();
      fmSpecKey.value = key;
      fmMontageDetails.value = "";
      FINISH_COLORS_META = getColorsForSpecKey(key);
      FINISH_COLORS = [];
      renderFinishColors();
      finishModal.classList.add("show");
    }
    function closeFinishModal(){ finishModal.classList.remove("show"); }

    $("finishClose").addEventListener("click", closeFinishModal);
    $("finishCancel").addEventListener("click", closeFinishModal);
    finishModal.addEventListener("click", (e)=>{ if(e.target===finishModal) closeFinishModal(); });

    // Ø²Ø± ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¯Ø§Ø®Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø³Ùƒ
    $("detailDone").addEventListener("click", ()=>{
      if(!CURRENT_TASK) return;
      openFinishModalForTask(CURRENT_TASK);
    });

    fmAddColor.addEventListener("click", ()=>{
      FINISH_COLORS.push({ extColor:"", intColor:"" });
      renderFinishColors();
    });

    // Delegation Ø¯Ø§Ø®Ù„ fmColorsWrap
    fmColorsWrap.addEventListener("change", (e)=>{
      const sel = e.target;
      if(!(sel instanceof HTMLSelectElement)) return;
      const idx = Number(sel.getAttribute("data-idx"));
      if(Number.isNaN(idx) || !FINISH_COLORS[idx]) return;
      if(sel.classList.contains("fm-ext")) FINISH_COLORS[idx].extColor = sel.value || "";
      if(sel.classList.contains("fm-int")) FINISH_COLORS[idx].intColor = sel.value || "";
    });
    fmColorsWrap.addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-remove-color]");
      if(!btn) return;
      const idx = Number(btn.getAttribute("data-remove-color"));
      if(Number.isNaN(idx)) return;
      FINISH_COLORS = FINISH_COLORS.filter((_,i)=> i!=idx);
      renderFinishColors();
    });

    async function saveStockTaskImmediate(specKey, patch){
      const key = String(specKey||"").trim();
      if(!key) return;
      const prev = STOCK_TASKS_MAP.get(key) || { specKey:key };
      const next = { ...prev, ...patch, specKey:key, updatedAt: serverTimestamp() };
      STOCK_TASKS_MAP.set(key, next);
      try{ applySpecKeyNotMontagedFilter(); }catch(_e){}
      try{
        await setDoc(doc(db, "stock_tasks", stockTaskDocId(key)), next, { merge:true });
        await setDoc(doc(db, "stock_tasks_backup", stockTaskDocId(key)), next, { merge:true });
      }catch(e){
        console.warn("saveStockTaskImmediate", e);
      }
    }

    $("finishSave").addEventListener("click", async ()=>{
      if(!CURRENT_TASK?.id) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Task");
      const key = String(fmSpecKey.value||"").trim();
      if(!key) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Unique Spec Key");
      const mdChoice = String(fmMontageDetails.value||"").trim();
      if(!mdChoice) return toast("Ø§Ø®ØªØ± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ†ØªØ§Ø¬ (Ù†Ø¹Ù…/Ù„Ø§)");

      const usedColors = FINISH_COLORS
        .map(r=>({ extColor:String(r.extColor||"").trim(), intColor:String(r.intColor||"").trim() }))
        .filter(r=> r.extColor || r.intColor);

      // 1) Update task as done + store used colors
      try{
        // Move task to a new green column derived from its current column
        const prevCol = String(CURRENT_TASK.column || "Ù‚Ø§Ø¦Ù…Ø©");
        const doneCol = /ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡/.test(prevCol) ? prevCol : `${prevCol} â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡`;
        // Ensure the column exists on the workspace board
        try{
          const cols = Array.isArray(CURRENT_WORKSPACE?.columns) ? CURRENT_WORKSPACE.columns.slice() : ["Ù‚Ø§Ø¦Ù…Ø©"];
          if(!cols.includes(doneCol)){
            cols.push(doneCol);
            await updateDoc(doc(db,"workspaces", CURRENT_WORKSPACE.id), { columns: cols, updatedAt: serverTimestamp() });
            CURRENT_WORKSPACE.columns = cols;
          }
        }catch(_e){}

        await updateDoc(doc(db, "workspace_tasks", CURRENT_TASK.id), {
          status: "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡",
          column: doneCol,
          doneAt: serverTimestamp(),
          montageDetailsYN: mdChoice,
          usedColors,
          updatedAt: serverTimestamp()
        });
      }catch(e){
        console.error(e);
        return toast("âš ï¸ ÙØ´Ù„ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ§Ø³Ùƒ (ØµÙ„Ø§Ø­ÙŠØ§Øª/Ù‚ÙˆØ§Ø¹Ø¯)");
      }

      // 2) Update Tab stock automatically: montage=yes + montageDetails
      try{ CURRENT_TASK.column = (typeof doneCol!=="undefined" ? doneCol : CURRENT_TASK.column); }catch(_e){}

      const stockMontageDetails = mdChoice === "Ù†Ø¹Ù…" ? "ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª: Ù†Ø¹Ù…" : "ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª: Ù„Ø§";
      await saveStockTaskImmediate(key, { montage: "Ù†Ø¹Ù…", montageDetails: stockMontageDetails });

      // 3) Update UI row if visible
      const row = document.querySelector(`#stockTable tr[data-spec="${CSS.escape(key)}"]`);
      if(row){
        const mSel = row.querySelector('[data-field="montage"]');
        const mdSel = row.querySelector('[data-field="montageDetails"]');
        if(mSel){ mSel.value = "Ù†Ø¹Ù…"; }
        if(mdSel){ mdSel.disabled = false; mdSel.value = stockMontageDetails; }
      }

      toast("âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ§Ø³Ùƒ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³ØªÙˆÙƒ");
      closeFinishModal();
      closeDetail();
    });
  </script>
</body>
</html>
