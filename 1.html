






<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <link rel="icon" type="image/x-icon" href="assets/favicon.png">
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MZJ-WORKSPACE</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    /* Tajawal for the whole file */
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
    html, body, button, input, select, textarea {
      font-family: 'Tajawal', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* Make Unique Spec Key inputs wider + more readable (all modals) */
    .modal input[list],
    .modal input[type="text"],
    .modal select {
      font-size: 15px;
    }
    /* Specifically: Unique Spec Key fields */
    #taskSpecKey, #dSpecKey {
      font-size: 16px;
      padding: 12px 12px;
      height: 46px;
    }
    /* Let the Unique Spec Key field take full row in the modal */
    #taskModal .grid2 .speckey-full { grid-column: 1 / -1; }
    /* VIN hint under the dropdown */
    .vin-hint {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }


    /* Finish modal color rows */
    .color-row{
      display:flex;gap:10px;align-items:center;
      background:#fff;
      border:1px solid #e6ded6;
      border-radius:12px;
      padding:10px;
      margin-top:10px;
    }
    .color-row .grow{flex:1;min-width:0;}
    .color-row label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}
    .color-row select{width:100%;height:42px;border-radius:12px}
    .color-row .btn{white-space:nowrap}
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --text:#1f2937;
      --muted:#6b7280;
      --card:#ffffff;
      --line:#e5e7eb;
      --radius:16px;
      --shadow: 0 12px 30px rgba(62,36,32,.12);
      --shadow2: 0 18px 50px rgba(62,36,32,.18);
      --danger:#b91c1c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--cream);
      color:var(--text);
      font-family:"Tajawal",system-ui,Arial;
    }
    a{color:inherit;text-decoration:none}
    button,input,select,textarea{font-family:inherit}

    /* ===== Layout ===== */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 300px 1fr;
      transition: grid-template-columns .18s ease;
    }
    .app.collapsed{ grid-template-columns: 88px 1fr; }

    /* ===== Sidebar ===== */
    .sidebar{
      background: linear-gradient(180deg, var(--brown), #2f1c19);
      color:#fff;
      padding:14px;
      position:sticky;
      top:0;
      height:100vh;
      overflow:auto;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .sb-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:6px 4px 14px;
      border-bottom:1px solid rgba(255,255,255,.12);
      margin-bottom:12px;
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand-badge{
      inline-size:34px;
      block-size:34px;
      border-radius:12px;
      background:linear-gradient(135deg,var(--beige),#d9b39a);
      flex:0 0 auto;
      box-shadow: 0 12px 24px rgba(188,143,116,.25);
    }
    .brand-title{display:flex;flex-direction:column;gap:2px;min-width:0}
    .brand-title strong{
      font-size:14px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .brand-title span{
      font-size:12px;opacity:.85;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .toggle-btn{
      border:0;
      background:rgba(255,255,255,.12);
      color:#fff;
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .toggle-btn:hover{background:rgba(255,255,255,.18)}
    .app.collapsed .brand-title{display:none}

    .sb-user{
      margin:10px 0 14px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      background:rgba(255,255,255,.06);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .avatar{
      width:36px;height:36px;border-radius:12px;
      background:rgba(255,255,255,.14);
      display:flex;align-items:center;justify-content:center;
      font-weight:800;
      flex:0 0 auto;
    }
    .sb-user .meta{min-width:0}
    .sb-user .meta .name{
      font-weight:800;font-size:13px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .sb-user .meta .role{
      font-size:12px;opacity:.85;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .app.collapsed .sb-user .meta{display:none}

    .sb-nav{display:grid;gap:8px;margin-top:10px}
    .sb-link{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      cursor:pointer;transition:.15s;user-select:none;
    }
    .sb-link:hover{background:rgba(255,255,255,.10)}
    .sb-link.active{
      background:rgba(255,255,255,.16);
      border-color:rgba(255,255,255,.16);
    }
    .sb-ico{
      width:34px;height:34px;border-radius:12px;
      background:rgba(255,255,255,.12);
      display:flex;align-items:center;justify-content:center;
      flex:0 0 auto;font-size:16px;
    }
    .sb-text{font-weight:800}
    .app.collapsed .sb-text{display:none}

    .sb-foot{
      margin-top:14px;padding-top:12px;
      border-top:1px solid rgba(255,255,255,.12);
      display:grid;gap:8px;
    }
    .hint{font-size:12px;line-height:1.6}

    /* ===== Main ===== */
    .main{padding:18px;min-width:0}
    .page-head{
      display:flex;align-items:flex-start;justify-content:space-between;
      gap:14px;margin-bottom:14px;
    }
    .title-wrap h1{margin:0;font-size:20px;color:var(--brown);letter-spacing:.2px}
    .title-wrap p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.6}

    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      padding:10px 12px;border-radius:14px;border:0;
      background:var(--brown);color:#fff;cursor:pointer;font-weight:800;
      box-shadow: 0 10px 24px rgba(62,36,32,.18);transition:.15s;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{background:#fff;color:var(--brown);border:1px solid var(--brown);box-shadow:none}
    .btn.danger{background:var(--danger);box-shadow: 0 10px 24px rgba(185,28,28,.18)}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--brown);box-shadow:none}
    .btn.sm{padding:8px 10px;border-radius:12px;font-size:13px}
    .btn.xs{padding:6px 9px;border-radius:999px;font-size:12px}

    .panel{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(62,36,32,.06);
      overflow:hidden;
    }
    .panel .head{
      padding:12px 14px;border-bottom:1px solid #f1f1f1;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      background: linear-gradient(180deg, #fff, #fff8ef);
    }
    .panel .body{padding:14px}
    .muted{color:var(--muted)}

    /* ===== Home cards ===== */
    .home-grid{display:grid;grid-template-columns:repeat(2, minmax(0, 1fr));gap:14px}
    @media(max-width:980px){.home-grid{grid-template-columns:1fr}}
    .hero-card{
      border-radius:18px;border:1px solid rgba(62,36,32,.10);
      background: linear-gradient(140deg, #fff, #fff8ef 60%, rgba(188,143,116,.10));
      box-shadow: var(--shadow);
      padding:16px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      position:relative;overflow:hidden;min-height:150px;cursor:pointer;
    }
    .hero-card::before{
      content:"";position:absolute;inset:auto -40px -40px auto;
      width:160px;height:160px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(188,143,116,.35), transparent 60%);
      transform: rotate(12deg);
    }
    .hero-left{position:relative;z-index:1;min-width:0}
    .hero-title{margin:0;font-size:18px;color:var(--brown);font-weight:900}
    .hero-desc{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.7;max-width:560px}
    .hero-actions{position:relative;z-index:1;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;background:#fff;
      border:1px solid rgba(62,36,32,.10);color:var(--brown);
      font-weight:800;font-size:12px;box-shadow: 0 8px 18px rgba(62,36,32,.10);
    }
    .pill .dot{width:8px;height:8px;border-radius:999px;background:var(--beige)}

    /* ===== Lists ===== */
    .list{display:grid;gap:10px}
    .list-item{
      border:1px solid rgba(62,36,32,.10);border-radius:16px;padding:12px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      background:#fff;transition:.15s;cursor:pointer;
    }
    .list-item:hover{transform:translateY(-1px);box-shadow: 0 14px 36px rgba(62,36,32,.12)}
    .li-main{min-width:0}
    .li-title{
      margin:0;font-size:14px;font-weight:900;color:var(--brown);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .li-sub{
      margin:6px 0 0;font-size:12px;color:var(--muted);line-height:1.6;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
    }
    .li-right{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;flex:0 0 auto}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;background:#fff8ef;
      border:1px solid rgba(188,143,116,.30);color:var(--brown);
      font-size:12px;font-weight:800;
    }
    .tag .mini{width:6px;height:6px;border-radius:999px;background:var(--beige)}

    /* ===== Board ===== */
    .board{display:grid;gap:14px;grid-template-columns:repeat(4, minmax(0, 1fr));margin-top:12px}
    @media(max-width:1400px){.board{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:980px){.board{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.board{grid-template-columns:1fr}}

    .col{
      background:#fff;border:1px solid rgba(62,36,32,.08);
      border-radius:16px;box-shadow: 0 10px 28px rgba(62,36,32,.08);
      overflow:hidden;display:flex;flex-direction:column;min-height:220px;
    }
    .col-head{
      background: linear-gradient(180deg, #fff8ef, #fff);
      border-bottom:1px solid rgba(62,36,32,.06);
      padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px;
    }


    /* ===== Done Column (green) ===== */
    .col.done-col{border-color: rgba(22,163,74,.35); box-shadow: 0 14px 34px rgba(22,163,74,.10)}
    .col.done-col .col-head{background: linear-gradient(180deg, #f0fdf4, #ffffff); border-bottom-color: rgba(22,163,74,.20)}
    .col.done-col .col-title{color:#166534}
    .col.done-col .count-badge{border-color: rgba(22,163,74,.28); color:#166534}
    .col-title{
      font-weight:900;color:var(--brown);font-size:13px;
      display:flex;align-items:center;gap:8px;min-width:0;
    }
    .col-title span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .count-badge{
      display:inline-flex;align-items:center;justify-content:center;
      min-width:24px;height:24px;padding:0 8px;border-radius:999px;
      background:#fff;border:1px solid rgba(62,36,32,.12);
      font-size:12px;font-weight:900;color:var(--brown);
    }
    .col-body{padding:10px;display:grid;gap:10px}

    .task-card{
      border:1px solid rgba(62,36,32,.10);border-radius:14px;padding:10px;
      background:#fff;box-shadow: 0 10px 22px rgba(62,36,32,.08);
      cursor:pointer;transition:.15s;
    }
    .task-card:hover{transform:translateY(-1px)}
    .t-title{margin:0;font-size:13px;font-weight:900;color:var(--brown);line-height:1.5}
    .t-meta{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:12px}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;background:#fff8ef;
      border:1px solid rgba(188,143,116,.25);color:var(--brown);
      font-weight:800;font-size:12px;
    }
    .badge .dot{width:8px;height:8px;border-radius:999px;background:var(--beige)}


    /* Done column (ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡) */
    .col.done-col{border-color: rgba(22,163,74,.35); box-shadow: 0 12px 34px rgba(22,163,74,.10);}
    .col.done-col .col-head{background: linear-gradient(180deg, rgba(220,252,231,.9), #fff); border-bottom-color: rgba(22,163,74,.18);}
    .col.done-col .col-title{color:#0f5a2a}
    .col.done-col .count-badge{border-color: rgba(22,163,74,.35); color:#0f5a2a}
    /* ===== Modal ===== */
    .modal{
      position:fixed;inset:0;background:rgba(0,0,0,.40);
      display:none;place-items:center;padding:16px;z-index:999;
    }
    .modal.show{display:grid}
    .sheet{
      width:min(900px, 100%);background:#fff;border-radius:18px;box-shadow: var(--shadow2);
      overflow:hidden;display:flex;flex-direction:column;max-height:92vh;
    }
    .sheet .m-head{
      padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid #f1f1f1;background: linear-gradient(180deg, #fff, #fff8ef);
    }
    .sheet .m-head strong{color:var(--brown);font-size:14px;font-weight:900}
    .sheet .m-body{padding:14px;overflow:auto;display:grid;gap:10px}
    .sheet .m-foot{
      padding:12px 14px;border-top:1px solid #f1f1f1;background: #fff8ef;
      display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;
    }

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:860px){.grid2{grid-template-columns:1fr}}
    label{display:block;margin:4px 0 6px;font-size:12px;font-weight:900;color:var(--brown)}
    input,select,textarea{
      width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      outline:none;background:#fff;font-size:14px;
    }
    textarea{min-height:110px;resize:vertical;line-height:1.8}
    input:focus,select:focus,textarea:focus{
      border-color: rgba(188,143,116,.65);
      box-shadow: 0 0 0 4px rgba(188,143,116,.18);
    }

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;border:1px solid rgba(62,36,32,.10);
      background:#fff;font-size:12px;color:var(--brown);font-weight:800;
    }
    .chip button{
      border:0;background:#fff8ef;color:var(--brown);
      border-radius:10px;cursor:pointer;padding:4px 8px;font-weight:900;
    }

    .divider{height:1px;background: #f1f1f1;margin:4px 0}
    .empty{
      padding:14px;border:1px dashed rgba(62,36,32,.18);
      border-radius:16px;background:#fff;color:var(--muted);
      line-height:1.8;font-size:13px;
    }

    .toast{
      position:fixed;left:16px;bottom:16px;background:#111827;color:#fff;
      padding:10px 12px;border-radius:14px;box-shadow: 0 14px 40px rgba(0,0,0,.25);
      display:none;z-index:2000;font-size:13px;
    }
    .toast.show{display:block}

    .kpi-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi{
      flex:1 1 220px;background:#fff;border-radius:16px;border:1px solid rgba(62,36,32,.08);
      box-shadow: 0 10px 28px rgba(62,36,32,.08);padding:12px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .kpi strong{display:block;color:var(--brown);font-weight:900;font-size:13px}
    .kpi span{color:var(--muted);font-size:12px}
    .kpi .num{font-weight:900;font-size:18px;color:var(--brown)}



    /* ===== Stock Table ===== */
    /* Tajawal for stock tab */
    #viewStock, #viewStock *{font-family:"Tajawal",system-ui,Arial !important;}

    .table-wrap{
      overflow:auto;
      border:1px solid #e6ded6;
      border-radius:14px;
      background:#fff;
      box-shadow: 0 10px 28px rgba(62,36,32,.08);
    }

    .stock-table{
      width:100%;
      border-collapse:collapse;
      min-width:1550px;
      background:#fff;
      table-layout:fixed;
      font-size:13px;
    }

    .stock-table thead th{
      position:sticky;
      top:0;
      z-index:2;
      background:#f9f4ef;
      color:var(--brown);
      font-weight:800;
      padding:12px 10px;
      border-bottom:1px solid #e6ded6;
      text-align:right;
      white-space:nowrap;
    }

    .stock-table tbody td{
      padding:11px 10px;
      border-bottom:1px solid #f0ebe6;
      color:var(--text);
      vertical-align:middle;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      background:#fff;
    }

    .stock-table tbody tr:nth-child(even) td{background:#fffaf5;}
    .stock-table tbody tr:hover td{background:#f3ece6;}

    .stock-table td.wrap{white-space:normal;line-height:1.7;}
    .stock-table td.center{text-align:center;font-weight:700;}
    .stock-table td.mono{direction:ltr;text-align:left;white-space:nowrap;font-family:inherit;}

    /* Stock table controls */
    .stock-ctrl{width:100%;padding:8px 10px;border:1px solid #e6ded6;border-radius:10px;background:#fff;font-size:13px;outline:none}
    .stock-ctrl:focus{border-color: var(--beige); box-shadow: 0 0 0 3px rgba(188,143,116,.18)}
    .stock-ctrl.small{padding:7px 10px;font-size:12px}
    .stock-ctrl[disabled]{background:#f7f3ef;color:#9aa3af}
    .stock-badge-mini{display:inline-block;padding:4px 10px;border-radius:999px;background:#f1e7dd;color:#3e2420;font-size:12px;white-space:nowrap}
    .stock-count{font-weight:800}

    .stock-meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    /* ===== Auth Gate (Inline Login) ===== */
    .auth-gate{
      position:fixed; inset:0; z-index:3000;
      background:linear-gradient(180deg, rgba(62,36,32,.92), rgba(47,28,25,.92));
      display:none; place-items:center; padding:16px;
    }
    .auth-gate.show{display:grid}
    .auth-card{
      width:min(520px, 100%);
      background:#fff;
      border-radius:20px;
      box-shadow: 0 22px 70px rgba(0,0,0,.35);
      border:1px solid rgba(62,36,32,.10);
      overflow:hidden;
    }
    .auth-head{
      padding:14px 16px;
      background:linear-gradient(180deg, #fff, #fff8ef);
      border-bottom:1px solid #f1f1f1;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .auth-head strong{color:var(--brown);font-weight:900}
    .auth-body{padding:16px; display:grid; gap:10px}
    .auth-foot{padding:12px 16px; background:#fff8ef; border-top:1px solid #f1f1f1; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap}
    .auth-note{color:var(--muted); font-size:12px; line-height:1.7}
    .auth-err{color:var(--danger); font-weight:900; font-size:13px; display:none}
    .auth-err.show{display:block}
    .auth-brand{
      display:flex; align-items:center; gap:10px;
    }
    .auth-badge{
      inline-size:38px; block-size:38px;
      border-radius:14px;
      background:linear-gradient(135deg,var(--beige),#d9b39a);
      box-shadow: 0 12px 24px rgba(188,143,116,.25);
    }
    .hide-app{display:none !important}

    /* ===== Dashboard + Daily ===== */
    .dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width: 980px){.dash-grid{grid-template-columns:1fr}}

    .dash-workspace{border:1px solid #eee;border-radius:14px;padding:12px;background:#fff}
    .dash-workspace .top{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .dash-workspace .name{font-weight:900}
    .dash-workspace .meta{font-size:12px;color:var(--muted)}
    .dash-tasks{display:grid;gap:8px;margin-top:10px}
    .dash-task{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border:1px solid #eee;border-radius:12px;background:var(--cream)}
    .dash-task .t-title{font-weight:800}
    .dash-task .t-sub{font-size:12px;color:var(--muted);margin-top:2px}
    .badge{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:800;border:1px solid #eee;background:#fff}
    .badge.done{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.08)}
    .badge.todo{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.10)}

    .pick-list{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:10px}
    @media (max-width: 700px){.pick-list{grid-template-columns:1fr}}
    .pick-item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border:1px solid #eee;border-radius:14px;background:#fff}
    .pick-item .ttl{font-weight:900}
    .pick-item .sub{font-size:12px;color:var(--muted)}

    .weeks-grid{display:grid;grid-template-columns:repeat(4, minmax(240px, 1fr));gap:12px;overflow:auto;padding-bottom:6px}
    @media (max-width: 1200px){.weeks-grid{grid-template-columns:repeat(2, minmax(240px,1fr))}}
    @media (max-width: 720px){.weeks-grid{grid-template-columns:1fr}}
    .week-col{background:#fff;border:1px solid #eee;border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.04);padding:12px}
    .week-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .week-head strong{font-size:14px}
    .days{display:grid;gap:10px}
    .day{border:1px dashed #e6ded6;border-radius:14px;padding:10px;background:var(--cream)}
    .day-top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .day-title{font-weight:900}
    .day-list{display:grid;gap:8px}

    .rte{border:1px solid #eee;border-radius:14px;overflow:hidden;background:#fff}
    .rte-bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding:10px;border-bottom:1px solid #eee;background:var(--cream)}
    .rte-box{min-height:140px;padding:12px;outline:none;line-height:1.9}

  </style>
</head>

<body>
  <!-- Inline Login Gate (Ø¨Ø¯ÙŠÙ„ login.html) -->
  <div class="auth-gate" id="authGate">
    <div class="auth-card">
      <div class="auth-head">
        <div class="auth-brand">
          <div class="auth-badge"></div>
          <div>
            <strong>MZJ Workspace</strong>
            <div class="auth-note">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div>
          </div>
        </div>
        <span class="pill" style="margin:0"><span class="dot"></span> Secure</span>
      </div>
      <div class="auth-body">
        <div class="auth-err" id="authErr">â€¦</div>
        <div>
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="loginEmail" type="email" autocomplete="username" placeholder="name@email.com" />
        </div>
        <div>
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <div class="auth-note">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†ÙØ³ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„/Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Firebase Auth Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ <b>mzj-workspace-c7d4e</b>.</div>
      </div>
      <div class="auth-foot">
        <button class="btn secondary" id="btnLoginDemo" type="button" style="display:none">Ø¯Ø®ÙˆÙ„ ØªØ¬Ø±ÙŠØ¨ÙŠ</button>
        <button class="btn" id="btnLogin" type="button">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      </div>
    </div>
  </div>

  <div class="app" id="app">
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand">
          <div class="brand-badge"></div>
          <div class="brand-title">
            <strong>MZJ Workspace</strong>
            <span>Tasks & Campaigns</span>
          </div>
        </div>
        <button class="toggle-btn" id="sbToggle" title="ÙØªØ­ / Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">â˜°</button>
      </div>

      <div class="sb-user">
        <div class="avatar" id="avatar">M</div>
        <div class="meta">
          <div class="name" id="whoName">...</div>
          <div class="role" id="whoRole">...</div>
        </div>
      </div>

      <div class="sb-nav">
        <div class="sb-link active" id="navHome">
          <div class="sb-ico">ğŸ </div>
          <div class="sb-text">Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</div>
        </div>

        <div class="sb-link" id="navAgendas">
          <div class="sb-ico">ğŸ—‚ï¸</div>
          <div class="sb-text">Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª</div>
        </div>

        <div class="sb-link" id="navCampaigns">
          <div class="sb-ico">ğŸ“£</div>
          <div class="sb-text">Ø§Ù„Ø­Ù…Ù„Ø§Øª</div>
        </div>


        <div class="sb-link" id="navDaily" style="display:none">
          <div class="sb-ico">ğŸ—“ï¸</div>
          <div class="sb-text">Daily Task</div>
        </div>


        <div class="sb-link" id="navStock">
          <div class="sb-ico">ğŸš—</div>
          <div class="sb-text">stock</div>
        </div>

        <div class="sb-link" id="navAdmin" style="display:none">
          <div class="sb-ico">ğŸ›¡ï¸</div>
          <div class="sb-text">admin</div>
        </div>

      </div>

      <div class="sb-foot">
        <a class="sb-link" href="javascript:void(0)" id="btnLogout">
          <div class="sb-ico">ğŸšª</div>
          <div class="sb-text">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
        </a>
        <div class="hint" style="color:rgba(255,255,255,.75);padding:6px 6px 0">
          Â© Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª â€” Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="page-head">
        <div class="title-wrap">
          <h1 id="pageTitle">Workspace â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª ÙˆØ§Ù„Ø­Ù…Ù„Ø§Øª</h1>
          <p id="pageDesc">Ø£Ù†Ø´Ø¦ Ø£Ø¬Ù†Ø¯Ø§Øª Ù„ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©/Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©ØŒ ÙˆØ£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø§Øª Ø¨ØªÙˆØ§Ø±ÙŠØ® ÙˆÙˆØµÙ ÙˆØ£Ø¹Ù…Ø¯Ø©â€¦ Ø«Ù… Ø£Ø¶Ù ØªØ§Ø³ÙƒØ§Øª Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ø¹Ù…ÙˆØ¯ Ø¨Ø³Ù‡ÙˆÙ„Ø©.</p>
        </div>

        <div class="actions" id="topActions">
          <button class="btn secondary sm" id="btnBack" style="display:none">â¬… Ø±Ø¬ÙˆØ¹</button>
          <button class="btn sm" id="btnCreateAgenda">â• Ø£Ø¬Ù†Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
          <button class="btn secondary sm" id="btnCreateCampaign">â• Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>
      </div>

      <section class="panel" id="viewHome">
        <div class="head" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div>
            <strong>Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</strong>
            <div class="muted" id="homeMeta" style="font-size:12px;margin-top:6px">...</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <span class="pill" id="dashMonthPill"><span class="dot"></span> Ø´Ù‡Ø± ...</span>
            <button class="btn secondary sm" id="btnDashPdf" type="button">â¬‡ï¸ ØªØµØ¯ÙŠØ± PDF</button>
          </div>
        </div>
        <div class="body">

          <div class="dash-grid">
            <div class="dash-card">
              <div class="dash-card-head">
                <strong>Ø£Ø¬Ù†Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±</strong>
                <span class="muted" id="dashAgendaMeta">0</span>
              </div>
              <div class="dash-card-body" id="dashAgendasWrap">
                <div class="empty" id="dashAgendasEmpty" style="display:none">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¬Ù†Ø¯Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</div>
              </div>
            </div>

            <div class="dash-card">
              <div class="dash-card-head">
                <strong>Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø´Ù‡Ø±</strong>
                <span class="muted" id="dashCampaignMeta">0</span>
              </div>
              <div class="dash-card-body" id="dashCampaignsWrap">
                <div class="empty" id="dashCampaignsEmpty" style="display:none">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù…Ù„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="dash-filter">
            <div class="dash-filter-head">
              <strong>Ø¹Ø±Ø¶ Ù…Ø®ØµØµ</strong>
              <span class="muted">Ø§Ø®ØªØ§Ø± Ø£Ø¬Ù†Ø¯Ø§Øª/Ø­Ù…Ù„Ø§Øª Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„Ø¹Ø±Ø¶</span>
            </div>
            <div class="dash-filter-body">
              <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap">
                <div style="min-width:220px">
                  <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">Ø§Ø®ØªØ±</label>
                  <select id="dashPickType" class="inp">
                    <option value="">â€” Ø§Ø®ØªØ± â€”</option>
                    <option value="agenda">Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª</option>
                    <option value="campaign">Ø§Ù„Ø­Ù…Ù„Ø§Øª</option>
                  </select>
                </div>
                <div style="flex:1;min-width:260px" id="dashPickListWrap" style="display:none">
                  <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">Ø­Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¹Ø±Ø¶Ù‡Ø§</label>
                  <div class="pick-list" id="dashPickList"></div>
                </div>
                <div>
                  <button class="btn sm" id="dashPickApply" type="button" disabled>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
                </div>
              </div>

              <div style="margin-top:12px" id="dashCustomResults" style="display:none">
                <div class="divider"></div>
                <div class="dash-grid" style="grid-template-columns:1fr;gap:12px">
                  <div class="dash-card">
                    <div class="dash-card-head">
                      <strong id="dashCustomTitle">...</strong>
                      <span class="muted" id="dashCustomMeta">...</span>
                    </div>
                    <div class="dash-card-body" id="dashCustomWrap"></div>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>
      </section>

      <section class="panel" id="viewList" style="display:none">
        <div class="head">
          <strong id="listTitle">...</strong>
          <div class="actions">
            <button class="btn secondary sm" id="btnRefresh" type="button">âŸ³ ØªØ­Ø¯ÙŠØ«</button>
          </div>
        </div>
        <div class="body">
          <div class="empty" id="listEmpty" style="display:none">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.</div>
          <div class="list" id="listContainer"></div>
        </div>
      </section>

      <section class="panel" id="viewBoard" style="display:none">
        <div class="head">
          <div>
            <strong id="boardTitle">...</strong>
            <div class="muted" id="boardSub" style="font-size:12px;margin-top:6px"></div>
            <div id="boardFilterWrap" style="display:none;margin-top:10px">
              <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:6px">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
              <select id="boardUserFilter" class="inp" style="min-width:260px">
                <option value="">Ø§Ù„ÙƒÙ„</option>
              </select>
            </div>
          </div>
          <div class="actions">
            <button class="btn ghost sm" id="btnEditBoard" type="button">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn danger sm" id="btnDeleteBoard" type="button">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
        <div class="body">
          <div class="board" id="boardCols"></div>
        </div>
      </section>

      <section class="panel" id="viewDaily" style="display:none">
        <div class="head" style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div>
            <strong>Daily Task</strong>
            <div class="muted" style="font-size:12px;margin-top:6px">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù‡Ø§Ù… ÙŠÙˆÙ…ÙŠØ© (4 Ø£Ø³Ø§Ø¨ÙŠØ¹) ÙˆØ­ÙØ¸Ù‡Ø§ Ø¯Ø§Ø®Ù„ <b>daily_tasks</b> ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ <b>mzj-workspace-c7d4e</b>.</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <input id="dailyYear" class="inp" type="number" style="width:120px" placeholder="Ø§Ù„Ø³Ù†Ø©" />
            <select id="dailyMonth" class="inp" style="min-width:180px"></select>
            <button class="btn secondary sm" id="dailyTextOpen" type="button">ğŸ“ Ù…Ø­Ø±Ø± Ù†ØµÙˆØµ</button>
            <button class="btn secondary sm" id="dailyReload" type="button">âŸ³ ØªØ­Ù…ÙŠÙ„</button>
          </div>
        </div>
        <div class="body">
          <div class="weeks-grid" id="dailyWeeks"></div>
        </div>
      </section>

<section class="panel" id="viewStock" style="display:none">
        <div class="head">
          <div class="stock-meta">
            <strong>stock</strong>
            <span class="muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b id="stockCount">0</b> Ø³ÙŠØ§Ø±Ø©</span>
            <input id="stockSearch" class="inp" style="min-width:260px" placeholder="Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ stock (Unique Spec Key)â€¦" />
            <button class="btn secondary sm" id="btnStockExport" type="button">â¬‡ï¸ ØªØµØ¯ÙŠØ± Excel</button>
          </div>
        </div>
        <div class="body">
          <div class="empty" id="stockEmpty" style="display:none">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
          <div class="table-wrap" id="stockTableWrap" style="display:none">
            <table class="stock-table" id="stockTable"></table>
          </div>
        </div>
      </section>

      <section class="panel" id="viewAdmin" style="display:none">
        <div class="head">
          <div>
            <strong>Admin</strong>
            <span class="muted">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ù…Ø´Ø±ÙˆØ¹ Firebase (mzj-workspace-c7d4e)</span>
          </div>
        </div>
        <div class="body">
          <div class="card" style="max-width:720px">
            <div class="card-head">
              <strong>Ø¥Ø¶Ø§ÙØ© ÙŠÙˆØ²Ø± Ø¬Ø¯ÙŠØ¯</strong>
              <span class="muted">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Authentication (Email/Password) + Ø¥Ù†Ø´Ø§Ø¡ Document ÙÙŠ users/{uid} Ø¨Ù†ÙØ³ Ø§Ù„Ù…Ø³Ø§Ø±.</span>
            </div>
            <div class="card-body">
              <div class="grid2">
                <div>
                  <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                  <input id="adminNewEmail" placeholder="name@example.com" autocomplete="off"/>
                </div>
                <div>
                  <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                  <input id="adminNewPass" type="password" placeholder="********" autocomplete="new-password"/>
                </div>
              </div>
              <div class="grid2" style="margin-top:10px">
                <div>
                  <label>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
                  <select id="adminNewRole">
                    <option value="member">member (Ø¹Ø¶Ùˆ)</option>
                    <option value="finisher">finisher (ÙŠÙ†Ù‡ÙŠ ÙÙ‚Ø·)</option>
                    <option value="admin">admin (Ù…Ø¯ÙŠØ±)</option>
                  </select>
                </div>
                <div>
                  <label>Ø§Ø³Ù… Ø§Ù„ÙŠÙˆØ²Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                  <input id="adminNewName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯"/>
                </div>
              </div>

              <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px">
                <button class="btn secondary" id="adminClear" type="button">Ù…Ø³Ø­</button>
                <button class="btn" id="adminCreateUser" type="button">â• Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
              </div>

              <div class="hint" id="adminMsg" style="margin-top:10px;color:var(--muted)"></div>
            </div>
          </div>

          <div class="card" style="margin-top:14px">
            <div class="card-head" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
              <div>
                <strong>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</strong>
                <span class="muted">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØªØ¹Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ© Ø£ÙŠ ÙŠÙˆØ²Ø± (role) + Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.</span>
              </div>
              <div style="display:flex;gap:10px;align-items:center">
                <input id="adminUserSearch" class="inp" style="min-width:240px" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„..." />
                <button class="btn secondary sm" id="adminUsersRefresh" type="button">ØªØ­Ø¯ÙŠØ«</button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-wrap">
                <table class="stock-table" id="adminUsersTable"></table>
              </div>
              <div class="hint" id="adminUsersMsg" style="margin-top:10px;color:var(--muted)"></div>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Create/Edit Board Modal -->
  <div class="modal" id="boardModal">
    <div class="sheet">
      <div class="m-head">
        <strong id="boardModalTitle">...</strong>
        <button class="btn secondary xs" id="boardModalClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="m-body">
        <div class="grid2">
          <div>
            <label>Ø§Ù„Ù†ÙˆØ¹</label>
            <input id="boardType" readonly />
            <div class="hint" style="color:var(--muted)">Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¯Ø§Ø®Ù„ Collection: <b>workspaces</b>.</div>
          </div>
          <div>
            <label>Ø§Ø³Ù… (Ø§Ù„Ø£Ø¬Ù†Ø¯Ø© / Ø§Ù„Ø­Ù…Ù„Ø©)</label>
            <input id="boardName" placeholder="Ù…Ø«Ø§Ù„: ÙŠÙ†Ø§ÙŠØ± 2026 / Ø­Ù…Ù„Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø· - ÙØ¨Ø±Ø§ÙŠØ±"/>
          </div>
        </div>

        <div id="campaignFields" style="display:none">
          <label>ÙˆØµÙ Ø§Ù„Ø­Ù…Ù„Ø©</label>
          <textarea id="campaignDesc" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ø­Ù…Ù„Ø© Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­..."></textarea>
          <div class="grid2">
            <div>
              <label>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ù…Ù„Ø©</label>
              <input id="campaignStart" type="date"/>
            </div>
            <div>
              <label>ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ù…Ù„Ø©</label>
              <input id="campaignEnd" type="date"/>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div>
          <label>Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ø§Ù„ÙƒØ±ÙˆØª)</label>
          <div class="hint" style="color:var(--muted)">Ø£Ø¶Ù Ø£ÙƒØ«Ø± Ù…Ù† Ø¹Ù…ÙˆØ¯. Ù…Ø«Ø§Ù„: (Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª) (ØªØµÙ…ÙŠÙ… ØµÙˆØ±) (Ù…ÙˆØ´Ù†) ...</div>

          <div class="grid2" style="align-items:end">
            <div><input id="colInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø¹Ù…ÙˆØ¯ Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ©"/></div>
            <div style="display:flex;gap:10px;justify-content:flex-end">
              <button class="btn secondary sm" id="btnAddCol" type="button">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯</button>
              <button class="btn ghost sm" id="btnAddDefaults" type="button">Ø¥Ø¶Ø§ÙØ© Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
            </div>
          </div>

          <div class="chips" id="colsChips" style="margin-top:10px"></div>
        </div>
      </div>
      <div class="m-foot">
        <button class="btn secondary" id="boardCancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" id="boardSave" type="button">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- Task Modal -->
  <div class="modal" id="taskModal">
    <div class="sheet">
      <div class="m-head">
        <strong id="taskModalTitle">ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯</strong>
        <button class="btn secondary xs" id="taskModalClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="m-body">
        <div class="grid2">
          <div class="speckey-full">
            <label>Unique Spec Key</label>
            <input id="taskSpecKey" list="specKeyList" placeholder="Ø§Ø¨Ø­Ø« ÙˆØ§Ø®ØªØ± (Ø§Ù„Ø³ÙŠØ§Ø±Ø© | Ø§Ù„Ø¨ÙŠØ§Ù† | Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„)â€¦"/>
            <datalist id="specKeyList"></datalist>
            <div class="hint" style="color:var(--muted)">* ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† ØµÙØ­Ø©/Ù‚Ø§Ø¹Ø¯Ø© Unique Spec Key (Ø§Ù„Ù…Ø®Ø²ÙˆÙ†) â€” Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ ØµÙØ­Ø© ÙÙŠ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±.</div>
          </div>
          <!-- ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨ -->
          <div style="display:none">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</label>
            <input id="taskDue" type="date"/>
          </div>
        </div>

        <label>Ø§Ù„ÙˆØµÙ</label>
        <textarea id="taskDesc" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ ÙˆØ§Ø¶Ø­ Ù„Ù„ØªØ§Ø³Ùƒ..."></textarea>

        <div class="grid2">
          <div>
            <label>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (User)</label>
            <select id="taskAssignee">
              <option value="">â€” Ø§Ø®ØªØ± ÙŠÙˆØ²Ø± â€”</option>
            </select>
          </div>
          <div>
            <label>Ø§Ù„Ø¹Ù…ÙˆØ¯</label>
            <input id="taskColumn" readonly/>
          </div>
        </div>

        <div id="taskLinksWrap" style="display:none">
          <div class="divider"></div>
          <label>Ø±ÙˆØ§Ø¨Ø· Ù…Ø±ØªØ¨Ø·Ø© (Ù„Ù„Ø­Ù…Ù„Ø§Øª)</label>
          <div class="grid2" style="align-items:end">
            <div><input id="linkTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· â€” Ù…Ø«Ø§Ù„: Ù…Ù„Ù Ø¬ÙˆØ¬Ù„ Ø¯Ø±Ø§ÙŠÙ"/></div>
            <div><input id="linkUrl" placeholder="https://..."/></div>
          </div>
          <div style="display:flex;justify-content:flex-end;margin-top:10px">
            <button class="btn secondary sm" id="btnAddLink" type="button">Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø·</button>
          </div>
          <div class="chips" id="linksChips" style="margin-top:10px"></div>
        </div>

        <div class="divider"></div>
        <div class="hint" style="color:var(--muted)">Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ Ø¯Ø§Ø®Ù„ Collection: <b>workspace_tasks</b>.</div>
      </div>

      <div class="m-foot">
        <button class="btn danger" id="taskDelete" style="display:none" type="button">Ø­Ø°Ù</button>
        <button class="btn secondary" id="taskCancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" id="taskSave" type="button">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- Task Detail Modal -->
  <div class="modal" id="detailModal">
    <div class="sheet">
      <div class="m-head">
        <strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø³Ùƒ</strong>
        <button class="btn secondary xs" id="detailClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="m-body">
        <div class="grid2">
          <div><label>Unique Spec Key</label><input id="dSpecKey" readonly/></div>
          <!-- ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨ -->
          <div style="display:none"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</label><input id="dDue" readonly/></div>
        </div>
        <div class="grid2">
          <div><label>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label><input id="dAssignee" readonly/></div>
          <div><label>Ø§Ù„Ø¹Ù…ÙˆØ¯</label><input id="dColumn" readonly/></div>
        </div>
        <label>Ø§Ù„ÙˆØµÙ</label>
        <textarea id="dDesc" readonly></textarea>

        <div id="dLinksBlock" style="display:none">
          <div class="divider"></div>
          <label>Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</label>
          <div class="chips" id="dLinks"></div>
        </div>
      </div>
      <div class="m-foot">
        <button class="btn secondary" id="detailEdit" type="button">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn danger" id="detailDelete" type="button">Ø­Ø°Ù</button>
        <button class="btn" id="detailDone" type="button">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</button>
        <button class="btn" id="detailOk" type="button">ØªÙ…Ø§Ù…</button>
      </div>
    </div>
  </div>

  

  <!-- Stock Colors Modal (click count) -->
  <div class="modal" id="colorsModal">
    <div class="sheet" style="max-width:900px">
      <div class="m-head">
        <strong>Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø­Ø³Ø¨ Unique Spec Key)</strong>
        <button class="btn secondary xs" id="colorsClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="m-body">
        <label>Unique Spec Key</label>
        <input id="cmSpecKey" readonly/>
        <div class="grid2" style="margin-top:12px">
          <div>
            <label>Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©</label>
            <div class="chips" id="cmExt"></div>
          </div>
          <div>
            <label>Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©</label>
            <div class="chips" id="cmInt"></div>
          </div>
        </div>
        <div class="hint" style="color:var(--muted);margin-top:10px">* Ù‡Ø°Ù‡ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙŠØªÙ… Ù‚Ø±Ø§Ø¡ØªÙ‡Ø§ Ù…Ù† mzj-agenda (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·).</div>
      </div>
      <div class="m-foot">
        <button class="btn" id="colorsOk" type="button">ØªÙ…Ø§Ù…</button>
      </div>
    </div>
  </div>

  <!-- Finish Task Modal -->
  <div class="modal" id="finishModal">
    <div class="sheet" style="max-width:980px">
      <div class="m-head">
        <strong>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ§Ø³Ùƒ</strong>
        <button class="btn secondary xs" id="finishClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="m-body">
        <label>Unique Spec Key</label>
        <input id="fmSpecKey" readonly/>

        <div class="grid2" style="margin-top:12px">
          <div>
            <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ†ØªØ§Ø¬</label>
            <select id="fmMontageDetails">
              <option value="">-</option>
              <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
              <option value="Ù„Ø§">Ù„Ø§</option>
            </select>
            <div class="hint" style="color:var(--muted);margin-top:6px">Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Tab stock ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§: Ù…ÙˆÙ†ØªØ§Ø¬ = Ù†Ø¹Ù… + ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ†ØªØ§Ø¬ Ø­Ø³Ø¨ Ø§Ø®ØªÙŠØ§Ø±Ùƒ.</div>
          </div>
          <div>
            <label>Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„ØªØ§Ø³Ùƒ</label>
            <button class="btn secondary sm" id="fmAddColor" type="button">+ Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ† Ù…Ø³ØªØ®Ø¯Ù…</button>
          </div>
        </div>

        <div id="fmColorsWrap" style="margin-top:10px"></div>
        <div class="hint" style="color:var(--muted);margin-top:10px">* Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† ØªÙØ¨Ù†Ù‰ Ø­Ø³Ø¨ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù†ÙØ³ Unique Spec Key (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· Ù…Ù† mzj-agenda).</div>
      </div>
      <div class="m-foot">
        <button class="btn secondary" id="finishCancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" id="finishSave" type="button">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</button>
      </div>
    </div>
  </div>

<div class="toast" id="toast">...</div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut, signInAnonymously,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs,
      addDoc, setDoc, updateDoc, deleteDoc,
      query, where, orderBy, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDXXDsJKnKb_0HynSTnP22QYc0yrUdx-cw",
      authDomain: "mzj-workspace-c7d4e.firebaseapp.com",
      projectId: "mzj-workspace-c7d4e",
      storageBucket: "mzj-workspace-c7d4e.firebasestorage.app",
      messagingSenderId: "1080687990992",
      appId: "1:1080687990992:web:4a496249bbf330fc37a6d5"
    };

  // ===== Unique Spec Key Source (Agenda DB) =====
  // ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ÙÙ‚Ø· Ù„Ø¬Ù„Ø¨ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù€ Spec Key Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ§Ø³Ùƒ (Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©).
  const agendaFirebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };


    // Workspace App (Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
    if(!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    // Secondary app instance for creating users without affecting current session
    const adminCreateApp = initializeApp(firebaseConfig, "adminCreate");
    const adminCreateAuth = getAuth(adminCreateApp);


    // Agenda/Stock App (Ù…Ø´Ø±ÙˆØ¹ Ù…Ø®ØªÙ„Ù) â€” Ù„ØªØ¹Ø¨ÙŠÙ”Ø© Unique Spec Key
    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§Ø²Ù… Anonymous Auth ÙŠÙƒÙˆÙ† Ù…ÙØ¹Ù‘Ù„ ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ mzj-agenda + Rules ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©.
    const agendaApp = initializeApp(agendaFirebaseConfig, "agenda");
    const agendaAuth = getAuth(agendaApp);
    const agendaDb = getFirestore(agendaApp);

    const $ = (id)=> document.getElementById(id);
    const appEl = $("app");
    const toastEl = $("toast");

    // ===== Auth Gate helpers (Ø¨Ø¯ÙˆÙ† ØµÙØ­Ø© login.html) =====
    const authGate = $("authGate");
    const authErr = $("authErr");
    const loginEmail = $("loginEmail");
    const loginPass = $("loginPass");
    const btnLogin = $("btnLogin");

    function showAuth(msg=null){
      authErr.classList.toggle("show", !!msg);
      authErr.textContent = msg || "";
      authGate.classList.add("show");
      appEl.classList.add("hide-app");
    }
    function hideAuth(){
      authGate.classList.remove("show");
      appEl.classList.remove("hide-app");
      authErr.classList.remove("show");
    }

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=> toastEl.classList.remove("show"), 2200);
    }
    function escapeHtml(s){
      return String(s??"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    
    
    // Admin emails (Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª + Ù…Ø²Ø§Ù…Ù†Ø© Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù€ Workspace)
    const ADMIN_EMAILS = [
      "hossamzayan10@gmail.com",
      "an9036663@gmail.com",
      "mr.ahmed_rashed@outlook.sa"
    ];
    function isAdminEmail(email){
      const e = String(email||"").toLowerCase().trim();
      return ADMIN_EMAILS.includes(e);
    }

    // Cache Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù€ Workspace (Ù†ÙØ³ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
    // ÙŠØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø­Ø¯Ø«Ø© Ù…Ù† stock Ù‡Ù†Ø§ Ù„ØªØ³ØªØ®Ø¯Ù… Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„Ù‰ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    const SPEC_CACHE_DOC = doc(db, "spec_keys_cache", "v1");
    let lastStockHash = "";
    async function upsertSpecCache(stockArr){
      try{
        const email = auth.currentUser?.email || "";
        if(!isAdminEmail(email)) return; // ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙƒØ§Ø´ Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
        const payload = Array.isArray(stockArr) ? stockArr : [];
        const h = await stockHash(payload);
        if(h && h === lastStockHash) return;
        lastStockHash = h;
        await setDoc(SPEC_CACHE_DOC, {
          stock: payload,
          updatedAt: serverTimestamp(),
          updatedBy: email
        }, { merge:true });
      }catch(e){
        console.warn("upsertSpecCache failed", e);
      }
    }
    function stockHash(arr){
      try{
        // hash Ø®ÙÙŠÙ Ù„ØªÙØ§Ø¯ÙŠ ÙƒØªØ§Ø¨Ø© Ù…ØªÙƒØ±Ø±Ø©
        const txt = JSON.stringify(arr);
        let hash = 0;
        for(let i=0;i<txt.length;i++){
          hash = ((hash<<5)-hash) + txt.charCodeAt(i);
          hash |= 0;
        }
        return Promise.resolve(String(hash));
      }catch(e){
        return Promise.resolve("");
      }
    }

// ===== Spec Key Options (Ø¨Ø¯ÙˆÙ† Ø£Ù„ÙˆØ§Ù†) =====
    const SPEC_DATALIST_ID = "specKeyList";
    // ÙƒÙ„ Ø§Ù„Ù€ Spec Keys Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø¨Ø¹Ø¯ ÙÙ„ØªØ± Ø§Ù„Ø£Ù…Ø§ÙƒÙ†) Ù‚Ø¨Ù„ ÙÙ„ØªØ± Ø§Ù„Ù…ÙˆÙ†ØªØ§Ø¬
    let SPEC_KEY_ALL = [];
    // Ø§Ù„Ù„ÙŠ Ù‡Ù†Ø¸Ù‡Ø±Ù‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø§ØªØ§ Ù„ÙŠØ³Øª
    let SPEC_KEY_OPTIONS = []
    let SPEC_KEY_SET = new Set();
    let agendaUnsub = null;

    let AGENDA_STOCK = [];

    function cleanSpec(v){
      return String(v ?? "").replace(/[--]/g,"").replace(/\s+/g," ").trim();
    }

    function buildSpecKeyNoColors(rec){
      const car = cleanSpec(rec.car);
      const variant = cleanSpec(rec.variant);
      const year = cleanSpec(rec.modelYear);
      const parts = [car, variant, year].map(x=> x || "-");
      return parts.join(" | ");
    }

    const SOLD_STATES_SPEC = ["Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„ÙˆÙƒØ§Ù„Ø©"];
    function isSoldRowForSpec(rec){
      const placeRaw = cleanSpec(rec.place || rec.location || rec["Ø§Ù„Ù…ÙƒØ§Ù†"] || "");
      if(!placeRaw) return false;
      return SOLD_STATES_SPEC.some(st => placeRaw.includes(st));
    }

    // ÙŠØ¬Ù‡Ø² ÙƒÙ„ Ø§Ù„Ù€ Spec Keys Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø¨Ø¯ÙˆÙ† Ø§Ù„ÙˆÙƒØ§Ù„Ø©/Ø§Ù„Ù…Ø¨Ø§Ø¹) Ø«Ù… ÙŠØ·Ø¨Ù‚ ÙÙ„ØªØ± "ØºÙŠØ± Ù…Ø¹Ù…ÙˆÙ„ Ù„Ù‡Ø§ Ù…ÙˆÙ†ØªØ§Ø¬"
    function setSpecKeyOptionsFromStock(stockArr){
      try{
        const set = new Set();
        for(const r of (Array.isArray(stockArr)?stockArr:[])){
          if(isSoldRowForSpec(r)) continue;
          const key = buildSpecKeyNoColors(r);
          if(key && key !== "- | - | -") set.add(key);
        }
        SPEC_KEY_ALL = Array.from(set).sort((a,b)=> a.localeCompare(b,"ar"));
        applySpecKeyNotMontagedFilter();
      }catch(e){
        console.warn("setSpecKeyOptionsFromStock error", e);
      }
    }

    // ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù„ÙŠ "Ù„Ø³Ø© Ù…Ø´ Ù…Ø¹Ù…ÙˆÙ„Ù‡Ø§ Ù…ÙˆÙ†ØªØ§Ø¬" Ø­Ø³Ø¨ stock_tasks ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ workspace
    function applySpecKeyNotMontagedFilter(){
      try{
        // Ù„Ùˆ Ù…Ø´ Ù„Ø§Ù‚ÙŠÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù‡Ø§Ù… Ù„Ø³Ù‡ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ Ù…Ø¤Ù‚ØªÙ‹Ø§
        const list = Array.isArray(SPEC_KEY_ALL) ? SPEC_KEY_ALL : [];
        if(!STOCK_TASKS_MAP || STOCK_TASKS_MAP.size === 0){
          SPEC_KEY_OPTIONS = list;
        }else{
          SPEC_KEY_OPTIONS = list.filter(k=>{
            const t = STOCK_TASKS_MAP.get(String(k)) || {};
            // ÙŠØ¹ØªØ¨Ø± "ØªÙ… Ø§Ù„Ù…ÙˆÙ†ØªØ§Ø¬" ÙÙ‚Ø· Ù„Ùˆ montage == Ù†Ø¹Ù…
            return String(t.montage || "").trim() !== "Ù†Ø¹Ù…";
          });
        }
        renderSpecKeyDatalist();
      }catch(e){
        console.warn("applySpecKeyNotMontagedFilter error", e);
        SPEC_KEY_OPTIONS = Array.isArray(SPEC_KEY_ALL) ? SPEC_KEY_ALL : [];
        renderSpecKeyDatalist();
      }
    }

    function renderSpecKeyDatalist(){
      const dl = document.getElementById(SPEC_DATALIST_ID);
      if(!dl) return;
      SPEC_KEY_SET = new Set((SPEC_KEY_OPTIONS||[]).map(k=>String(k).trim()));
      dl.innerHTML = SPEC_KEY_OPTIONS.map(k=> `<option value="${escapeAttr(k)}"></option>`).join("");
    }

    // init live source
    
    function initLocalSpecCache(){
      try{
        onSnapshot(SPEC_CACHE_DOC, (snap)=>{
          if(!snap.exists()) return;
          const d = snap.data() || {};
          if(Array.isArray(d.stock) && d.stock.length){
            setSpecKeyOptionsFromStock(d.stock);
          }
        });
      }catch(e){
        console.warn("initLocalSpecCache failed", e);
      }
    }

function initSpecKeySource(){
      try{
        // Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† ÙÙŠ Auth Ø¯Ø§Ø®Ù„ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Firebase Project Ù…Ø®ØªÙ„Ù)
        // Ù‡Ù†Ø³ØªØ®Ø¯Ù… Anonymous Auth Ø¹Ù„Ø´Ø§Ù† Ù†Ù‚Ø¯Ø± Ù†Ù‚Ø±Ø£ Ø§Ù„Ø¯Ø§ØªØ§ (Ù„Ùˆ Anonymous Ù…ÙØ¹Ù‘Ù„ ÙÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹).
        signInAnonymously(agendaAuth).then(()=>{
          const stateRef = doc(agendaDb, "mzj_admin_state", "v1");
          if(agendaUnsub) agendaUnsub();
          agendaUnsub = onSnapshot(stateRef, (snap)=>{
            if(!snap.exists()) return;
            const d = snap.data() || {};
            setSpecKeyOptionsFromStock(d.stock || []);
            AGENDA_STOCK = Array.isArray(d.stock) ? d.stock : [];
            if(MODE==="stock") renderStockTab();
            // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø­Ø¯Ø«Ø© Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù€ Workspace
            upsertSpecCache(d.stock || []);
          }, (err)=>{
            console.warn("SpecKey source snapshot error", err);
            toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Unique Spec Key (ØªØ­Ù‚Ù‚ Ù…Ù† Rules/Anonymous Auth ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)");
          });
        }).catch((err)=>{
          console.warn("agenda anonymous auth failed", err);
          toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Unique Spec Key (Anonymous Auth ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)");
        });
      }catch(e){
        console.warn("initSpecKeySource failed", e);
        toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Unique Spec Key");
      }
    }

    function escapeAttr(s){ return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;"); }
function initials(name){
      const n = (name||"M").trim();
      const parts = n.split(/\s+/).filter(Boolean);
      if(parts.length===1) return parts[0][0].toUpperCase();
      return (parts[0][0]+parts[1][0]).toUpperCase();
    }

    $("sbToggle").addEventListener("click", ()=>{
      appEl.classList.toggle("collapsed");
      localStorage.setItem("ws_sb_collapsed", appEl.classList.contains("collapsed") ? "1" : "0");
    });
    if(localStorage.getItem("ws_sb_collapsed")==="1") appEl.classList.add("collapsed");

    const views = { home: $("viewHome"), list: $("viewList"), board: $("viewBoard"), daily: $("viewDaily"), stock: $("viewStock"), admin: $("viewAdmin") };

    // Last rendered rows for Excel export (stock tab)
    let __LAST_STOCK_ROWS = [];


    // stock tab search (ÙÙ„ØªØ± ÙÙˆØ±ÙŠ Ø¯Ø§Ø®Ù„ Ø¬Ø¯ÙˆÙ„ stock)
    const stockSearchEl = document.getElementById('stockSearch');
    if(stockSearchEl){
      stockSearchEl.addEventListener('input', ()=>{
        if(MODE==='stock') renderStockTab();
      });
    }

    // Export Excel (stock tab)
    const btnStockExport = document.getElementById('btnStockExport');
    if(btnStockExport){
      btnStockExport.addEventListener('click', ()=>{
        try{
          exportStockToExcel(__LAST_STOCK_ROWS);
        }catch(err){
          console.error(err);
          toast('âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Excel');
        }
      });
    }

    function exportStockToExcel(rows){
      if(!rows || !rows.length){
        toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
        return;
      }
      if(typeof XLSX==='undefined'){
        toast('âš ï¸ Ù…ÙƒØªØ¨Ø© Excel Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§');
        return;
      }
      const data = rows.map((r,i)=>({
        'Ù…': i+1,
        'Unique Spec Key': r.specKey||'',
        'Ø§Ù„Ø¹Ø¯Ø¯': r.count||0,
        'ØªØµÙˆÙŠØ±': r.photo||'',
        'Ù…ÙˆÙ†ØªØ§Ø¬': r.montage||'',
        'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ†ØªØ§Ø¬': r.montageDetails||'',
        'Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©': r.inAgenda||'',
        'Ø§Ù„Ø´Ù‡Ø±': r.agendaMonth||'',
        'Ø§Ù„Ø³Ù†Ø©': r.agendaYear||''
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'stock');
      const now = new Date();
      const pad = (n)=> String(n).padStart(2,'0');
      const fname = `stock_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.xlsx`;
      XLSX.writeFile(wb, fname);
    }

    function showView(key){
      Object.values(views).forEach(v=> v.style.display="none");
      views[key].style.display="";
    }

    let CURRENT_USER = null;
    let CURRENT_ROLE = "member";
    let USERS = [];

    // ===== Persist last opened tab (refresh keeps same tab) =====
    const LAST_VIEW_KEY = "ws_last_view";
    function saveLastView(view, extra={}){
      try{ localStorage.setItem(LAST_VIEW_KEY, JSON.stringify({view, ...extra})); }catch(e){}
    }
    async function restoreLastView(){
      let state=null;
      try{ state = JSON.parse(localStorage.getItem(LAST_VIEW_KEY)||"null"); }catch(e){ state=null; }
      if(!state || !state.view){ openHome(); return; }

      if(state.view==="home") return openHome();
      if(state.view==="list") return openList(state.type||"agenda");
      if(state.view==="daily") return openDaily();
      if(state.view==="stock") return openStock();
      if(state.view==="admin") return openAdmin();
      if(state.view==="board"){
        try{
          if(state.workspaceId){
            const snap = await getDoc(doc(db,"workspaces", state.workspaceId));
            if(snap.exists()) return openBoard({id:snap.id, ...(snap.data()||{})});
          }
        }catch(e){}
        return openHome();
      }
      return openHome();
    }

let MODE = "home";
    let LIST_TYPE = null;
    let CURRENT_WORKSPACE = null;
    let CURRENT_TASK = null;

    // Board tasks filter (agenda only)
    let BOARD_USER_FILTER_UID = "";
    let BOARD_TASKS_ALL = [];

    let unsubWorkspaces = null;
    let unsubTasks = null;

    $("btnCreateAgenda").addEventListener("click", ()=> openBoardModal("agenda", "create"));
    $("btnCreateCampaign").addEventListener("click", ()=> openBoardModal("campaign", "create"));
    $("btnBack").addEventListener("click", ()=> {
      if(MODE==="board") openList(LIST_TYPE);
      else openHome();
    });

    function setNavActive(which){
      ["navHome","navAgendas","navCampaigns","navDaily","navStock","navAdmin"].forEach(id=>{
        $(id).classList.toggle("active", id===which);
      });
    }
    $("navHome").addEventListener("click", ()=> openHome());
    $("navAgendas").addEventListener("click", ()=> openList("agenda"));
    $("navCampaigns").addEventListener("click", ()=> openList("campaign"));

    $("navDaily").addEventListener("click", ()=> openDaily());

    $("navStock").addEventListener("click", ()=> openStock());

    $("navAdmin").addEventListener("click", ()=> openAdmin());

    $("goAgendas").addEventListener("click", ()=> openList("agenda"));
    $("goCampaigns").addEventListener("click", ()=> openList("campaign"));

    $("btnLogout").addEventListener("click", async ()=>{
      await signOut(auth);
      showAuth("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬. Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
    });

    // ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ (Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ø±ÙŠÙØ±ÙŠØ´ Ù…Ø§ÙŠØ±Ø¬Ø¹Ùƒ Ù„Ø£ÙŠ ØµÙØ­Ø©)
    setPersistence(auth, browserLocalPersistence).catch((e)=>{
      console.warn("setPersistence failed", e);
    });

    async function doLogin(){
      const email = (loginEmail.value||"").trim();
      const pass = (loginPass.value||"").trim();
      if(!email || !pass) return showAuth("Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
      btnLogin.disabled = true;
      btnLogin.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...";
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        hideAuth();
      }catch(err){
        console.warn("login failed", err);
        const code = err?.code || "";
        let msg = "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
        if(code.includes("auth/invalid-credential")) msg = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
        if(code.includes("auth/user-not-found")) msg = "Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
        if(code.includes("auth/wrong-password")) msg = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
        if(code.includes("auth/too-many-requests")) msg = "Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©. Ø¬Ø±Ù‘Ø¨ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„.";
        showAuth(msg);
      }finally{
        btnLogin.disabled = false;
        btnLogin.textContent = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
      }
    }

    btnLogin.addEventListener("click", doLogin);
    loginPass.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
    loginEmail.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ showAuth(); return; }
      CURRENT_USER = user;
      hideAuth();

      let displayName = user.email || "Ù…Ø³ØªØ®Ø¯Ù…";
      try{
        const uSnap = await getDoc(doc(db, "users", user.uid));
        if(uSnap.exists()){
          const ud = uSnap.data() || {};
          displayName = ud.name || ud.username || user.email || "Ù…Ø³ØªØ®Ø¯Ù…";
          CURRENT_ROLE = ud.role || "member";
        }
      }catch{}

      $("whoName").textContent = displayName;
      $("whoRole").textContent = (CURRENT_ROLE==="admin" ? "Ù…Ø¯ÙŠØ±" : "Ø¹Ø¶Ùˆ");
      // show Admin tab for admins only
      try{ $("navAdmin").style.display = (CURRENT_ROLE==="admin" ? "" : "none"); }catch(e){}
      try{ $("navDaily").style.display = (CURRENT_ROLE==="admin" ? "" : "none"); }catch(e){}
      try{ $("navDaily").style.display = (CURRENT_ROLE==="admin" ? "" : "none"); }catch(e){}
      $("avatar").textContent = initials(displayName);

      await loadUsers();
      // Ù…Ù‡Ø§Ù… Tab stock (Ù„Ø§ ØªÙ…Ø³ mzj-agenda) â€” Ù†Ø­ØªØ§Ø¬Ù‡Ø§ Ù„ØªØµÙÙŠØ© Unique Spec Key "Ø¨Ø¯ÙˆÙ† Ù…ÙˆÙ†ØªØ§Ø¬"
      await loadStockTasksOnce();
      restoreLastView();
      listenKPIs();

      // Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù€ Spec Key (1) ÙƒØ§Ø´ Ù…Ø­Ù„ÙŠ Ø¯Ø§Ø®Ù„ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù€ Workspace + (2) Ù…ØµØ¯Ø± Ø­ÙŠ Ù…Ù† Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù€ Agenda
      initLocalSpecCache();
      initSpecKeySource();
      wireAdminTab();
    });

    async function loadUsers(){
      USERS = [];
      try{
        const snap = await getDocs(collection(db,"users"));
        snap.forEach(d=>{
          const u = d.data()||{};
          USERS.push({
            uid: d.id,
            name: u.name || u.username || u.email || d.id.slice(0,6),
            role: u.role || "member",
            email: u.email || null,
            createdAt: u.createdAt || null,
            active: (u.active !== false)
          });
        });
      }catch(err){ console.warn("users load failed", err); }

      const sel = $("taskAssignee");
      sel.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± ÙŠÙˆØ²Ø± â€”</option>`;
      USERS.slice().sort((a,b)=> (a.name||"").localeCompare(b.name||"", "ar")).forEach(u=>{
        const opt = document.createElement("option");
        opt.value = u.uid;
        opt.textContent = u.name + (u.role ? ` (${u.role})` : "");
        sel.appendChild(opt);
      });
    }

    

    // ===== Admin Tab: Create new user (Auth + users/{uid}) =====
    function setAdminMsg(msg, isErr=false){
      const el = $("adminMsg");
      if(!el) return;
      el.style.color = isErr ? "var(--danger)" : "var(--muted)";
      el.textContent = msg || "";
    }

    function setAdminUsersMsg(msg, isErr=false){
      const el = $("adminUsersMsg");
      if(!el) return;
      el.style.color = isErr ? "var(--danger)" : "var(--muted)";
      el.textContent = msg || "";
    }

    function fmtDateAny(v){
      try{
        if(!v) return "";
        if(typeof v === "object" && typeof v.toDate === "function"){
          const d = v.toDate();
          return d.toLocaleDateString('ar-SA') + " " + d.toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'});
        }
        if(typeof v === "number"){
          const d = new Date(v);
          return d.toLocaleDateString('ar-SA') + " " + d.toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'});
        }
      }catch(e){}
      return "";
    }

    function renderAdminUsersTable(){
      const table = $("adminUsersTable");
      if(!table) return;

      const q = String($("adminUserSearch")?.value || "").trim().toLowerCase();
      const list = USERS
        .slice()
        .filter(u=>{
          const a = (u.name||"").toLowerCase();
          const b = (u.email||"").toLowerCase();
          const c = (u.uid||"").toLowerCase();
          return !q || a.includes(q) || b.includes(q) || c.includes(q);
        })
        .sort((a,b)=> ((a.name||a.email||a.uid)||"").localeCompare((b.name||b.email||b.uid)||"", "ar"));

      table.innerHTML = `
        <thead>
          <tr>
            <th style="width:52px">#</th>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
            <th style="width:160px">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
            <th style="width:200px">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
            <th style="width:260px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector('tbody');
      if(!list.length){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6" style="text-align:center;color:var(--muted);padding:18px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.</td>`;
        tbody.appendChild(tr);
        return;
      }

      list.forEach((u, idx)=>{
        const tr = document.createElement('tr');
        const created = fmtDateAny(u.createdAt);
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td><b>${escapeHtml(u.name||"-")}</b></td>
          <td>${escapeHtml(u.email||"-")}</td>
          <td>
            <select class="inp" data-role-sel="${escapeHtml(u.uid)}" style="min-width:140px">
              <option value="member">member</option>
              <option value="finisher">finisher</option>
              <option value="admin">admin</option>
            </select>
          </td>
          <td>${created || "-"}</td>
          <td>
            <div style="display:flex;gap:8px;justify-content:flex-start;flex-wrap:wrap">
              <button class="btn sm" data-save-user="${escapeHtml(u.uid)}" type="button">Ø­ÙØ¸</button>
              <button class="btn secondary sm" data-reset-pass="${escapeHtml(u.uid)}" type="button">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
              <span class="pill" style="align-self:center">UID: ${escapeHtml(String(u.uid).slice(0,8))}â€¦</span>
            </div>
          </td>
        `;
        tbody.appendChild(tr);

        // set default role
        const sel = tr.querySelector(`[data-role-sel="${CSS.escape(u.uid)}"]`);
        if(sel) sel.value = (u.role||"member");
      });
    }

    function wireAdminTab(){
      const btn = $("adminCreateUser");
      if(!btn) return;

      // Users list controls
      const search = $("adminUserSearch");
      const refresh = $("adminUsersRefresh");

      const repaintUsers = () => {
        renderAdminUsersTable();
        setAdminUsersMsg(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${USERS.length} Ù…Ø³ØªØ®Ø¯Ù…`);
      };

      if(search){
        search.addEventListener("input", ()=> repaintUsers());
      }
      if(refresh){
        refresh.addEventListener("click", async ()=>{
          if(CURRENT_ROLE !== "admin"){ setAdminUsersMsg("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­.", true); return; }
          refresh.disabled = true;
          try{
            await loadUsers();
            repaintUsers();
            toast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†");
          }catch(e){
            setAdminUsersMsg("âš ï¸ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", true);
          }finally{ refresh.disabled = false; }
        });
      }
      $("adminClear").addEventListener("click", ()=>{
        $("adminNewEmail").value = "";
        $("adminNewPass").value = "";
        $("adminNewName").value = "";
        $("adminNewRole").value = "member";
        setAdminMsg("");
      });

      btn.addEventListener("click", async ()=>{
        if(CURRENT_ROLE !== "admin"){
          setAdminMsg("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ â€” Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.", true);
          return;
        }

        const email = String($("adminNewEmail").value||"").trim().toLowerCase();
        const pass  = String($("adminNewPass").value||"").trim();
        const role  = String($("adminNewRole").value||"member").trim();
        const name  = String($("adminNewName").value||"").trim();

        if(!email || !pass){
          setAdminMsg("Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.", true);
          return;
        }
        if(pass.length < 6){
          setAdminMsg("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£ÙƒØ«Ø±.", true);
          return;
        }

        btn.disabled = true;
        btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...";
        setAdminMsg("");

        try{
          // Create auth user via secondary auth instance (does NOT sign out current admin)
          const cred = await createUserWithEmailAndPassword(adminCreateAuth, email, pass);
          const newUser = cred.user;

          // Create users/{uid} document in same workspace Firestore
          await setDoc(doc(db, "users", newUser.uid), {
            email,
            name: name || email.split("@")[0],
            role: role || "member",
            createdAt: serverTimestamp(),
            createdBy: CURRENT_USER?.uid || null
          }, { merge: true });

          setAdminMsg(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: ${role}`);
          toast("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
          await loadUsers();
          repaintUsers();

          // keep secondary auth clean
          try{ await signOut(adminCreateAuth); }catch(e){}

        }catch(err){
          console.warn("admin create user failed", err);
          const code = err?.code || "";
          let msg = "ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….";
          if(code.includes("auth/email-already-in-use")) msg = "Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.";
          if(code.includes("auth/invalid-email")) msg = "Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ§Ù„Ø­.";
          if(code.includes("auth/weak-password")) msg = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©.";
          setAdminMsg("âš ï¸ " + msg, true);
        }finally{
          btn.disabled = false;
          btn.textContent = "â• Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";
        }
      });

      // Table actions (save role / reset password)
      const table = $("adminUsersTable");
      if(table){
        table.addEventListener("click", async (e)=>{
          const saveBtn = e.target.closest("[data-save-user]");
          const resetBtn = e.target.closest("[data-reset-pass]");

          if(saveBtn){
            if(CURRENT_ROLE !== "admin"){ setAdminUsersMsg("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­.", true); return; }
            const uid = saveBtn.getAttribute("data-save-user");
            const sel = table.querySelector(`[data-role-sel="${CSS.escape(uid)}"]`);
            const newRole = String(sel?.value || "member");
            saveBtn.disabled = true;
            try{
              await updateDoc(doc(db,"users", uid), { role: newRole, updatedAt: serverTimestamp(), updatedBy: CURRENT_USER?.uid || null });
              // update local cache
              const i = USERS.findIndex(x=> x.uid===uid);
              if(i>=0) USERS[i].role = newRole;
              toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©");
              setAdminUsersMsg("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­");
              // refresh assignee dropdown labels
              await loadUsers();
              repaintUsers();
            }catch(err){
              console.warn("save user role failed", err);
              setAdminUsersMsg("âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯)", true);
            }finally{
              saveBtn.disabled = false;
            }
            return;
          }

          if(resetBtn){
            if(CURRENT_ROLE !== "admin"){ setAdminUsersMsg("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­.", true); return; }
            const uid = resetBtn.getAttribute("data-reset-pass");
            const u = USERS.find(x=> x.uid===uid);
            const email = (u?.email || "").trim();
            if(!email){ setAdminUsersMsg("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø­ÙÙˆØ¸ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….", true); return; }
            resetBtn.disabled = true;
            try{
              await sendPasswordResetEmail(auth, email);
              toast("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†");
              setAdminUsersMsg(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰: ${email}`);
            }catch(err){
              console.warn("reset pass failed", err);
              setAdminUsersMsg("âš ï¸ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†", true);
            }finally{ resetBtn.disabled = false; }
            return;
          }
        });
      }

      // initial paint
      repaintUsers();
    }

let unsubKpiWs=null, unsubKpiTasks=null;
    function listenKPIs(){
      if(unsubKpiWs) unsubKpiWs();
      if(unsubKpiTasks) unsubKpiTasks();

      unsubKpiWs = onSnapshot(collection(db,"workspaces"), (snap)=>{
        let agendas=0, campaigns=0;
        snap.forEach(d=>{
          const x = d.data()||{};
          if(x.active===false) return;
          if(x.type==="agenda") agendas++;
          if(x.type==="campaign") campaigns++;
        });
        $("kpiAgendas").textContent = agendas;
        $("kpiCampaigns").textContent = campaigns;
      });

      unsubKpiTasks = onSnapshot(collection(db,"workspace_tasks"), (snap)=>{
        let a=0,c=0;
        snap.forEach(d=>{
          const t=d.data()||{};
          if(t.type==="agenda") a++;
          if(t.type==="campaign") c++;
        });
        $("kpiAgendaTasks").textContent = a;
        $("kpiCampaignTasks").textContent = c;
      });
    }



    function openStock(){
      MODE="stock"; LIST_TYPE=null; CURRENT_WORKSPACE=null;
      saveLastView("stock");
      if(unsubWorkspaces){unsubWorkspaces();unsubWorkspaces=null;}
      if(unsubTasks){unsubTasks();unsubTasks=null;}

      setNavActive("navStock");
      $("pageTitle").textContent = "stock";
      $("pageDesc").textContent  = "";
      $("btnBack").style.display="none";
      $("btnCreateAgenda").style.display="none";
      $("btnCreateCampaign").style.display="none";

      showView("stock");
      renderStockTab();
    }

    function openAdmin(){
      MODE="admin"; LIST_TYPE=null; CURRENT_WORKSPACE=null;
      if(unsubWorkspaces){unsubWorkspaces();unsubWorkspaces=null;}
      if(unsubTasks){unsubTasks();unsubTasks=null;}

      saveLastView("admin");
      setNavActive("navAdmin");
      $("pageTitle").textContent = "admin";
      $("pageDesc").textContent  = "";
      $("btnBack").style.display="none";
      $("btnCreateAgenda").style.display="none";
      $("btnCreateCampaign").style.display="none";

      showView("admin");
    }


    // Ù†ÙØ³ Ù…Ù†Ø·Ù‚ ÙÙ„ØªØ± ØµÙØ­Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:
    // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù„ÙŠ Ù…ÙƒØ§Ù†Ù‡Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰:
    // (Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…) Ø£Ùˆ (Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…)
    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø£Ø­ÙŠØ§Ù†Ù‹Ø§ Ø¨ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Øµ ÙÙŠÙ‡ Ù…Ø³Ø§ÙØ§Øª ØºÙŠØ± Ù…Ø±Ø¦ÙŠØ©/ØªØ´ÙƒÙŠÙ„/ÙƒØ´ÙŠØ¯Ø©ØŒ ÙÙ†Ø¹Ù…Ù„ Normalization Ù‚ÙˆÙŠ.
    function normalizeArabicText(input){
      const s = String(input ?? "")
        .replace(/\u00A0/g, " ")               // NBSP
        .replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069]/g, "") // Ø§ØªØ¬Ø§Ù‡Ø§Øª
        .replace(/[\u064B-\u065F\u0670]/g, "") // ØªØ´ÙƒÙŠÙ„
        .replace(/\u0640/g, "")               // ÙƒØ´ÙŠØ¯Ø©
        .replace(/_/g, " ")
        .replace(/\s+/g, " ")
        .trim();
      return s;
    }

    function extractLocationValue(rec){
      if(!rec || typeof rec !== "object") return "";
      const raw = (rec.location ?? rec.place ?? rec["Ø§Ù„Ù…ÙƒØ§Ù†"] ?? rec["place"] ?? rec["Location"] ?? rec["LOC"] ?? rec["loc"]);
      if(raw == null) return "";
      if(typeof raw === "string" || typeof raw === "number") return String(raw);
      if(Array.isArray(raw)) return raw.map(x=> String(x ?? "")).join(" ");
      if(typeof raw === "object"){
        // Ø¨Ø¹Ø¶ Ø§Ù„Ø¯Ø§ØªØ§ Ø¨ØªÙƒÙˆÙ† Object Ø¨Ø¯Ù„ Ù†Øµ
        const cand = raw.name ?? raw.label ?? raw.value ?? raw.text ?? raw.title;
        if(cand != null) return String(cand);
        try{ return JSON.stringify(raw); }catch(e){ return ""; }
      }
      return String(raw);
    }

    function isExcludedByInventoryFilter(rec){
      // Ù†ÙØ³ Ù…Ù†Ø·Ù‚ ØµÙØ­Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø´Ø±Ø· "Ø¨Ø¯ÙˆÙ† Ø§Ù„ÙˆÙƒØ§Ù„Ø©" Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ:
      // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯:
      // 1) Ø£ÙŠ Ù…ÙƒØ§Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ "Ø§Ù„ÙˆÙƒØ§Ù„Ø© :"
      // 2) Ø£ÙŠ Ù…ÙƒØ§Ù† ÙŠØ­ØªÙˆÙŠ "Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…" Ø£Ùˆ "Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"
      const locRaw = extractLocationValue(rec);
      const loc = normalizeArabicText(locRaw);
      if(!loc) return false;
      const isAgency = loc.startsWith("Ø§Ù„ÙˆÙƒØ§Ù„Ø© :");
      const isUnder  = loc.includes("Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…");
      const isDone   = loc.includes("Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…");
      return isAgency || isUnder || isDone;
    }

    

    // =========================
    // Dashboard (Home) â€” Ø¹Ø±Ø¶ Ø£Ø¬Ù†Ø¯Ø© ÙˆØ­Ù…Ù„Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ + ÙÙ„ØªØ±Ø© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©
    // =========================
    const MONTHS_AR_FULL = [
      "ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ",
      "ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"
    ];

    function currentMonthInfo(){
      const now = new Date();
      const monthIdx = now.getMonth(); // 0..11
      const year = now.getFullYear();
      const name = MONTHS_AR_FULL[monthIdx] || "";
      const mm = String(monthIdx+1).padStart(2,'0');
      return { monthIdx, monthName: name, monthNumber: monthIdx+1, mm, year };
    }

    function wsMatchesMonth(ws, monthName, mm){
      try{
        const name = String(ws?.name||"");
        const start = String(ws?.startDate||"");
        const end   = String(ws?.endDate||"");
        // 1) Ø§Ù„Ø§Ø³Ù… ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø¹Ø±Ø¨ÙŠ
        if(monthName && name.includes(monthName)) return true;
        // 2) Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© YYYY-MM-DD Ø£Ùˆ Ù…Ø´Ø§Ø¨Ù‡
        if(mm && (start.includes('-'+mm+'-') || end.includes('-'+mm+'-'))) return true;
      }catch(e){}
      return false;
    }

    function isTaskDone(t){
      const col = String(t?.column||"");
      const st  = String(t?.status||"");
      if(col.includes('ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡')) return true;
      if(st === 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡' || st === 'done' || st === 'completed' || st === 'true') return true;
      if(t?.done === true || t?.completed === true) return true;
      return false;
    }

    async function fetchWorkspacesByType(type){
      const qy = query(collection(db,'workspaces'), where('type','==', type));
      const snap = await getDocs(qy);
      const arr=[];
      snap.forEach(d=>{
        const x=d.data()||{};
        if(x.active===false) return;
        arr.push({id:d.id, ...x});
      });
      // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
      arr.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
      return arr;
    }

    async function fetchTasksForWorkspace(workspaceId){
      const qy = query(collection(db,'workspace_tasks'), where('workspaceId','==', workspaceId));
      const snap = await getDocs(qy);
      const tasks=[];
      snap.forEach(d=> tasks.push({id:d.id, ...(d.data()||{})}));
      // ØªØ±ØªÙŠØ¨ Ù…Ø­Ù„ÙŠ
      tasks.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
      return tasks;
    }

    function renderWorkspaceTasksReadOnly(container, ws, tasks){
      const wrap = document.createElement('div');
      wrap.className = 'dash-workspace';
      const total = tasks.length;
      const done = tasks.filter(isTaskDone).length;
      const pending = total - done;
      wrap.innerHTML = `
        <div class="top">
          <div>
            <div class="name">${escapeHtml(ws?.name||'â€”')}</div>
            <div class="meta">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b>${total}</b> | ØªÙ…: <b>${done}</b> | Ø¨Ø§Ù‚ÙŠ: <b>${pending}</b></div>
          </div>
          <span class="tag"><span class="mini"></span>${ws.type==='agenda'?'Agenda':'Campaign'}</span>
        </div>
        <div class="dash-tasks"></div>
      `;
      const list = wrap.querySelector('.dash-tasks');
      if(!tasks.length){
        const e = document.createElement('div');
        e.className='empty';
        e.style.fontSize='12px';
        e.textContent='Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ§Ø³ÙƒØ§Øª Ø¯Ø§Ø®Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±.';
        list.appendChild(e);
      }else{
        // Ù†Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„ØªØ§Ø³ÙƒØ§Øª Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
        tasks.forEach(t=>{
          const row = document.createElement('div');
          row.className='dash-task';
          const done = isTaskDone(t);
          const title = t.specKey || t.title || t.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
          const sub = t.column || t.columnName || '';
          row.innerHTML = `
            <div>
              <div class="t-title">${escapeHtml(title)}</div>
              <div class="t-sub">${escapeHtml(sub)}</div>
            </div>
            <span class="pill" style="background:${done?'#dcfce7':'#fff7ed'};border-color:${done?'#86efac':'#fed7aa'}">
              <span class="dot" style="background:${done?'#16a34a':'#f97316'}"></span>
              ${done?'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡':'Ø¨Ø§Ù‚ÙŠ'}
            </span>
          `;
          list.appendChild(row);
        });
      }
      container.appendChild(wrap);
    }

    // Cache for dashboard picker
    let __DASH_WS_CACHE = { agenda: [], campaign: [] };

    async function renderDashboardHome(){
      const info = currentMonthInfo();
      const monthName = info.monthName;
      const mm = info.mm;

      // pill
      const pill = document.getElementById('dashMonthPill');
      if(pill) pill.innerHTML = `<span class="dot"></span> Ø´Ù‡Ø± ${escapeHtml(monthName)} ${escapeHtml(String(info.year))}`;

      // load workspaces
      const agendas = await fetchWorkspacesByType('agenda');
      const campaigns = await fetchWorkspacesByType('campaign');
      __DASH_WS_CACHE.agenda = agendas;
      __DASH_WS_CACHE.campaign = campaigns;

      // choose month matches; fallback latest
      let monthAgendas = agendas.filter(w=> wsMatchesMonth(w, monthName, mm));
      let monthCampaigns = campaigns.filter(w=> wsMatchesMonth(w, monthName, mm));
      if(!monthAgendas.length && agendas.length) monthAgendas = agendas.slice(0,1);
      if(!monthCampaigns.length && campaigns.length) monthCampaigns = campaigns.slice(0,1);

      // render agendas
      const aWrap = document.getElementById('dashAgendasWrap');
      const aEmpty = document.getElementById('dashAgendasEmpty');
      if(aWrap){ aWrap.innerHTML=''; }
      let agendaTasksCount = 0;
      if(!monthAgendas.length){
        if(aEmpty) aEmpty.style.display='';
      }else{
        if(aEmpty) aEmpty.style.display='none';
        for(const ws of monthAgendas){
          const tasks = await fetchTasksForWorkspace(ws.id);
          agendaTasksCount += tasks.length;
          if(aWrap) renderWorkspaceTasksReadOnly(aWrap, ws, tasks);
        }
      }
      const aMeta = document.getElementById('dashAgendaMeta');
      if(aMeta) aMeta.textContent = `${monthAgendas.length} Ø£Ø¬Ù†Ø¯Ø© | ${agendaTasksCount} ØªØ§Ø³Ùƒ`;

      // render campaigns
      const cWrap = document.getElementById('dashCampaignsWrap');
      const cEmpty = document.getElementById('dashCampaignsEmpty');
      if(cWrap){ cWrap.innerHTML=''; }
      let campaignTasksCount = 0;
      if(!monthCampaigns.length){
        if(cEmpty) cEmpty.style.display='';
      }else{
        if(cEmpty) cEmpty.style.display='none';
        for(const ws of monthCampaigns){
          const tasks = await fetchTasksForWorkspace(ws.id);
          campaignTasksCount += tasks.length;
          if(cWrap) renderWorkspaceTasksReadOnly(cWrap, ws, tasks);
        }
      }
      const cMeta = document.getElementById('dashCampaignMeta');
      if(cMeta) cMeta.textContent = `${monthCampaigns.length} Ø­Ù…Ù„Ø© | ${campaignTasksCount} ØªØ§Ø³Ùƒ`;

      // wire picker UI
      try{ wireDashboardPicker(); }catch(e){ console.warn(e); }
    }

    function wireDashboardPicker(){
      const sel = document.getElementById('dashPickType');
      const listWrap = document.getElementById('dashPickListWrap');
      const listEl = document.getElementById('dashPickList');
      const applyBtn = document.getElementById('dashPickApply');
      const outWrap = document.getElementById('dashCustomWrap');
      const outBox = document.getElementById('dashCustomResults');
      const outTitle = document.getElementById('dashCustomTitle');
      const outMeta = document.getElementById('dashCustomMeta');

      if(!sel || !listWrap || !listEl || !applyBtn) return;

      function renderPickList(type){
        const arr = (__DASH_WS_CACHE[type] || []).slice();
        listEl.innerHTML = '';
        if(!arr.length){
          listEl.innerHTML = `<div class="empty" style="padding:10px;font-size:12px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±.</div>`;
          applyBtn.disabled = true;
          return;
        }
        arr.forEach(ws=>{
          const id = `pick_${type}_${ws.id}`;
          const row = document.createElement('label');
          row.className='pick-item';
          row.innerHTML = `
            <input type="checkbox" value="${escapeAttr(ws.id)}" />
            <div style="display:flex;flex-direction:column;gap:2px">
              <b>${escapeHtml(ws.name||'â€”')}</b>
              <span class="muted" style="font-size:12px">ID: ${escapeHtml(ws.id.slice(0,8))}â€¦</span>
            </div>
          `;
          listEl.appendChild(row);
        });
        applyBtn.disabled = true;

        listEl.querySelectorAll('input[type="checkbox"]').forEach(ch=>{
          ch.addEventListener('change', ()=>{
            const any = !!listEl.querySelector('input[type="checkbox"]:checked');
            applyBtn.disabled = !any;
          });
        });
      }

      sel.onchange = ()=>{
        const v = String(sel.value||'');
        if(!v){
          listWrap.style.display='none';
          if(outBox) outBox.style.display='none';
          applyBtn.disabled=true;
          return;
        }
        listWrap.style.display='';
        renderPickList(v);
      };

      applyBtn.onclick = async ()=>{
        const type = String(sel.value||'');
        const checked = Array.from(listEl.querySelectorAll('input[type="checkbox"]:checked')).map(x=>x.value);
        if(!type || !checked.length) return;
        applyBtn.disabled = true;
        try{
          if(outWrap) outWrap.innerHTML='';
          let totalTasks=0;
          for(const id of checked){
            const ws = (__DASH_WS_CACHE[type]||[]).find(x=>x.id===id);
            if(!ws) continue;
            const tasks = await fetchTasksForWorkspace(id);
            totalTasks += tasks.length;
            if(outWrap) renderWorkspaceTasksReadOnly(outWrap, ws, tasks);
          }
          if(outTitle) outTitle.textContent = (type==='agenda'?'Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©':'Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©');
          if(outMeta) outMeta.textContent = `Ø§Ù„Ø¹Ù†Ø§ØµØ±: ${checked.length} | Ø§Ù„ØªØ§Ø³ÙƒØ§Øª: ${totalTasks}`;
          if(outBox) outBox.style.display='';
        }finally{
          // re-enable based on current state
          const any = !!listEl.querySelector('input[type="checkbox"]:checked');
          applyBtn.disabled = !any;
        }
      };

      // initial
      if(!sel.value){
        listWrap.style.display='none';
      }
    }

    // =========================
    // Daily Task (Admin) â€” 4 Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø¬Ù†Ø¨ Ø¨Ø¹Ø¶ + Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ + Ù…Ø­Ø±Ø± Ù†ØµÙˆØµ
    // =========================
    let __DAILY_CACHE = [];
    let __DAILY_EDITOR_DOC = null;

    function openDaily(){
      MODE='daily';
      saveLastView('daily');
      if(unsubWorkspaces){unsubWorkspaces();unsubWorkspaces=null;}
      if(unsubTasks){unsubTasks();unsubTasks=null;}
      setNavActive('navDaily');
      $("pageTitle").textContent = 'Daily Task';
      $("pageDesc").textContent = '';
      $("btnBack").style.display='none';
      $("btnCreateAgenda").style.display='none';
      $("btnCreateCampaign").style.display='none';
      showView('daily');

      // init year/month defaults
      const info = currentMonthInfo();
      const yEl = document.getElementById('dailyYear');
      const mEl = document.getElementById('dailyMonth');
      if(yEl && !yEl.value) yEl.value = String(info.year);
      if(mEl && !mEl.dataset.inited){
        mEl.innerHTML = MONTHS_AR_FULL.map((m,idx)=> `<option value="${idx+1}">${escapeHtml(m)}</option>`).join('');
        mEl.dataset.inited = '1';
      }
      if(mEl) mEl.value = String(info.monthNumber);

      // wire
      document.getElementById('dailyReload')?.addEventListener('click', ()=> loadDaily());
      document.getElementById('dailyYear')?.addEventListener('change', ()=> loadDaily());
      document.getElementById('dailyMonth')?.addEventListener('change', ()=> loadDaily());
      document.getElementById('dailyTextOpen')?.addEventListener('click', ()=> openDailyEditor());

      // first load
      loadDaily();
    }

    async function loadDaily(){
      const y = parseInt(String(document.getElementById('dailyYear')?.value||''),10);
      const m = parseInt(String(document.getElementById('dailyMonth')?.value||''),10);
      if(!y || !m) return;

      // load docs for month
      const ym = `${y}-${String(m).padStart(2,'0')}`;
      const qy = query(collection(db,'daily_tasks'), where('ym','==', ym));
      const snap = await getDocs(qy);
      const arr=[];
      snap.forEach(d=> arr.push({id:d.id, ...(d.data()||{})}));
      __DAILY_CACHE = arr;
      renderDailyWeeks(y,m,arr);
    }

    function weekLabel(idx){
      return `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${idx+1}`;
    }

    const DAYS_AR = ['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'];

    function renderDailyWeeks(year, monthNumber, tasks){
      const root = document.getElementById('dailyWeeks');
      if(!root) return;
      root.innerHTML='';

      // build 4 weeks columns
      for(let w=0; w<4; w++){
        const col = document.createElement('div');
        col.className='col';
        col.style.minWidth='240px';
        col.innerHTML = `
          <div class="col-head">
            <div class="col-title">
              <span>${weekLabel(w)}</span>
              <span class="count-badge" data-week-count="${w}">0</span>
            </div>
            <button class="btn secondary xs" type="button" data-add-week="${w}">â• Ù…Ù‡Ù…Ø©</button>
          </div>
          <div class="col-body" style="display:grid;gap:10px"></div>
        `;
        const body = col.querySelector('.col-body');

        // render days inside week
        for(let d=0; d<6; d++){
          const dayBox = document.createElement('div');
          dayBox.className='day';
          dayBox.innerHTML = `
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
              <b>${DAYS_AR[d]}</b>
              <button class="btn ghost xs" type="button" data-add-day="${w}:${d}">â•</button>
            </div>
            <div class="dash-tasks" data-day-list="${w}:${d}" style="margin-top:8px"></div>
          `;
          body.appendChild(dayBox);
        }

        // wire add week: default day = Ø§Ù„Ø³Ø¨Øª (0)
        col.querySelector('[data-add-week]')?.addEventListener('click', ()=> openDailyTaskModal('create', {year, monthNumber, weekIdx:w, dayIdx:0}));
        col.querySelectorAll('[data-add-day]')?.forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const [ww,dd] = String(btn.getAttribute('data-add-day')).split(':').map(x=>parseInt(x,10));
            openDailyTaskModal('create', {year, monthNumber, weekIdx:ww, dayIdx:dd});
          });
        });

        root.appendChild(col);
      }

      // place tasks
      let weekCounts=[0,0,0,0];
      (tasks||[]).forEach(t=>{
        const w = parseInt(t.weekIdx,10);
        const d = parseInt(t.dayIdx,10);
        if(!(w>=0 && w<4 && d>=0 && d<6)) return;
        weekCounts[w]++;
        const list = root.querySelector(`[data-day-list="${w}:${d}"]`);
        if(!list) return;

        const done = isTaskDone(t) || String(t.status||'')==='done';
        const row = document.createElement('div');
        row.className='dash-task';
        row.style.cursor='pointer';
        row.innerHTML = `
          <div>
            <div class="t-title">${escapeHtml(t.title||'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†')}</div>
            <div class="t-sub">${escapeHtml(t.description||'')}</div>
          </div>
          <button class="btn ${done?'secondary':'sm'} xs" type="button" data-toggle="1">${done?'âœ… ØªÙ…':'â³ Ø¥Ù†Ù‡Ø§Ø¡'}</button>
        `;
        // click card to edit
        row.addEventListener('click', (e)=>{
          if(e.target?.closest('[data-toggle]')) return;
          openDailyTaskModal('edit', {task:t});
        });
        row.querySelector('[data-toggle]')?.addEventListener('click', async (e)=>{
          e.stopPropagation();
          try{
            await updateDoc(doc(db,'daily_tasks', t.id), {
              status: done ? 'pending' : 'done',
              updatedAt: serverTimestamp(),
              doneAt: done ? null : serverTimestamp()
            });
            // reload
            loadDaily();
          }catch(err){
            console.warn(err);
            toast('âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«');
          }
        });
        list.appendChild(row);
      });

      // update badges
      weekCounts.forEach((c,idx)=>{
        const b = root.querySelector(`[data-week-count="${idx}"]`);
        if(b) b.textContent = String(c);
      });
    }

    // Daily Task Modal handlers
    const dailyTaskModal = document.getElementById('dailyTaskModal');

    function openDailyTaskModal(mode, payload){
      if(!dailyTaskModal) return;
      const idEl = document.getElementById('dailyTaskId');
      const wEl  = document.getElementById('dailyWeekIdx');
      const dEl  = document.getElementById('dailyDayIdx');

      const titleEl = document.getElementById('dailyTitle');
      const descEl  = document.getElementById('dailyDesc');
      const stEl    = document.getElementById('dailyStatus');
      const notesEl = document.getElementById('dailyNotes');
      const delBtn  = document.getElementById('dailyDelete');

      if(mode==='create'){
        const {year, monthNumber, weekIdx, dayIdx} = payload || {};
        idEl.value='';
        wEl.value=String(weekIdx??0);
        dEl.value=String(dayIdx??0);
        titleEl.value='';
        descEl.value='';
        stEl.value='pending';
        if(notesEl) notesEl.innerHTML='';
        delBtn.style.display='none';
        document.getElementById('dailyTaskModalTitle').textContent='Ù…Ù‡Ù…Ø© ÙŠÙˆÙ…ÙŠØ©';
        dailyTaskModal.style.display='flex';
        // store current year/month on modal dataset
        dailyTaskModal.dataset.year = String(year);
        dailyTaskModal.dataset.month = String(monthNumber);
      }else{
        const t = payload?.task;
        if(!t) return;
        idEl.value=t.id;
        wEl.value=String(t.weekIdx??0);
        dEl.value=String(t.dayIdx??0);
        titleEl.value=t.title||'';
        descEl.value=t.description||'';
        stEl.value=String(t.status||'pending');
        if(notesEl) notesEl.innerHTML = t.notesHtml || '';
        delBtn.style.display='';
        document.getElementById('dailyTaskModalTitle').textContent='ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù…Ø©';
        dailyTaskModal.style.display='flex';
        dailyTaskModal.dataset.year = String(t.year||'');
        dailyTaskModal.dataset.month = String(t.month||'');
      }
    }

    function closeDailyTaskModal(){
      if(dailyTaskModal) dailyTaskModal.style.display='none';
    }

    document.getElementById('dailyTaskModalClose')?.addEventListener('click', closeDailyTaskModal);
    document.getElementById('dailyCancel')?.addEventListener('click', closeDailyTaskModal);
    dailyTaskModal?.addEventListener('click', (e)=>{ if(e.target===dailyTaskModal) closeDailyTaskModal(); });

    document.getElementById('dailySave')?.addEventListener('click', async ()=>{
      try{
        const id = String(document.getElementById('dailyTaskId')?.value||'');
        const w  = parseInt(String(document.getElementById('dailyWeekIdx')?.value||'0'),10);
        const d  = parseInt(String(document.getElementById('dailyDayIdx')?.value||'0'),10);
        const title = String(document.getElementById('dailyTitle')?.value||'').trim();
        const description = String(document.getElementById('dailyDesc')?.value||'').trim();
        const status = String(document.getElementById('dailyStatus')?.value||'pending');
        const notesHtml = String(document.getElementById('dailyNotes')?.innerHTML||'');

        const year = parseInt(String(dailyTaskModal?.dataset.year||document.getElementById('dailyYear')?.value||''),10);
        const month = parseInt(String(dailyTaskModal?.dataset.month||document.getElementById('dailyMonth')?.value||''),10);
        const ym = `${year}-${String(month).padStart(2,'0')}`;

        if(!title){ toast('Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©'); return; }

        const payload = {
          title,
          description,
          notesHtml,
          status,
          weekIdx: w,
          dayIdx: d,
          year,
          month,
          ym,
          updatedAt: serverTimestamp()
        };

        if(id){
          await updateDoc(doc(db,'daily_tasks', id), payload);
        }else{
          await addDoc(collection(db,'daily_tasks'), {
            ...payload,
            createdAt: serverTimestamp(),
            createdBy: CURRENT_USER?.uid || null
          });
        }

        closeDailyTaskModal();
        loadDaily();
        toast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
      }catch(err){
        console.warn(err);
        toast('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ (ØªØ­Ù‚Ù‚ Ù…Ù† Rules)');
      }
    });

    document.getElementById('dailyDelete')?.addEventListener('click', async ()=>{
      const id = String(document.getElementById('dailyTaskId')?.value||'');
      if(!id) return;
      if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) return;
      try{
        await deleteDoc(doc(db,'daily_tasks', id));
        closeDailyTaskModal();
        loadDaily();
        toast('ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù');
      }catch(err){
        console.warn(err);
        toast('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
      }
    });

    // Daily Text Editor (per month)
    function openDailyEditor(){
      const y = parseInt(String(document.getElementById('dailyYear')?.value||''),10);
      const m = parseInt(String(document.getElementById('dailyMonth')?.value||''),10);
      if(!y || !m) return toast('Ø§Ø®ØªØ§Ø± Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ø´Ù‡Ø±');
      const ym = `${y}-${String(m).padStart(2,'0')}`;
      openRteModal({
        title: `Ù…Ø­Ø±Ø± Ù†ØµÙˆØµ â€” ${MONTHS_AR_FULL[m-1]} ${y}`,
        docPath: ['daily_texts', ym]
      });
    }

    // Generic RTE modal (re-usable)
    const __RTE_MODAL = document.getElementById('rteModal');
    function openRteModal(opts){
      // opts: {title, docPath:[collection, docId]}
      if(!__RTE_MODAL) return;
      const titleEl = document.getElementById('rteModalTitle');
      const box = document.getElementById('rteBox');
      const saveBtn = document.getElementById('rteSave');
      const delBtn = document.getElementById('rteDelete');
      const closeBtn = document.getElementById('rteClose');

      const [col, id] = opts.docPath;
      __RTE_MODAL.dataset.col = col;
      __RTE_MODAL.dataset.id = id;
      if(titleEl) titleEl.textContent = opts.title || 'Ù…Ø­Ø±Ø± Ù†ØµÙˆØµ';
      if(box) box.innerHTML = '';

      // load existing
      (async ()=>{
        try{
          const snap = await getDoc(doc(db, col, id));
          if(snap.exists()){
            const d = snap.data()||{};
            if(box) box.innerHTML = d.html || '';
          }
        }catch(e){ console.warn(e); }
      })();

      // wire toolbar once
      if(!__RTE_MODAL.dataset.wired){
        __RTE_MODAL.dataset.wired = '1';

        const fontSel = document.getElementById('rteFont');
        const sizeSel = document.getElementById('rteSize');
        const colorEl = document.getElementById('rteColor');

        document.querySelectorAll('[data-rte]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const cmd = btn.getAttribute('data-rte');
            if(cmd==='bold') document.execCommand('bold');
            else if(cmd==='italic') document.execCommand('italic');
            else if(cmd==='underline') document.execCommand('underline');
            else if(cmd==='ul') document.execCommand('insertUnorderedList');
            else if(cmd==='ol') document.execCommand('insertOrderedList');
            else if(cmd==='clear') document.execCommand('removeFormat');
          });
        });

        fontSel?.addEventListener('change', ()=>{
          const v = fontSel.value;
          if(v) document.execCommand('fontName', false, v);
        });
        sizeSel?.addEventListener('change', ()=>{
          const v = sizeSel.value;
          if(v) document.execCommand('fontSize', false, v);
        });
        colorEl?.addEventListener('input', ()=>{
          const v = colorEl.value;
          if(v) document.execCommand('foreColor', false, v);
        });

        closeBtn?.addEventListener('click', ()=>{ __RTE_MODAL.style.display='none'; });
        __RTE_MODAL.addEventListener('click', (e)=>{ if(e.target===__RTE_MODAL) __RTE_MODAL.style.display='none'; });

        saveBtn?.addEventListener('click', async ()=>{
          const col = __RTE_MODAL.dataset.col;
          const id = __RTE_MODAL.dataset.id;
          try{
            await setDoc(doc(db, col, id), {
              html: String(box?.innerHTML||''),
              updatedAt: serverTimestamp(),
              updatedBy: CURRENT_USER?.uid || null
            }, {merge:true});
            toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Øµ');
          }catch(e){
            console.warn(e);
            toast('âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù†Øµ');
          }
        });

        delBtn?.addEventListener('click', async ()=>{
          const col = __RTE_MODAL.dataset.col;
          const id = __RTE_MODAL.dataset.id;
          if(!confirm('Ø­Ø°Ù Ø§Ù„Ù†ØµØŸ')) return;
          try{
            await deleteDoc(doc(db, col, id));
            if(box) box.innerHTML='';
            toast('ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù');
          }catch(e){
            console.warn(e);
            toast('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
          }
        });
      }

      __RTE_MODAL.style.display='flex';
      // focus
      setTimeout(()=>{ try{ box?.focus(); }catch(e){} }, 50);
    }

    // ===== Stock Aggregation (SpecKey) + Tasks Meta (Workspace DB) =====
    let STOCK_TASKS_MAP = new Map();
    let STOCK_TASKS_LOADED = false;

    const MONTHS_AR = [
      "ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ",
      "ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"
    ];

    function stockTaskDocId(specKey){
      // Firestore doc ids cannot contain '/'
      return encodeURIComponent(String(specKey||""));
    }

    async function loadStockTasksOnce(){
      if(STOCK_TASKS_LOADED) return;
      STOCK_TASKS_LOADED = true;
      STOCK_TASKS_MAP = new Map();
      try{
        const snap = await getDocs(collection(db, "stock_tasks"));
        snap.forEach(d=>{
          const v = d.data() || {};
          const k = v.specKey || decodeURIComponent(d.id);
          if(k) STOCK_TASKS_MAP.set(String(k), { ...v, _id: d.id });
        });
      }catch(e){
        console.warn('loadStockTasksOnce', e);
      }finally{
        // Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ù…Ù‡Ø§Ù… Ø§Ù„Ø§Ø³ØªÙˆÙƒØŒ Ø·Ø¨Ù‚ ÙÙ„ØªØ± "ØºÙŠØ± Ù…Ø¹Ù…ÙˆÙ„ Ù„Ù‡Ø§ Ù…ÙˆÙ†ØªØ§Ø¬" Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø§ØªØ§ Ù„ÙŠØ³Øª
        try{ applySpecKeyNotMontagedFilter(); }catch(_e){}
      }
    }

    let stockSaveTimers = new Map();
    function scheduleSaveStockTask(specKey, patch){
      const key = String(specKey||"");
      if(!key) return;
      const prev = STOCK_TASKS_MAP.get(key) || { specKey: key };
      const next = { ...prev, ...patch, specKey: key, updatedAt: serverTimestamp() };
      STOCK_TASKS_MAP.set(key, next);
      // Ø­Ø¯Ø« Ø§Ù„Ø¯Ø§ØªØ§ Ù„ÙŠØ³Øª ÙÙˆØ±Ù‹Ø§ (Ù„Ø£Ù†Ù†Ø§ Ø¨Ù†ÙÙ„ØªØ± "ØºÙŠØ± Ù…Ø¹Ù…ÙˆÙ„ Ù„Ù‡Ø§ Ù…ÙˆÙ†ØªØ§Ø¬")
      try{ applySpecKeyNotMontagedFilter(); }catch(_e){}

      // debounce per row
      if(stockSaveTimers.has(key)) clearTimeout(stockSaveTimers.get(key));
      stockSaveTimers.set(key, setTimeout(async ()=>{
        try{
          await setDoc(doc(db, "stock_tasks", stockTaskDocId(key)), next, { merge:true });
        }catch(e){
          console.warn('saveStockTask', e);
        }
      }, 350));
    }

    function ynSelect(value=""){
      const v = String(value||"");
      const y = v === "Ù†Ø¹Ù…" ? "selected" : "";
      const n = v === "Ù„Ø§" ? "selected" : "";
      return `<select class="stock-ctrl small" data-type="yn"><option value="">â€”</option><option value="Ù†Ø¹Ù…" ${y}>Ù†Ø¹Ù…</option><option value="Ù„Ø§" ${n}>Ù„Ø§</option></select>`;
    }

    function montageDetailsSelect(value=""){
      const v = String(value||"");
      const a = v === "ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª" ? "selected" : "";
      const b = v === "ØµÙˆØ± ÙÙ‚Ø·" ? "selected" : "";
      return `<select class="stock-ctrl small" data-type="montageDetails"><option value="">â€”</option><option value="ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª" ${a}>ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª</option><option value="ØµÙˆØ± ÙÙ‚Ø·" ${b}>ØµÙˆØ± ÙÙ‚Ø·</option></select>`;
    }

    function monthSelect(value=""){
      const v = String(value||"");
      return `<select class="stock-ctrl small" data-type="month"><option value="">â€”</option>${MONTHS_AR.map(m=>`<option value="${escapeAttr(m)}" ${(m===v)?'selected':''}>${escapeHtml(m)}</option>`).join('')}</select>`;
    }

    function yearInput(value=""){
      const v = String(value||"");
      return `<input class="stock-ctrl small" data-type="year" inputmode="numeric" placeholder="Ø§Ù„Ø³Ù†Ø©" value="${escapeAttr(v)}" />`;
    }

    async function renderStockTab(){
      const emptyEl = $("stockEmpty");
      const wrapEl  = $("stockTableWrap");
      const tableEl = $("stockTable");
      const searchEl = document.getElementById('stockSearch');

      const arr = Array.isArray(AGENDA_STOCK) ? AGENDA_STOCK : [];
      // ÙÙ„ØªØ± stock (Ø¨Ø¯ÙˆÙ† Ø§Ù„ÙˆÙƒØ§Ù„Ø© + Ø¨Ø¯ÙˆÙ† Ù…Ø¨Ø§Ø¹ ØªØ­Øª/ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…)
      const filtered = arr.filter(r => !isExcludedByInventoryFilter(r));

      // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Unique Spec Key (Ø¨Ø¯ÙˆÙ† Ø£Ù„ÙˆØ§Ù†)
      const groups = new Map();
      for(const r of filtered){
        const key = buildSpecKeyNoColors({
          car: r.car ?? r["Ø§Ù„Ø³ÙŠØ§Ø±Ø©"],
          variant: r.variant ?? r["Ø§Ù„Ø¨ÙŠØ§Ù†"],
          modelYear: r.modelYear ?? r["Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„"],
        });
        if(!key || key === "- | - | -") continue;
        const g = groups.get(key) || { specKey:key, count:0 };
        g.count += 1;
        groups.set(key, g);
      }

      let rows = Array.from(groups.values());

      // Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ SpecKey
      const q = normalizeArabicText(searchEl?.value || "");
      if(q){
        rows = rows.filter(r => normalizeArabicText(r.specKey).includes(q));
      }

      // ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠ
      rows.sort((a,b)=> a.specKey.localeCompare(b.specKey,'ar',{numeric:true,sensitivity:'base'}));

      $("stockCount").textContent = rows.reduce((s,r)=> s + (r.count||0), 0);

      if(!rows.length){
        emptyEl.style.display = "";
        wrapEl.style.display = "none";
        tableEl.innerHTML = "";
        return;
      }

      emptyEl.style.display = "none";
      wrapEl.style.display = "";

      // Ø­Ù…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
      await loadStockTasksOnce();

      const months = [
        "ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ",
        "ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"
      ];

      const yesNoOptions = (val)=>
        `
          <option value="" ${!val?'selected':''}>-</option>
          <option value="Ù†Ø¹Ù…" ${val==='Ù†Ø¹Ù…'?'selected':''}>Ù†Ø¹Ù…</option>
          <option value="Ù„Ø§" ${val==='Ù„Ø§'?'selected':''}>Ù„Ø§</option>`;

      const montageDetailsOptions = (val)=>
        `
          <option value="" ${!val?'selected':''}>-</option>
          <option value="ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª: Ù†Ø¹Ù…" ${val==='ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª: Ù†Ø¹Ù…'?'selected':''}>ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª: Ù†Ø¹Ù…</option>
          <option value="ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª: Ù„Ø§" ${val==='ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª: Ù„Ø§'?'selected':''}>ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª: Ù„Ø§</option>`;

      const cols = [
        {k:'idx',  label:'Ù…', w:70},
        {k:'spec', label:'Unique Spec Key (Ø§Ù„Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®)', w:520},
        {k:'count',label:'Ø§Ù„Ø¹Ø¯Ø¯', w:90},
        {k:'photo',label:'ØªØµÙˆÙŠØ±', w:140},
        {k:'montage',label:'Ù…ÙˆÙ†ØªØ§Ø¬', w:140},
        {k:'montageDetails',label:'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ†ØªØ§Ø¬', w:240},
        {k:'inAgenda',label:'Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©', w:170},
        {k:'agendaMonth',label:'Ø§Ù„Ø´Ù‡Ø±', w:160},
        {k:'agendaYear',label:'Ø§Ù„Ø³Ù†Ø©', w:120},
      ];

      const colgroup = `<colgroup>${cols.map(c=>`<col style="width:${c.w}px">`).join('')}</colgroup>`;
      const thead = `<thead><tr>${cols.map(c=>`<th>${escapeHtml(c.label)}</th>`).join('')}</tr></thead>`;



      // Prepare rows for Excel export (merge saved controls)
      __LAST_STOCK_ROWS = rows.map(r=>{
        const saved = STOCK_TASKS_MAP.get(r.specKey) || {};
        return {
          specKey: r.specKey,
          count: r.count || 0,
          photo: saved.photo || '',
          montage: saved.montage || '',
          montageDetails: saved.montageDetails || '',
          inAgenda: saved.inAgenda || '',
          agendaMonth: saved.agendaMonth || '',
          agendaYear: saved.agendaYear || ''
        };
      });
      const tbody = `<tbody>${rows.map((r,i)=>{
        const specKey = r.specKey;
        const saved = STOCK_TASKS_MAP.get(specKey) || {};
        const photo = saved.photo || '';
        const montage = saved.montage || '';
        const montageDetails = saved.montageDetails || '';
        const inAgenda = saved.inAgenda || '';
        const agendaMonth = saved.agendaMonth || '';
        const agendaYear = saved.agendaYear || '';

        const montageDisabled = montage !== 'Ù†Ø¹Ù…';
        const agendaDisabled = inAgenda !== 'Ù†Ø¹Ù…';

        return `
          <tr data-spec="${escapeAttr(specKey)}">
            <td class="center">${i+1}</td>
            <td class="wrap">
              <button type="button" class="btn secondary xs" data-copy="1" style="width:100%;justify-content:space-between;gap:8px">
                <span style="text-align:right;white-space:normal;line-height:1.6">${escapeHtml(specKey)}</span>
                <span class="stock-badge-mini">Ù†Ø³Ø®</span>
              </button>
            </td>
            <td class="center">
              <button type="button" class="btn secondary xs stock-count-btn" data-show-colors="1" title="Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù„ÙˆØ§Ù†" style="min-width:44px;justify-content:center">
                <span class="stock-badge-mini stock-count">${r.count}</span>
              </button>
            </td>
            <td>
              <select class="stock-ctrl" data-field="photo">${yesNoOptions(photo)}</select>
            </td>
            <td>
              <select class="stock-ctrl" data-field="montage">${yesNoOptions(montage)}</select>
            </td>
            <td>
              <select class="stock-ctrl" data-field="montageDetails" ${montageDisabled ? 'disabled' : ''}>
                ${montageDetailsOptions(montageDetails)}
              </select>
            </td>
            <td>
              <select class="stock-ctrl" data-field="inAgenda">${yesNoOptions(inAgenda)}</select>
            </td>
            <td>
              <select class="stock-ctrl" data-field="agendaMonth" ${agendaDisabled ? 'disabled' : ''}>
                <option value="" ${!agendaMonth?'selected':''}>-</option>
                ${months.map(m=>`<option value="${escapeAttr(m)}" ${agendaMonth===m?'selected':''}>${escapeHtml(m)}</option>`).join('')}
              </select>
            </td>
            <td>
              <input class="stock-ctrl small" data-field="agendaYear" type="number" min="2000" max="2100" placeholder="YYYY" value="${escapeAttr(agendaYear)}" ${agendaDisabled ? 'disabled' : ''}/>
            </td>
          </tr>`;
      }).join('')}</tbody>`;

      tableEl.innerHTML = colgroup + thead + tbody;

      // Delegation: copy + save
      tableEl.onclick = (ev)=>{
        const tr = ev.target.closest('tr');
        const key = tr?.getAttribute('data-spec') || '';

        const copyBtn = ev.target.closest('[data-copy]');
        if(copyBtn){
          if(key){
            navigator.clipboard.writeText(key).then(()=> toast('ØªÙ… Ø§Ù„Ù†Ø³Ø®')).catch(()=> toast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ø³Ø®'));
          }
          return;
        }

        const colorsBtn = ev.target.closest('[data-show-colors]');
        if(colorsBtn){
          if(key) openColorsModal(key);
          return;
        }
      };

      tableEl.onchange = (ev)=>{
        const el = ev.target;
        if(!(el instanceof HTMLSelectElement)) return;
        const tr = el.closest('tr');
        const key = tr?.getAttribute('data-spec') || '';
        const field = el.getAttribute('data-field');
        if(!key || !field) return;

        const value = el.value || '';
        scheduleSaveStockTask(key, { [field]: value });

        // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø¨Ø¹Ø©
        if(field === 'montage'){
          const md = tr.querySelector('[data-field="montageDetails"]');
          if(md){
            md.disabled = (value !== 'Ù†Ø¹Ù…');
            if(md.disabled){
              md.value = '';
              scheduleSaveStockTask(key, { montageDetails: '' });
            }
          }
        }
        if(field === 'inAgenda'){
          const m = tr.querySelector('[data-field="agendaMonth"]');
          const y = tr.querySelector('[data-field="agendaYear"]');
          const dis = (value !== 'Ù†Ø¹Ù…');
          if(m){
            m.disabled = dis;
            if(dis){ m.value=''; scheduleSaveStockTask(key,{agendaMonth:''}); }
          }
          if(y){
            y.disabled = dis;
            if(dis){ y.value=''; scheduleSaveStockTask(key,{agendaYear:''}); }
          }
        }
      };

      tableEl.oninput = (ev)=>{
        const el = ev.target;
        if(!(el instanceof HTMLInputElement)) return;
        const tr = el.closest('tr');
        const key = tr?.getAttribute('data-spec') || '';
        const field = el.getAttribute('data-field');
        if(!key || field !== 'agendaYear') return;
        const v = String(el.value || '').trim();
        scheduleSaveStockTask(key, { agendaYear: v });
      };
    }

    function openHome(){
      MODE="home"; LIST_TYPE=null; CURRENT_WORKSPACE=null;
      saveLastView("home");
      if(unsubWorkspaces){unsubWorkspaces();unsubWorkspaces=null;}
      if(unsubTasks){unsubTasks();unsubTasks=null;}

      setNavActive("navHome");
      $("pageTitle").textContent = "Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯";
      $("pageDesc").textContent = "";
      $("btnBack").style.display="none";
      $("btnCreateAgenda").style.display="";
      $("btnCreateCampaign").style.display="";
      $("homeMeta").textContent = "Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (mzj-workspace-c7d4e)";
      showView("home");
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ)
      try{ renderDashboardHome(); }catch(e){ console.warn(e); }
      renderDashboardForCurrentMonth();
    }

    $("btnRefresh").addEventListener("click", ()=> { if(LIST_TYPE) openList(LIST_TYPE); });

    // Board filter (agenda): show tasks for selected user
    $("boardUserFilter").addEventListener("change", (e)=>{
      BOARD_USER_FILTER_UID = String(e.target.value||"");
      if(MODE==="board" && CURRENT_WORKSPACE){
        renderBoardColumns(CURRENT_WORKSPACE, applyBoardUserFilter(BOARD_TASKS_ALL));
      }
    });

    function openList(type){
      MODE = type==="agenda" ? "agendas" : "campaigns";
      saveLastView("list", {type});
      LIST_TYPE = type;
      CURRENT_WORKSPACE = null;
      if(unsubTasks){unsubTasks();unsubTasks=null;}

      setNavActive(type==="agenda" ? "navAgendas" : "navCampaigns");

      $("btnBack").style.display="";
      $("btnCreateAgenda").style.display = type==="agenda" ? "" : "none";
      $("btnCreateCampaign").style.display = type==="campaign" ? "" : "none";

      $("pageTitle").textContent = type==="agenda" ? "Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª" : "Ø§Ù„Ø­Ù…Ù„Ø§Øª";
      $("pageDesc").textContent  = type==="agenda"
        ? "Ø§Ø®ØªØ± Ø£Ø¬Ù†Ø¯Ø© Ø£Ùˆ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©. Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø³ØªØ¬Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØªØ¶ÙŠÙ ØªØ§Ø³ÙƒØ§Øª Ø¨Ø³Ù‡ÙˆÙ„Ø©."
        : "Ø§Ø®ØªØ± Ø­Ù…Ù„Ø© Ø£Ùˆ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ ÙˆØµÙ + ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ©/Ù†Ù‡Ø§ÙŠØ© + Ø£Ø¹Ù…Ø¯Ø©.";

      $("listTitle").textContent = type==="agenda" ? "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª" : "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ù…Ù„Ø§Øª";

      showView("list");
      listenWorkspaces(type);
    }

    function listenWorkspaces(type){
      if(unsubWorkspaces){unsubWorkspaces();unsubWorkspaces=null;}

      const qy = query(
        collection(db,"workspaces"),
        where("type","==", type)
      );
unsubWorkspaces = onSnapshot(qy, (snap)=>{
        let items=[];
        snap.forEach(d=> items.push({ id:d.id, ...(d.data()||{}) }));
        // ØªØµÙÙŠØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·Ø© + ØªØ±ØªÙŠØ¨ Ù…Ø­Ù„ÙŠ Ù„ØªÙØ§Ø¯ÙŠ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù€ Composite Index
        items = items.filter(x=> x.active !== false);
        items.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
        renderList(type, items);
      }, (err)=>{
        console.error(err);
        toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©");
      });
    }

    function renderList(type, items){
      const container = $("listContainer");
      const empty = $("listEmpty");
      container.innerHTML = "";
      empty.style.display = items.length ? "none" : "";

      items.forEach(x=>{
        const el = document.createElement("div");
        el.className = "list-item";

        const columnsCount = Array.isArray(x.columns) ? x.columns.length : 0;
        let sub = "";
        if(type==="agenda"){
          sub = `Ø£Ø¹Ù…Ø¯Ø©: ${columnsCount}`;
        }else{
          const s = x.startDate || "â€”";
          const e = x.endDate || "â€”";
          sub = `Ø§Ù„ÙØªØ±Ø©: ${s} â†’ ${e} | Ø£Ø¹Ù…Ø¯Ø©: ${columnsCount}`;
        }

        const desc = type==="campaign" ? (x.description||"") : "";
        el.innerHTML = `
          <div class="li-main">
            <p class="li-title">${escapeHtml(x.name||"Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")}</p>
            <p class="li-sub">${escapeHtml(desc ? (desc + " â€” " + sub) : sub)}</p>
          </div>
          <div class="li-right">
            <span class="tag"><span class="mini"></span>${type==="agenda"?"Agenda":"Campaign"}</span>
            <button class="btn sm secondary" data-open="1" type="button">ÙØªØ­</button>
          </div>
        `;

        el.querySelector('[data-open="1"]').addEventListener("click", (e)=>{
          e.stopPropagation();
          openBoard(x);
        });

        el.addEventListener("click", ()=> openBoard(x));
        container.appendChild(el);
      });
    }

    function openBoard(workspace){
      MODE="board";
      CURRENT_WORKSPACE = workspace;
      saveLastView("board", {workspaceId: workspace.id});

      $("btnBack").style.display="";
      $("btnCreateAgenda").style.display="none";
      $("btnCreateCampaign").style.display="none";

      $("pageTitle").textContent = workspace.type==="agenda" ? "Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©" : "Ù„ÙˆØ­Ø© Ø§Ù„Ø­Ù…Ù„Ø©";
      $("pageDesc").textContent  = "Ø§Ø¶ØºØ· â• Ø¯Ø§Ø®Ù„ Ø£ÙŠ Ø¹Ù…ÙˆØ¯ Ù„Ø¥Ø¶Ø§ÙØ© ØªØ§Ø³Ùƒ. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø³Ùƒ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø£Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.";

      $("boardTitle").textContent = workspace.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
      if(workspace.type==="campaign"){
        const s = workspace.startDate || "â€”";
        const e = workspace.endDate || "â€”";
        const d = workspace.description ? workspace.description : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ";
        $("boardSub").textContent = `Ø§Ù„ÙØªØ±Ø©: ${s} â†’ ${e} | ${d}`;
      }else{
        $("boardSub").textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: ${(workspace.columns||[]).length}`;
      }

      // Agenda-only: filter tasks by assignee
      const bfWrap = $("boardFilterWrap");
      const bfSel = $("boardUserFilter");
      if(workspace.type === "agenda"){
        bfWrap.style.display = "";
        // rebuild options each time (users may update)
        const cur = BOARD_USER_FILTER_UID || "";
        bfSel.innerHTML = `<option value="">Ø§Ù„ÙƒÙ„</option>`;
        USERS.slice().sort((a,b)=>(a.name||"").localeCompare(b.name||"","ar")).forEach(u=>{
          const opt = document.createElement("option");
          opt.value = u.uid;
          opt.textContent = u.name;
          bfSel.appendChild(opt);
        });
        bfSel.value = cur;
      }else{
        bfWrap.style.display = "none";
        BOARD_USER_FILTER_UID = "";
      }

      // show VIN for the selected spec key
      
      showView("board");

      $("btnEditBoard").onclick = ()=> openBoardModal(workspace.type, "edit", workspace);
      $("btnDeleteBoard").onclick = ()=> deleteWorkspace(workspace);

      renderBoardColumns(workspace, []);
      listenTasksForWorkspace(workspace.id);
    }

    function applyBoardUserFilter(tasks){
      const arr = Array.isArray(tasks)?tasks:[];
      if(!CURRENT_WORKSPACE || CURRENT_WORKSPACE.type!=="agenda") return arr;
      const uid = String(BOARD_USER_FILTER_UID||"");
      if(!uid) return arr;
      return arr.filter(t=> String(t.assigneeUid||"") === uid);
    }

    function renderBoardColumns(workspace, tasks){
      const colsEl = $("boardCols");
      colsEl.innerHTML = "";

      const cols = Array.isArray(workspace.columns) && workspace.columns.length ? workspace.columns : ["Ù‚Ø§Ø¦Ù…Ø©"];
      const byCol = {};
      cols.forEach(c=> byCol[c]=[]);
      tasks.forEach(t=>{
        const c = t.column || cols[0];
        if(!byCol[c]) byCol[c]=[];
        byCol[c].push(t);
      });

      cols.forEach(colName=>{
        const col = document.createElement("section");
        col.className = "col";
        if(String(colName||'').includes('ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡')) col.classList.add('done-col');
        if(/ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡/.test(colName)) col.classList.add("done-col");

        const list = byCol[colName] || [];
        const head = document.createElement("div");
        head.className = "col-head";
        head.innerHTML = `
          <div class="col-title">
            <span>${escapeHtml(colName)}</span>
            <span class="count-badge">${list.length}</span>
          </div>
          <button class="btn secondary xs" type="button">â• ØªØ§Ø³Ùƒ</button>
        `;
        head.querySelector("button").addEventListener("click", (e)=>{
          e.stopPropagation();
          openTaskModal("create", { workspace, column: colName });
        });

        const body = document.createElement("div");
        body.className = "col-body";

        if(!list.length){
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.style.fontSize = "12px";
          empty.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ§Ø³ÙƒØ§Øª Ù‡Ù†Ø§. Ø§Ø¶ØºØ· â• Ù„Ø¥Ø¶Ø§ÙØ© ØªØ§Ø³Ùƒ.";
          body.appendChild(empty);
        }else{
          list.slice().sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)).forEach(t=>{
            const card = document.createElement("div");
            card.className = "task-card";

            const assignee = t.assigneeName || "â€”";
            const due = t.due || "â€”";
            const specKey = t.specKey || "â€”";

            card.innerHTML = `
              <p class="t-title">${escapeHtml(specKey)}</p>
              <div class="t-meta">
                <span class="badge"><span class="dot"></span>${escapeHtml(assignee)}</span>
                <span class="badge" style="background:#fff;border-color:rgba(62,36,32,.10)"><span class="dot" style="background:#6b7280"></span>ğŸ“… ${escapeHtml(due)}</span>
              </div>
            `;

            card.addEventListener("click", ()=> openTaskDetail(t));
            body.appendChild(card);
          });
        }

        col.appendChild(head);
        col.appendChild(body);
        colsEl.appendChild(col);
      });
    }

    function listenTasksForWorkspace(workspaceId){
      if(unsubTasks){unsubTasks();unsubTasks=null;}
      // Ù…Ù„Ø§Ø­Ø¸Ø©: where + orderBy ÙŠØ­ØªØ§Ø¬ Composite IndexØŒ ÙÙ‡Ù†Ø³Ø­Ø¨ Ø¨Ø¯ÙˆÙ† orderBy ÙˆÙ†Ø±ØªÙ‘Ø¨ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ù€ Index
      const qy = query(
        collection(db,"workspace_tasks"),
        where("workspaceId","==", workspaceId)
      );
      unsubTasks = onSnapshot(qy, (snap)=>{
        let tasks=[];
        snap.forEach(d=> tasks.push({ id:d.id, ...(d.data()||{}) }));
        // ØªØ±ØªÙŠØ¨ Ù…Ø­Ù„ÙŠ Ø¨Ø§Ù„Ø£Ø­Ø¯Ø« (createdAt)
        tasks.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
        BOARD_TASKS_ALL = tasks;
        renderBoardColumns(CURRENT_WORKSPACE, applyBoardUserFilter(tasks));
      }, (err)=>{
        console.error(err);
        const msg = (err?.code ? (err.code + " â€” ") : "") + (err?.message || "");
        toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ§Ø³ÙƒØ§Øª: " + (msg || "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª/Rules"));
      });
    }

    // Board modal
    const boardModal = $("boardModal");
    const boardType = $("boardType");
    const boardName = $("boardName");
    const campaignFields = $("campaignFields");
    const campaignDesc = $("campaignDesc");
    const campaignStart = $("campaignStart");
    const campaignEnd = $("campaignEnd");
    const colInput = $("colInput");
    const colsChips = $("colsChips");

    let BOARD_MODAL_MODE = "create";
    let BOARD_MODAL_TYPE = "agenda";
    let BOARD_EDIT_ID = null;
    let COLUMNS_TMP = [];

    const DEFAULT_AGENDA_COLS = ["Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª","Ø±ÙŠÙ„ Ù‚ØµÙŠØ±","ØªØµÙ…ÙŠÙ… ØµÙˆØ±","ÙŠÙˆØªÙŠÙˆØ¨","ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"];
    const DEFAULT_CAMPAIGN_COLS = ["Ø±ÙŠÙ„Ø² - ÙƒØ§Ø´","Ù…ÙˆØ´Ù† - ÙƒØ§Ø´","Ø¬Ø±Ø§ÙÙŠÙƒ - ÙƒØ§Ø´","Ø±ÙŠÙ„Ø² Ø§Ù‚Ø³Ø§Ø·","Ai Ø§Ù‚Ø³Ø§Ø·","Ø¬Ø±Ø§ÙÙŠÙƒ - Ø§Ù‚Ø³Ø§Ø·","Ø´Ø±ÙƒØ§Øª - Ù„ÙŠÙ†ÙƒØ¯ Ø§Ù†"];

    $("boardModalClose").addEventListener("click", ()=> closeBoardModal());
    $("boardCancel").addEventListener("click", ()=> closeBoardModal());
    boardModal.addEventListener("click", (e)=> { if(e.target===boardModal) closeBoardModal(); });

    $("btnAddCol").addEventListener("click", ()=>{
      const v = (colInput.value||"").trim();
      if(!v) return;
      addCol(v);
      colInput.value="";
    });
    $("btnAddDefaults").addEventListener("click", ()=>{
      const defs = BOARD_MODAL_TYPE==="agenda" ? DEFAULT_AGENDA_COLS : DEFAULT_CAMPAIGN_COLS;
      defs.forEach(addCol);
    });

    function addCol(name){
      const v = (name||"").trim();
      if(!v) return;
      if(COLUMNS_TMP.includes(v)) return;
      COLUMNS_TMP.push(v);
      renderColChips();
    }
    function removeCol(name){
      COLUMNS_TMP = COLUMNS_TMP.filter(x=> x!==name);
      renderColChips();
    }
    function renderColChips(){
      colsChips.innerHTML = "";
      if(!COLUMNS_TMP.length){
        colsChips.innerHTML = `<div class="empty" style="padding:10px;font-size:12px">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø¹Ø¯.</div>`;
        return;
      }
      COLUMNS_TMP.forEach(c=>{
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.innerHTML = `${escapeHtml(c)} <button type="button" title="Ø­Ø°Ù">âœ•</button>`;
        chip.querySelector("button").addEventListener("click", ()=> removeCol(c));
        colsChips.appendChild(chip);
      });
    }

    function openBoardModal(type, mode, workspace=null){
      BOARD_MODAL_TYPE = type;
      BOARD_MODAL_MODE = mode;
      BOARD_EDIT_ID = workspace?.id || null;

      boardType.value = (type==="agenda" ? "Ø£Ø¬Ù†Ø¯Ø© (Tasks)" : "Ø­Ù…Ù„Ø© (Campaign)");
      $("boardModalTitle").textContent = mode==="create"
        ? (type==="agenda" ? "Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø¬Ù†Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©" : "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©")
        : (type==="agenda" ? "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©" : "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø©");

      campaignFields.style.display = (type==="campaign") ? "" : "none";

      boardName.value = workspace?.name || "";
      campaignDesc.value = workspace?.description || "";
      campaignStart.value = workspace?.startDate || "";
      campaignEnd.value = workspace?.endDate || "";

      COLUMNS_TMP = Array.isArray(workspace?.columns) ? [...workspace.columns] : [];
      renderColChips();

      boardModal.classList.add("show");
    }

    function closeBoardModal(){
      boardModal.classList.remove("show");
      BOARD_EDIT_ID = null;
      COLUMNS_TMP = [];
      colInput.value = "";
    }

    $("boardSave").addEventListener("click", async ()=>{
      const name = (boardName.value||"").trim();
      if(!name) return toast("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©/Ø§Ù„Ø­Ù…Ù„Ø©");
      if(!COLUMNS_TMP.length) return toast("Ø£Ø¶Ù Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");

      const payload = {
        type: BOARD_MODAL_TYPE,
        name,
        columns: COLUMNS_TMP,
        active: true
      };

      if(BOARD_MODAL_TYPE==="campaign"){
        payload.description = (campaignDesc.value||"").trim() || null;
        payload.startDate = campaignStart.value || null;
        payload.endDate = campaignEnd.value || null;
      }

      try{
        if(BOARD_MODAL_MODE==="create"){
          payload.createdAt = serverTimestamp();
          payload.createdBy = CURRENT_USER?.uid || null;
          await addDoc(collection(db,"workspaces"), payload);
          toast("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ±");
        }else{
          if(!BOARD_EDIT_ID) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ID Ù„Ù„ØªØ¹Ø¯ÙŠÙ„");
          await updateDoc(doc(db,"workspaces", BOARD_EDIT_ID), payload);
          toast("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
        }
        closeBoardModal();
      }catch(err){
        console.error(err);
        const msg = (err?.code ? (err.code + " â€” ") : "") + (err?.message || "");
        toast("âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + (msg || "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Firestore Rules)"));
      }
    });

    async function deleteWorkspace(workspace){
      if(!workspace?.id) return;
      if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù (Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©/Ø§Ù„Ø­Ù…Ù„Ø©)ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù„ÙˆØ­Ø© ÙÙ‚Ø·ØŒ ÙˆØ§Ù„ØªØ§Ø³ÙƒØ§Øª Ø³ØªØ¸Ù„ (Ø¥Ù„Ø§ Ù„Ùˆ Ø·Ù„Ø¨Øª Ø­Ø°ÙÙ‡Ø§).")) return;

      try{
        await deleteDoc(doc(db,"workspaces", workspace.id));
        toast("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù");
        openList(workspace.type);
      }catch(err){
        console.error(err);
        toast("âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù");
      }
    }

    // Task modal
    const taskModal = $("taskModal");
    const taskSpecKey = $("taskSpecKey");
const taskDesc = $("taskDesc");
    // ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…
    const taskDue = $("taskDue");
    const taskAssignee = $("taskAssignee");
    const taskColumn = $("taskColumn");
    const taskLinksWrap = $("taskLinksWrap");
    const linkTitle = $("linkTitle");
    const linkUrl = $("linkUrl");
    const linksChips = $("linksChips");

    let TASK_MODE = "create";
    let TASK_CTX = null;
    let LINKS_TMP = [];

    $("taskModalClose").addEventListener("click", ()=> closeTaskModal());
    $("taskCancel").addEventListener("click", ()=> closeTaskModal());
    taskModal.addEventListener("click", (e)=> { if(e.target===taskModal) closeTaskModal(); });

    function isSpecKeyAllowed(v){
      const x = String(v||"").trim();
      if(!x) return false;
      return (SPEC_KEY_SET && SPEC_KEY_SET.has(x));
    }

    // Ù…Ù†Ø¹ ÙƒØªØ§Ø¨Ø© Spec Key Ø®Ø§Ø±Ø¬ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø­ØªÙ‰ Ù„Ùˆ ÙƒØªØ¨Ù‡Ø§ ÙŠØ¯ÙˆÙŠÙ‹Ø§)
    taskSpecKey.addEventListener("change", ()=>{
      const v = (taskSpecKey.value||"").trim();
      if(!v) return;
      // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ§Ø³Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      if(TASK_MODE!=="create" && CURRENT_TASK?.specKey && v===String(CURRENT_TASK.specKey).trim()) return;
      if(!isSpecKeyAllowed(v)){
        taskSpecKey.value = "";
        toast("Ø§Ø®ØªØ± Unique Spec Key Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙ‚Ø·");
      }
    });

    taskSpecKey.addEventListener("blur", ()=>{
      const v = (taskSpecKey.value||"").trim();
      if(!v) return;
      if(TASK_MODE!=="create" && CURRENT_TASK?.specKey && v===String(CURRENT_TASK.specKey).trim()) return;
      if(!isSpecKeyAllowed(v)){
        taskSpecKey.value = "";
        toast("Ø§Ø®ØªØ± Unique Spec Key Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙ‚Ø·");
      }
    });
    $("btnAddLink").addEventListener("click", ()=>{
      const t = (linkTitle.value||"").trim() || "Ø±Ø§Ø¨Ø·";
      const u = (linkUrl.value||"").trim();
      if(!u || !/^https?:\/\//i.test(u)) return toast("Ø§ÙƒØªØ¨ Ø±Ø§Ø¨Ø· ÙŠØ¨Ø¯Ø£ Ø¨Ù€ http(s)://");
      LINKS_TMP.push({ title:t, url:u });
      linkTitle.value=""; linkUrl.value="";
      renderLinksChips();
    });

    function renderLinksChips(){
      linksChips.innerHTML="";
      if(!LINKS_TMP.length){
        linksChips.innerHTML = `<div class="empty" style="padding:10px;font-size:12px">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø±ÙˆØ§Ø¨Ø· Ø¨Ø¹Ø¯.</div>`;
        return;
      }
      LINKS_TMP.forEach((l,idx)=>{
        const chip = document.createElement("span");
        chip.className="chip";
        chip.innerHTML = `
          ğŸ”— ${escapeHtml(l.title)}
          <a href="${escapeHtml(l.url)}" target="_blank" rel="noopener" style="color:var(--brown);text-decoration:underline;font-weight:800">ÙØªØ­</a>
          <button type="button" title="Ø­Ø°Ù">âœ•</button>
        `;
        chip.querySelector("button").addEventListener("click", ()=>{
          LINKS_TMP.splice(idx,1);
          renderLinksChips();
        });
        linksChips.appendChild(chip);
      });
    }

    function openTaskModal(mode, ctxOrTask){
      TASK_MODE = mode;

      if(mode==="create"){
        TASK_CTX = ctxOrTask; // {workspace, column}
        CURRENT_TASK = null;

        $("taskModalTitle").textContent = "ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯";
        $("taskDelete").style.display="none";

        taskColumn.value = TASK_CTX.column;
        taskSpecKey.value = "";
        taskDesc.value = "";
        taskDue.value = "";
        taskAssignee.value = "";

        
        const isCampaign = TASK_CTX.workspace.type==="campaign";
        taskLinksWrap.style.display = isCampaign ? "" : "none";
        LINKS_TMP = [];
        renderLinksChips();
      }else{
        CURRENT_TASK = ctxOrTask;
        TASK_CTX = { workspace: CURRENT_WORKSPACE, column: CURRENT_TASK.column };

        $("taskModalTitle").textContent = "ØªØ¹Ø¯ÙŠÙ„ ØªØ§Ø³Ùƒ";
        $("taskDelete").style.display="";

        taskColumn.value = CURRENT_TASK.column || "";
        taskSpecKey.value = CURRENT_TASK.specKey || "";
        taskDesc.value = CURRENT_TASK.description || "";
        taskDue.value = "";
        taskAssignee.value = CURRENT_TASK.assigneeUid || "";

        
        const isCampaign = CURRENT_TASK.type==="campaign";
        taskLinksWrap.style.display = isCampaign ? "" : "none";
        LINKS_TMP = Array.isArray(CURRENT_TASK.links) ? [...CURRENT_TASK.links] : [];
        renderLinksChips();
      }

      taskModal.classList.add("show");
    }

    function closeTaskModal(){
      taskModal.classList.remove("show");
      TASK_CTX = null;
      LINKS_TMP = [];
    }

    $("taskSave").addEventListener("click", async ()=>{
      const specKey = (taskSpecKey.value||"").trim();
      const description = (taskDesc.value||"").trim() || null;
      // ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…
      const due = null;
      const assigneeUid = taskAssignee.value || null;
      const assigneeObj = USERS.find(u=> u.uid===assigneeUid);
      const assigneeName = assigneeObj?.name || null;

      if(!specKey) return toast("Ø§ÙƒØªØ¨ Unique Spec Key");
      // Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (ØºÙŠØ± Ù…Ø¹Ù…ÙˆÙ„ Ù„Ù‡Ø§ Ù…ÙˆÙ†ØªØ§Ø¬)
      const allowed = (SPEC_KEY_SET && SPEC_KEY_SET.has(specKey));
      const editingSame = (TASK_MODE!=="create" && CURRENT_TASK?.specKey && specKey===String(CURRENT_TASK.specKey).trim());
      if(!allowed && !editingSame) return toast("Ø§Ø®ØªØ± Unique Spec Key Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙ‚Ø·");
      if(!TASK_CTX?.workspace?.id) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Workspace Ù…Ø­Ø¯Ø¯");
      if(!TASK_CTX?.column) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…ÙˆØ¯");

      const isCampaign = TASK_CTX.workspace.type==="campaign";

      const payload = {
        workspaceId: TASK_CTX.workspace.id,
        type: TASK_CTX.workspace.type,
        column: TASK_CTX.column,
        specKey,
        description,
        // due removed
        assigneeUid,
        assigneeName
      };

      if(isCampaign) payload.links = LINKS_TMP.length ? LINKS_TMP : [];

      try{
        if(TASK_MODE==="create"){
          payload.createdAt = serverTimestamp();
          payload.createdBy = CURRENT_USER?.uid || null;
          await addDoc(collection(db,"workspace_tasks"), payload);
          toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ");
        }else{
          if(!CURRENT_TASK?.id) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ID Ù„Ù„ØªØ¹Ø¯ÙŠÙ„");
          await updateDoc(doc(db,"workspace_tasks", CURRENT_TASK.id), payload);
          toast("âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ø³Ùƒ");
        }
        closeTaskModal();
      }catch(err){
        console.error(err);
        const msg = (err?.code ? (err.code + " â€” ") : "") + (err?.message || "");
        toast("âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ: " + (msg || "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Firestore Rules)"));
      }
    });

    $("taskDelete").addEventListener("click", async ()=>{
      if(!CURRENT_TASK?.id) return;
      if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØªØ§Ø³ÙƒØŸ")) return;
      try{
        await deleteDoc(doc(db,"workspace_tasks", CURRENT_TASK.id));
        toast("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ§Ø³Ùƒ");
        closeTaskModal();
        closeDetail();
      }catch(err){
        console.error(err);
        toast("âš ï¸ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØªØ§Ø³Ùƒ");
      }
    });

    // Detail
    const detailModal = $("detailModal");
    function openTaskDetail(task){
      CURRENT_TASK = task;

      $("dSpecKey").value = task.specKey || "";
      $("dDue").value = "";
      $("dAssignee").value = task.assigneeName || "â€”";
      $("dColumn").value = task.column || "";
      $("dDesc").value = task.description || "";

      const linksBlock = $("dLinksBlock");
      const dLinks = $("dLinks");
      dLinks.innerHTML="";

      if(task.type==="campaign" && Array.isArray(task.links) && task.links.length){
        linksBlock.style.display="";
        task.links.forEach(l=>{
          const chip = document.createElement("span");
          chip.className="chip";
          chip.innerHTML = `ğŸ”— <a href="${escapeHtml(l.url)}" target="_blank" rel="noopener" style="color:var(--brown);text-decoration:underline;font-weight:900">${escapeHtml(l.title||l.url)}</a>`;
          dLinks.appendChild(chip);
        });
      }else{
        linksBlock.style.display="none";
      }

      detailModal.classList.add("show");
    }
    function closeDetail(){ detailModal.classList.remove("show"); }

    $("detailClose").addEventListener("click", closeDetail);
    $("detailOk").addEventListener("click", closeDetail);
    detailModal.addEventListener("click", (e)=> { if(e.target===detailModal) closeDetail(); });

    $("detailEdit").addEventListener("click", ()=>{
      if(!CURRENT_TASK) return;
      closeDetail();
      openTaskModal("edit", CURRENT_TASK);
    });

    $("detailDelete").addEventListener("click", async ()=>{
      if(!CURRENT_TASK?.id) return;
      if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØªØ§Ø³ÙƒØŸ")) return;
      try{
        await deleteDoc(doc(db,"workspace_tasks", CURRENT_TASK.id));
        toast("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ§Ø³Ùƒ");
        closeDetail();
      }catch(err){
        console.error(err);
        toast("âš ï¸ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØªØ§Ø³Ùƒ");
      }
    });
    // ==================================================
    // Stock Colors Modal + Finish Task Flow
    // ==================================================

    const colorsModal = $("colorsModal");
    const cmSpecKey = $("cmSpecKey");
    const cmExt = $("cmExt");
    const cmInt = $("cmInt");

    const finishModal = $("finishModal");
    const fmSpecKey = $("fmSpecKey");
    const fmMontageDetails = $("fmMontageDetails");
    const fmColorsWrap = $("fmColorsWrap");
    const fmAddColor = $("fmAddColor");

    function uniqSorted(arr){
      return Array.from(new Set((arr||[]).map(v=>String(v||"").trim()).filter(Boolean)))
        .sort((a,b)=> a.localeCompare(b,"ar",{numeric:true,sensitivity:"base"}));
    }

    function getColorsForSpecKey(specKey){
      const key = String(specKey||"").trim();
      const arr = Array.isArray(AGENDA_STOCK) ? AGENDA_STOCK : [];
      const filtered = arr.filter(r => !isExcludedByInventoryFilter(r));
      const ext=[]; const intr=[];
      for(const r of filtered){
        const k = buildSpecKeyNoColors({
          car: r.car ?? r["Ø§Ù„Ø³ÙŠØ§Ø±Ø©"],
          variant: r.variant ?? r["Ø§Ù„Ø¨ÙŠØ§Ù†"],
          modelYear: r.modelYear ?? r["Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„"],
        });
        if(k !== key) continue;
        const e = (r.extColor ?? r["Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ"] ?? r.extcolor ?? r.colorExt ?? r["extColor"] ?? "");
        const i = (r.intColor ?? r["Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ"] ?? r.intcolor ?? r.colorInt ?? r["intColor"] ?? "");
        if(e) ext.push(e);
        if(i) intr.push(i);
      }
      return { ext: uniqSorted(ext), int: uniqSorted(intr) };
    }

    function renderChips(target, items){
      if(!target) return;
      const arr = items || [];
      if(!arr.length){ target.innerHTML = `<span class="hint" style="color:var(--muted)">â€”</span>`; return; }
      target.innerHTML = arr.map(v=> `<span class="chip">${escapeHtml(v)}</span>`).join("");
    }

    function openColorsModal(specKey){
      const key = String(specKey||"").trim();
      if(!key) return;
      const c = getColorsForSpecKey(key);
      cmSpecKey.value = key;
      renderChips(cmExt, c.ext);
      renderChips(cmInt, c.int);
      colorsModal.classList.add("show");
    }
    function closeColorsModal(){ colorsModal.classList.remove("show"); }
    $("colorsClose").addEventListener("click", closeColorsModal);
    $("colorsOk").addEventListener("click", closeColorsModal);
    colorsModal.addEventListener("click", (e)=>{ if(e.target===colorsModal) closeColorsModal(); });

    // ----- Finish modal -----
    let FINISH_COLORS = [];
    let FINISH_COLORS_META = { ext:[], int:[] };

    function colorRowTemplate(idx, extVal="", intVal=""){
      const extOpts = [""].concat(FINISH_COLORS_META.ext).map(v=>
        `<option value="${escapeAttr(v)}" ${v===extVal?"selected":""}>${v?escapeHtml(v):"-"}</option>`).join("");
      const intOpts = [""].concat(FINISH_COLORS_META.int).map(v=>
        `<option value="${escapeAttr(v)}" ${v===intVal?"selected":""}>${v?escapeHtml(v):"-"}</option>`).join("");
      return `
        <div class="card" data-color-row="${idx}" style="padding:12px;margin-bottom:10px">
          <div class="grid2" style="align-items:end">
            <div>
              <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</label>
              <select class="fm-ext" data-idx="${idx}">${extOpts}</select>
            </div>
            <div>
              <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</label>
              <select class="fm-int" data-idx="${idx}">${intOpts}</select>
            </div>
          </div>
          <div style="display:flex;justify-content:flex-end;margin-top:10px">
            <button type="button" class="btn danger xs" data-remove-color="${idx}">Ø­Ø°Ù Ø§Ù„Ù„ÙˆÙ†</button>
          </div>
        </div>`;
    }

    function renderFinishColors(){
      if(!fmColorsWrap) return;
      if(!FINISH_COLORS.length){
        fmColorsWrap.innerHTML = `<div class="hint" style="color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù„ÙˆØ§Ù† Ù…Ø¶Ø§ÙØ© â€” Ø§Ø¶ØºØ· "+ Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ† Ù…Ø³ØªØ®Ø¯Ù…"</div>`;
        return;
      }
      fmColorsWrap.innerHTML = FINISH_COLORS.map((r,idx)=> colorRowTemplate(idx, r.extColor||"", r.intColor||"")).join("");
    }

    function openFinishModalForTask(task){
      if(!task?.id) return;
      const key = String(task.specKey||"").trim();
      fmSpecKey.value = key;
      fmMontageDetails.value = "";
      FINISH_COLORS_META = getColorsForSpecKey(key);
      FINISH_COLORS = [];
      renderFinishColors();
      finishModal.classList.add("show");
    }
    function closeFinishModal(){ finishModal.classList.remove("show"); }

    $("finishClose").addEventListener("click", closeFinishModal);
    $("finishCancel").addEventListener("click", closeFinishModal);
    finishModal.addEventListener("click", (e)=>{ if(e.target===finishModal) closeFinishModal(); });

    // Ø²Ø± ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¯Ø§Ø®Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø³Ùƒ
    $("detailDone").addEventListener("click", ()=>{
      if(!CURRENT_TASK) return;
      openFinishModalForTask(CURRENT_TASK);
    });

    fmAddColor.addEventListener("click", ()=>{
      FINISH_COLORS.push({ extColor:"", intColor:"" });
      renderFinishColors();
    });

    // Delegation Ø¯Ø§Ø®Ù„ fmColorsWrap
    fmColorsWrap.addEventListener("change", (e)=>{
      const sel = e.target;
      if(!(sel instanceof HTMLSelectElement)) return;
      const idx = Number(sel.getAttribute("data-idx"));
      if(Number.isNaN(idx) || !FINISH_COLORS[idx]) return;
      if(sel.classList.contains("fm-ext")) FINISH_COLORS[idx].extColor = sel.value || "";
      if(sel.classList.contains("fm-int")) FINISH_COLORS[idx].intColor = sel.value || "";
    });
    fmColorsWrap.addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-remove-color]");
      if(!btn) return;
      const idx = Number(btn.getAttribute("data-remove-color"));
      if(Number.isNaN(idx)) return;
      FINISH_COLORS = FINISH_COLORS.filter((_,i)=> i!=idx);
      renderFinishColors();
    });

    async function saveStockTaskImmediate(specKey, patch){
      const key = String(specKey||"").trim();
      if(!key) return;
      const prev = STOCK_TASKS_MAP.get(key) || { specKey:key };
      const next = { ...prev, ...patch, specKey:key, updatedAt: serverTimestamp() };
      STOCK_TASKS_MAP.set(key, next);
      try{ applySpecKeyNotMontagedFilter(); }catch(_e){}
      try{
        await setDoc(doc(db, "stock_tasks", stockTaskDocId(key)), next, { merge:true });
        await setDoc(doc(db, "stock_tasks_backup", stockTaskDocId(key)), next, { merge:true });
      }catch(e){
        console.warn("saveStockTaskImmediate", e);
      }
    }

    $("finishSave").addEventListener("click", async ()=>{
      if(!CURRENT_TASK?.id) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Task");
      const key = String(fmSpecKey.value||"").trim();
      if(!key) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Unique Spec Key");
      const mdChoice = String(fmMontageDetails.value||"").trim();
      if(!mdChoice) return toast("Ø§Ø®ØªØ± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ†ØªØ§Ø¬ (Ù†Ø¹Ù…/Ù„Ø§)");

      const usedColors = FINISH_COLORS
        .map(r=>({ extColor:String(r.extColor||"").trim(), intColor:String(r.intColor||"").trim() }))
        .filter(r=> r.extColor || r.intColor);

      // 1) Update task as done + store used colors
      try{
        // Move task to a new green column derived from its current column
        const prevCol = String(CURRENT_TASK.column || "Ù‚Ø§Ø¦Ù…Ø©");
        const doneCol = /ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡/.test(prevCol) ? prevCol : `${prevCol} â€” ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡`;
        // Ensure the column exists on the workspace board
        try{
          const cols = Array.isArray(CURRENT_WORKSPACE?.columns) ? CURRENT_WORKSPACE.columns.slice() : ["Ù‚Ø§Ø¦Ù…Ø©"];
          if(!cols.includes(doneCol)){
            cols.push(doneCol);
            await updateDoc(doc(db,"workspaces", CURRENT_WORKSPACE.id), { columns: cols, updatedAt: serverTimestamp() });
            CURRENT_WORKSPACE.columns = cols;
          }
        }catch(_e){}

        await updateDoc(doc(db, "workspace_tasks", CURRENT_TASK.id), {
          status: "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡",
          column: doneCol,
          doneAt: serverTimestamp(),
          montageDetailsYN: mdChoice,
          usedColors,
          updatedAt: serverTimestamp()
        });
      }catch(e){
        console.error(e);
        return toast("âš ï¸ ÙØ´Ù„ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ§Ø³Ùƒ (ØµÙ„Ø§Ø­ÙŠØ§Øª/Ù‚ÙˆØ§Ø¹Ø¯)");
      }

      // 2) Update Tab stock automatically: montage=yes + montageDetails
      try{ CURRENT_TASK.column = (typeof doneCol!=="undefined" ? doneCol : CURRENT_TASK.column); }catch(_e){}

      const stockMontageDetails = mdChoice === "Ù†Ø¹Ù…" ? "ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª: Ù†Ø¹Ù…" : "ØµÙˆØ± + Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª: Ù„Ø§";
      await saveStockTaskImmediate(key, { montage: "Ù†Ø¹Ù…", montageDetails: stockMontageDetails });

      // 3) Update UI row if visible
      const row = document.querySelector(`#stockTable tr[data-spec="${CSS.escape(key)}"]`);
      if(row){
        const mSel = row.querySelector('[data-field="montage"]');
        const mdSel = row.querySelector('[data-field="montageDetails"]');
        if(mSel){ mSel.value = "Ù†Ø¹Ù…"; }
        if(mdSel){ mdSel.disabled = false; mdSel.value = stockMontageDetails; }
      }

      toast("âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ§Ø³Ùƒ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³ØªÙˆÙƒ");
      closeFinishModal();
      closeDetail();
    });
  

    // ===== DASHBOARD + DAILY TASK (patched) =====

    // ---------------------------
    // Dashboard (Home) - month view
    // ---------------------------
    let DASH_CACHE = { workspaces: [], byId: new Map(), loadedAt: 0 };

    function monthNameArFromIndex(i){
      try{ return MONTHS_AR[(i|0)] || ""; }catch(e){ return ""; }
    }

    function nowMonthInfo(){
      const d = new Date();
      const year = d.getFullYear();
      const monthIndex = d.getMonth();
      const monthName = monthNameArFromIndex(monthIndex);
      const mm = String(monthIndex+1).padStart(2,'0');
      return { year, monthIndex, monthName, mm };
    }

    function workspaceMatchesMonth(ws, mi){
      // mi: {year, monthIndex, monthName, mm}
      if(!ws) return false;
      const name = String(ws.name||"");
      const monthName = String(mi.monthName||"");
      if(monthName && name.includes(monthName)) return true;

      const s = String(ws.startDate||"");
      const e = String(ws.endDate||"");
      const y = String(mi.year);
      const mm = mi.mm;
      // accept: YYYY-MM or YYYY/MM
      const token1 = `${y}-${mm}`;
      const token2 = `${y}/${mm}`;
      if((s && (s.includes(token1) || s.includes(token2))) || (e && (e.includes(token1) || e.includes(token2)))) return true;

      // createdAt timestamp
      try{
        if(ws.createdAt && typeof ws.createdAt.toDate === 'function'){
          const d = ws.createdAt.toDate();
          return d.getFullYear()===mi.year && d.getMonth()===mi.monthIndex;
        }
      }catch(e){}
      return false;
    }

    async function dashLoadWorkspacesOnce(){
      const now = Date.now();
      if(DASH_CACHE.workspaces.length && (now - DASH_CACHE.loadedAt) < 60*1000) return DASH_CACHE.workspaces;

      const out = [];
      try{
        const snap = await getDocs(collection(db,'workspaces'));
        snap.forEach(d=>{
          const x = d.data()||{};
          if(x.active===false) return;
          out.push({ id:d.id, ...x });
        });
      }catch(e){
        console.warn('dashLoadWorkspacesOnce', e);
      }

      // sort newest first
      out.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));

      DASH_CACHE.workspaces = out;
      DASH_CACHE.byId = new Map(out.map(x=>[x.id,x]));
      DASH_CACHE.loadedAt = now;
      return out;
    }


    function renderDashWorkspaceCard(ws, tasks){
      const el = document.createElement('div');
      el.className = 'dash-workspace';

      const total = tasks.length;
      const done  = tasks.filter(isTaskDone).length;
      const remain = total - done;

      el.innerHTML = `
        <div class="top">
          <div>
            <div class="name">${escapeHtml(ws.name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…')}</div>
            <div class="meta">${ws.type==='agenda' ? 'Ø£Ø¬Ù†Ø¯Ø©' : 'Ø­Ù…Ù„Ø©'} â€¢ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b>${total}</b> â€¢ ØªÙ…: <b>${done}</b> â€¢ Ø¨Ø§Ù‚ÙŠ: <b>${remain}</b></div>
          </div>
          <span class="pill"><span class="dot"></span>${ws.type==='agenda' ? 'Agenda' : 'Campaign'}</span>
        </div>
        <div class="dash-tasks"></div>
      `;

      const wrap = el.querySelector('.dash-tasks');
      if(!total){
        const e = document.createElement('div');
        e.className = 'empty';
        e.style.padding = '10px';
        e.style.fontSize = '12px';
        e.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ§Ø³ÙƒØ§Øª.';
        wrap.appendChild(e);
        return el;
      }

      // sort by column then createdAt
      const sorted = tasks.slice().sort((a,b)=>{
        const ca = String(a.column||'');
        const cb = String(b.column||'');
        if(ca!==cb) return ca.localeCompare(cb,'ar');
        return (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0);
      });

      sorted.forEach(t=>{
        const row = document.createElement('div');
        row.className = 'dash-task';
        const done = isTaskDone(t);
        const title = t.specKey || t.title || t.name || 'â€”';
        const sub = t.column || 'â€”';
        row.innerHTML = `
          <div>
            <div class="t-title">${escapeHtml(title)}</div>
            <div class="t-sub">${escapeHtml(sub)}</div>
          </div>
          <span class="pill" style="background:${done?'#ecfdf5':'#fff7ed'};border-color:${done?'#a7f3d0':'#fed7aa'};color:${done?'#065f46':'#9a3412'}">${done?'âœ… ØªÙ…':'â³ Ù„Ù… ÙŠØªÙ…'}</span>
        `;
        wrap.appendChild(row);
      });

      return el;
    }

    async function dashLoadTasksForWorkspace(workspaceId){
      const tasks=[];
      try{
        const qy = query(collection(db,'workspace_tasks'), where('workspaceId','==', workspaceId));
        const snap = await getDocs(qy);
        snap.forEach(d=> tasks.push({ id:d.id, ...(d.data()||{}) }));
      }catch(e){
        console.warn('dashLoadTasksForWorkspace', workspaceId, e);
      }
      // order newest first
      tasks.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
      return tasks;
    }

    async function renderDashboardHome(){
      // Called from openHome
      const mi = nowMonthInfo();
      const pill = document.getElementById('dashMonthPill');
      if(pill) pill.innerHTML = `<span class="dot"></span> Ø´Ù‡Ø± ${escapeHtml(mi.monthName)} ${mi.year}`;

      const wsAll = await dashLoadWorkspacesOnce();
      const agendasAll = wsAll.filter(w=>w.type==='agenda');
      const campaignsAll = wsAll.filter(w=>w.type==='campaign');

      let agendas = agendasAll.filter(w=> workspaceMatchesMonth(w, mi));
      let campaigns = campaignsAll.filter(w=> workspaceMatchesMonth(w, mi));

      // fallback: show latest if none matched
      if(!agendas.length && agendasAll.length) agendas = [agendasAll[0]];
      if(!campaigns.length && campaignsAll.length) campaigns = [campaignsAll[0]];

      // render agendas
      const aWrap = document.getElementById('dashAgendasWrap');
      const aEmpty = document.getElementById('dashAgendasEmpty');
      const aMeta = document.getElementById('dashAgendaMeta');
      if(aWrap){
        aWrap.querySelectorAll('.dash-workspace').forEach(n=>n.remove());
      }
      if(aMeta) aMeta.textContent = String(agendas.length || 0);
      if(aEmpty) aEmpty.style.display = agendas.length ? 'none' : '';

      for(const ws of agendas){
        const tasks = await dashLoadTasksForWorkspace(ws.id);
        if(aWrap) aWrap.appendChild(renderDashWorkspaceCard(ws, tasks));
      }

      // render campaigns
      const cWrap = document.getElementById('dashCampaignsWrap');
      const cEmpty = document.getElementById('dashCampaignsEmpty');
      const cMeta = document.getElementById('dashCampaignMeta');
      if(cWrap){
        cWrap.querySelectorAll('.dash-workspace').forEach(n=>n.remove());
      }
      if(cMeta) cMeta.textContent = String(campaigns.length || 0);
      if(cEmpty) cEmpty.style.display = campaigns.length ? 'none' : '';

      for(const ws of campaigns){
        const tasks = await dashLoadTasksForWorkspace(ws.id);
        if(cWrap) cWrap.appendChild(renderDashWorkspaceCard(ws, tasks));
      }

      // wire picker
      try{ wireDashPicker(); }catch(e){ console.warn(e); }
    }

    function wireDashPicker(){
      const sel = document.getElementById('dashPickType');
      const listWrap = document.getElementById('dashPickListWrap');
      const listEl = document.getElementById('dashPickList');
      const applyBtn = document.getElementById('dashPickApply');
      const resWrap = document.getElementById('dashCustomResults');
      const resTitle = document.getElementById('dashCustomTitle');
      const resMeta = document.getElementById('dashCustomMeta');
      const resBody = document.getElementById('dashCustomWrap');

      if(!sel || !listWrap || !listEl || !applyBtn) return;

      // avoid double wiring
      if(sel.__wired) return;
      sel.__wired = true;

      const buildList = async ()=>{
        const type = String(sel.value||'');
        listEl.innerHTML = '';
        applyBtn.disabled = true;
        if(resWrap) resWrap.style.display = 'none';

        if(!type){
          listWrap.style.display = 'none';
          return;
        }

        listWrap.style.display = '';
        const wsAll = await dashLoadWorkspacesOnce();
        const items = wsAll.filter(w=> w.type===type);

        if(!items.length){
          listEl.innerHTML = `<div class="empty" style="padding:10px;font-size:12px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±.</div>`;
          return;
        }

        items.forEach(w=>{
          const id = `pick_${w.id}`;
          const row = document.createElement('label');
          row.className = 'pick-row';
          row.innerHTML = `
            <input type="checkbox" data-pick-id="${escapeAttr(w.id)}" id="${escapeAttr(id)}" />
            <div>
              <div style="font-weight:800">${escapeHtml(w.name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…')}</div>
              <div style="font-size:12px;color:var(--muted)">${w.type==='agenda'?'Ø£Ø¬Ù†Ø¯Ø©':'Ø­Ù…Ù„Ø©'}</div>
            </div>
          `;
          listEl.appendChild(row);
        });

        listEl.addEventListener('change', ()=>{
          const any = listEl.querySelectorAll('input[type="checkbox"]:checked').length>0;
          applyBtn.disabled = !any;
        }, { once:false });
      };

      sel.addEventListener('change', buildList);
      buildList();

      applyBtn.addEventListener('click', async ()=>{
        const ids = Array.from(listEl.querySelectorAll('input[type="checkbox"]:checked')).map(x=>x.getAttribute('data-pick-id')).filter(Boolean);
        if(!ids.length) return;

        applyBtn.disabled = true;
        applyBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ø±Ø¶...';
        try{
          const wsAll = await dashLoadWorkspacesOnce();
          const byId = new Map(wsAll.map(w=>[w.id,w]));
          const type = String(sel.value||'');

          if(resWrap) resWrap.style.display = '';
          if(resTitle) resTitle.textContent = type==='agenda' ? 'Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©' : 'Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©';

          if(resBody) resBody.innerHTML = '';

          let totalTasks = 0;
          for(const id of ids){
            const ws = byId.get(id);
            if(!ws) continue;
            const tasks = await dashLoadTasksForWorkspace(id);
            totalTasks += tasks.length;
            if(resBody) resBody.appendChild(renderDashWorkspaceCard(ws, tasks));
          }
          if(resMeta) resMeta.textContent = `Ø§Ù„Ø¹Ù†Ø§ØµØ±: ${ids.length} â€¢ Ø§Ù„ØªØ§Ø³ÙƒØ§Øª: ${totalTasks}`;
        }finally{
          applyBtn.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø¯Ø¯';
          const any = listEl.querySelectorAll('input[type="checkbox"]:checked').length>0;
          applyBtn.disabled = !any;
        }
      });
    }

    // ---------------------------
    // Daily Task (Admin) - 4 weeks side by side
    // ---------------------------
    let DAILY = { year:null, monthIndex:null, monthName:null, monthKey:'', tasks:[], byWeekDay:{} };
    let unsubDaily = null;

    function dailyMonthKey(year, monthIndex){
      const m = String((monthIndex|0)+1).padStart(2,'0');
      return `${year}-${m}`;
    }

    function dayNameAr(i){
      // Saturday..Thursday (6 days)
      return ['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'][i] || '';
    }

    function ensureDailySelectors(){
      const mi = nowMonthInfo();
      const yEl = document.getElementById('dailyYear');
      const mEl = document.getElementById('dailyMonth');

      if(mEl && !mEl.__filled){
        mEl.innerHTML = MONTHS_AR.map((m,i)=> `<option value="${i}">${escapeHtml(m)}</option>`).join('');
        mEl.__filled = true;
      }

      if(yEl && !yEl.value){ yEl.value = String(mi.year); }
      if(mEl){ mEl.value = String(mi.monthIndex); }

      DAILY.year = parseInt(yEl?.value||mi.year,10) || mi.year;
      DAILY.monthIndex = parseInt(mEl?.value||mi.monthIndex,10) || mi.monthIndex;
      DAILY.monthName = monthNameArFromIndex(DAILY.monthIndex);
      DAILY.monthKey = dailyMonthKey(DAILY.year, DAILY.monthIndex);
    }

    function showView(view){
      // override existing showView? no. (If already exists, skip)
    }

    // openDaily was referenced earlier - define it now
    function openDaily(){
      MODE='daily'; LIST_TYPE=null; CURRENT_WORKSPACE=null;
      saveLastView('daily');
      if(unsubWorkspaces){unsubWorkspaces();unsubWorkspaces=null;}
      if(unsubTasks){unsubTasks();unsubTasks=null;}

      setNavActive('navDaily');
      document.getElementById('pageTitle').textContent = 'Daily Task';
      document.getElementById('pageDesc').textContent = '';
      document.getElementById('btnBack').style.display = 'none';
      document.getElementById('btnCreateAgenda').style.display = 'none';
      document.getElementById('btnCreateCampaign').style.display = 'none';

      // show daily panel
      Object.values(views).forEach(v=> v.style.display='none');
      views.daily.style.display='';

      ensureDailySelectors();
      renderDailyWeeksSkeleton();
      loadDailyTasks();
    }

    function renderDailyWeeksSkeleton(){
      const weeksEl = document.getElementById('dailyWeeks');
      if(!weeksEl) return;
      weeksEl.innerHTML = '';

      for(let w=0; w<4; w++){
        const col = document.createElement('div');
        col.className = 'day';
        col.style.background = '#fff';
        col.style.border = '1px solid #eee';

        col.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px">
            <div>
              <div style="font-weight:900">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w+1}</div>
              <div class="muted" style="font-size:12px">${escapeHtml(DAILY.monthName||'')}</div>
            </div>
          </div>
          <div class="divider" style="margin:10px 0"></div>
          <div class="daily-days" data-week="${w}" style="display:grid;gap:10px"></div>
          <div class="divider" style="margin:12px 0"></div>
          <div>
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
              <div style="font-weight:900">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</div>
              <span class="pill" data-done-count="${w}">0</span>
            </div>
            <div class="daily-done" data-done-week="${w}" style="display:grid;gap:8px;margin-top:10px"></div>
          </div>
        `;

        const daysWrap = col.querySelector('.daily-days');
        for(let d=0; d<6; d++){
          const box = document.createElement('div');
          box.style.border = '1px solid #eee';
          box.style.borderRadius = '12px';
          box.style.padding = '10px';
          box.style.background = 'var(--cream)';
          box.innerHTML = `
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
              <b>${escapeHtml(dayNameAr(d))}</b>
              <button class="btn secondary xs" type="button" data-daily-add="1" data-week="${w}" data-day="${d}">â• Ù…Ù‡Ù…Ø©</button>
            </div>
            <div class="daily-list" data-week="${w}" data-day="${d}" style="display:grid;gap:8px;margin-top:10px"></div>
          `;
          daysWrap.appendChild(box);
        }

        weeksEl.appendChild(col);
      }

      // delegate add buttons
      weeksEl.onclick = (ev)=>{
        const btn = ev.target.closest('[data-daily-add]');
        if(btn){
          const w = parseInt(btn.getAttribute('data-week')||'0',10)||0;
          const d = parseInt(btn.getAttribute('data-day')||'0',10)||0;
          openDailyTaskModal('create', { weekIdx:w, dayIdx:d });
        }

        const doneBtn = ev.target.closest('[data-daily-done]');
        if(doneBtn){
          const id = doneBtn.getAttribute('data-id');
          if(id) markDailyDone(id);
        }

        const editBtn = ev.target.closest('[data-daily-edit]');
        if(editBtn){
          const id = editBtn.getAttribute('data-id');
          if(id){
            const t = DAILY.tasks.find(x=>x.id===id);
            if(t) openDailyTaskModal('edit', t);
          }
        }
      };
    }

    async function loadDailyTasks(){
      ensureDailySelectors();

      // wire controls once
      const yEl = document.getElementById('dailyYear');
      const mEl = document.getElementById('dailyMonth');
      const reload = document.getElementById('dailyReload');
      const openTxt = document.getElementById('dailyTextOpen');

      if(yEl && !yEl.__wired){
        yEl.__wired=true;
        yEl.addEventListener('change', ()=>{ renderDailyWeeksSkeleton(); listenDailySnapshot(); });
      }
      if(mEl && !mEl.__wired){
        mEl.__wired=true;
        mEl.addEventListener('change', ()=>{ renderDailyWeeksSkeleton(); listenDailySnapshot(); });
      }
      if(reload && !reload.__wired){
        reload.__wired=true;
        reload.addEventListener('click', ()=>{ renderDailyWeeksSkeleton(); listenDailySnapshot(true); });
      }
      if(openTxt && !openTxt.__wired){
        openTxt.__wired=true;
        openTxt.addEventListener('click', ()=> openDailyEditor());
      }

      listenDailySnapshot(true);
    }

    function listenDailySnapshot(force=false){
      if(unsubDaily){ unsubDaily(); unsubDaily=null; }
      ensureDailySelectors();

      const y = DAILY.year;
      const m = DAILY.monthIndex;

      const qy = query(
        collection(db,'daily_tasks'),
        where('year','==', y),
        where('monthIndex','==', m)
      );

      unsubDaily = onSnapshot(qy, (snap)=>{
        const tasks=[];
        snap.forEach(d=> tasks.push({ id:d.id, ...(d.data()||{}) }));
        DAILY.tasks = tasks;
        renderDailyTasks();
      }, (err)=>{
        console.warn('daily_tasks snapshot failed', err);
        toast('âš ï¸ Daily Task: ØªØ­Ù‚Ù‚ Ù…Ù† Rules');
      });
    }

    function renderDailyTasks(){
      // reset containers
      for(let w=0; w<4; w++){
        for(let d=0; d<6; d++){
          const list = document.querySelector(`.daily-list[data-week="${w}"][data-day="${d}"]`);
          if(list) list.innerHTML='';
        }
        const done = document.querySelector(`.daily-done[data-done-week="${w}"]`);
        if(done) done.innerHTML='';
        const badge = document.querySelector(`[data-done-count="${w}"]`);
        if(badge) badge.textContent='0';
      }

      const byWeekDoneCount = [0,0,0,0];

      DAILY.tasks.forEach(t=>{
        const w = parseInt(t.weekIdx ?? t.weekIndex ?? 0,10)||0;
        const d = parseInt(t.dayIdx ?? t.dayIndex ?? 0,10)||0;
        const title = t.title || t.name || 'â€”';
        const desc = t.description || t.desc || '';
        const notes = t.notes || '';
        const done = String(t.status||'todo')==='done' || t.done===true;

        if(done){
          byWeekDoneCount[w] = (byWeekDoneCount[w]||0)+1;
          const wrap = document.querySelector(`.daily-done[data-done-week="${w}"]`);
          if(wrap){
            const row = document.createElement('div');
            row.className='dash-task';
            row.style.background='#ecfdf5';
            row.innerHTML = `
              <div>
                <div class="t-title">${escapeHtml(title)}</div>
                <div class="t-sub">${escapeHtml(desc||notes||'')}</div>
              </div>
              <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btn secondary xs" type="button" data-daily-edit="1" data-id="${escapeAttr(t.id)}">ØªØ¹Ø¯ÙŠÙ„</button>
              </div>
            `;
            wrap.appendChild(row);
          }
          return;
        }

        const list = document.querySelector(`.daily-list[data-week="${w}"][data-day="${d}"]`);
        if(!list) return;

        const row = document.createElement('div');
        row.className='dash-task';
        row.innerHTML = `
          <div>
            <div class="t-title">${escapeHtml(title)}</div>
            <div class="t-sub">${escapeHtml(desc||notes||'')}</div>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn secondary xs" type="button" data-daily-edit="1" data-id="${escapeAttr(t.id)}">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn xs" type="button" data-daily-done="1" data-id="${escapeAttr(t.id)}">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</button>
          </div>
        `;
        list.appendChild(row);
      });

      for(let w=0; w<4; w++){
        const badge = document.querySelector(`[data-done-count="${w}"]`);
        if(badge) badge.textContent = String(byWeekDoneCount[w]||0);
      }
    }

    // ---- Daily Task Modal CRUD ----
    const dailyTaskModal = document.getElementById('dailyTaskModal');
    const dailyTaskModalClose = document.getElementById('dailyTaskModalClose');
    const dailyCancel = document.getElementById('dailyCancel');

    function openDailyTaskModal(mode, data){
      if(!dailyTaskModal) return;
      const isEdit = mode==='edit';

      document.getElementById('dailyTaskModalTitle').textContent = isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù…Ø© ÙŠÙˆÙ…ÙŠØ©' : 'Ù…Ù‡Ù…Ø© ÙŠÙˆÙ…ÙŠØ©';
      document.getElementById('dailyTaskId').value = isEdit ? (data.id||'') : '';
      document.getElementById('dailyWeekIdx').value = String(data.weekIdx ?? data.weekIndex ?? data.weekIdx ?? 0);
      document.getElementById('dailyDayIdx').value  = String(data.dayIdx ?? data.dayIndex ?? data.dayIdx ?? 0);

      document.getElementById('dailyTitle').value = isEdit ? (data.title||data.name||'') : '';
      document.getElementById('dailyDesc').value  = isEdit ? (data.description||data.desc||'') : '';
      document.getElementById('dailyStatus').value= isEdit ? (String(data.status||'todo')==='done' ? 'done':'todo') : 'todo';
      const notesEl = document.getElementById('dailyNotes');
      if(notesEl) notesEl.innerHTML = isEdit ? String(data.notes||'') : '';

      const delBtn = document.getElementById('dailyDelete');
      if(delBtn) delBtn.style.display = isEdit ? '' : 'none';

      dailyTaskModal.style.display = 'flex';
    }

    function closeDailyTaskModal(){
      if(!dailyTaskModal) return;
      dailyTaskModal.style.display = 'none';
    }

    if(dailyTaskModalClose && !dailyTaskModalClose.__wired){
      dailyTaskModalClose.__wired=true;
      dailyTaskModalClose.addEventListener('click', closeDailyTaskModal);
    }
    if(dailyCancel && !dailyCancel.__wired){
      dailyCancel.__wired=true;
      dailyCancel.addEventListener('click', closeDailyTaskModal);
    }
    if(dailyTaskModal && !dailyTaskModal.__wired){
      dailyTaskModal.__wired=true;
      dailyTaskModal.addEventListener('click', (e)=>{ if(e.target===dailyTaskModal) closeDailyTaskModal(); });
    }

    const dailySaveBtn = document.getElementById('dailySave');
    const dailyDelBtn  = document.getElementById('dailyDelete');

    if(dailySaveBtn && !dailySaveBtn.__wired){
      dailySaveBtn.__wired=true;
      dailySaveBtn.addEventListener('click', async ()=>{
        ensureDailySelectors();
        const id = document.getElementById('dailyTaskId').value || '';
        const weekIdx = parseInt(document.getElementById('dailyWeekIdx').value||'0',10)||0;
        const dayIdx  = parseInt(document.getElementById('dailyDayIdx').value||'0',10)||0;
        const title = String(document.getElementById('dailyTitle').value||'').trim();
        const description = String(document.getElementById('dailyDesc').value||'').trim();
        const status = String(document.getElementById('dailyStatus').value||'todo');
        const notes = String(document.getElementById('dailyNotes')?.innerHTML||'');

        if(!title) return toast('Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©');

        const payload = {
          year: DAILY.year,
          monthIndex: DAILY.monthIndex,
          monthName: DAILY.monthName,
          weekIdx,
          dayIdx,
          title,
          description,
          notes,
          status,
          updatedAt: serverTimestamp(),
        };

        try{
          if(id){
            await setDoc(doc(db,'daily_tasks', id), payload, { merge:true });
          }else{
            payload.createdAt = serverTimestamp();
            await addDoc(collection(db,'daily_tasks'), payload);
          }
          closeDailyTaskModal();
          toast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
        }catch(e){
          console.warn('daily save', e);
          toast('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ (Rules)');
        }
      });
    }

    if(dailyDelBtn && !dailyDelBtn.__wired){
      dailyDelBtn.__wired=true;
      dailyDelBtn.addEventListener('click', async ()=>{
        const id = document.getElementById('dailyTaskId').value || '';
        if(!id) return;
        try{
          await deleteDoc(doc(db,'daily_tasks', id));
          closeDailyTaskModal();
          toast('ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù');
        }catch(e){
          console.warn('daily delete', e);
          toast('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù');
        }
      });
    }

    async function markDailyDone(id){
      try{
        await setDoc(doc(db,'daily_tasks', id), { status:'done', updatedAt: serverTimestamp() }, { merge:true });
      }catch(e){
        console.warn('markDailyDone', e);
        toast('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­Ø¯ÙŠØ«');
      }
    }

    // ---- Daily Text Editor (per month) ----
    const dailyEditorModal = document.getElementById('dailyEditorModal');
    let DAILY_EDITOR_DOCID = '';

    function openDailyEditor(){
      ensureDailySelectors();
      DAILY_EDITOR_DOCID = DAILY.monthKey;

      const meta = document.getElementById('dailyEditorMeta');
      if(meta) meta.textContent = `Ø§Ù„Ø´Ù‡Ø±: ${DAILY.monthName} ${DAILY.year} â€” Ø­ÙØ¸ Ø¯Ø§Ø®Ù„ daily_texts/${DAILY_EDITOR_DOCID}`;

      loadDailyEditorDoc();
      if(dailyEditorModal) dailyEditorModal.style.display='flex';
    }

    function closeDailyEditor(){
      if(dailyEditorModal) dailyEditorModal.style.display='none';
    }

    async function loadDailyEditorDoc(){
      const box = document.getElementById('dailyEditorBox');
      if(box) box.innerHTML = '';

      try{
        const snap = await getDoc(doc(db,'daily_texts', DAILY_EDITOR_DOCID));
        if(snap.exists()){
          const d = snap.data()||{};
          if(box) box.innerHTML = String(d.html||'');
        }
      }catch(e){
        console.warn('loadDailyEditorDoc', e);
      }
    }

    function applyExec(cmd, value=null){
      try{ document.execCommand(cmd, false, value); }catch(e){}
    }

    function wireDailyEditor(){
      const closeBtn = document.getElementById('dailyEditorClose');
      const cancelBtn = document.getElementById('dailyEditorCancel');
      const saveBtn = document.getElementById('dailyEditorSave');
      const delBtn = document.getElementById('dailyEditorDelete');
      const box = document.getElementById('dailyEditorBox');
      const fontSel = document.getElementById('dailyRteFont');
      const sizeSel = document.getElementById('dailyRteSize');
      const colorInp = document.getElementById('dailyRteColor');

      if(closeBtn && !closeBtn.__wired){ closeBtn.__wired=true; closeBtn.addEventListener('click', closeDailyEditor); }
      if(cancelBtn && !cancelBtn.__wired){ cancelBtn.__wired=true; cancelBtn.addEventListener('click', closeDailyEditor); }
      if(dailyEditorModal && !dailyEditorModal.__wired){ dailyEditorModal.__wired=true; dailyEditorModal.addEventListener('click',(e)=>{ if(e.target===dailyEditorModal) closeDailyEditor(); }); }

      // toolbar
      if(dailyEditorModal && !dailyEditorModal.__toolbar){
        dailyEditorModal.__toolbar=true;
        dailyEditorModal.addEventListener('click', (e)=>{
          const b = e.target.closest('[data-drte]');
          if(!b) return;
          const a = b.getAttribute('data-drte');
          if(a==='bold') return applyExec('bold');
          if(a==='italic') return applyExec('italic');
          if(a==='underline') return applyExec('underline');
          if(a==='ul') return applyExec('insertUnorderedList');
          if(a==='ol') return applyExec('insertOrderedList');
          if(a==='clear') return applyExec('removeFormat');
        });
      }

      if(fontSel && !fontSel.__wired){
        fontSel.__wired=true;
        fontSel.addEventListener('change', ()=>{ applyExec('fontName', fontSel.value); });
      }
      if(sizeSel && !sizeSel.__wired){
        sizeSel.__wired=true;
        sizeSel.addEventListener('change', ()=>{ applyExec('fontSize', sizeSel.value); });
      }
      if(colorInp && !colorInp.__wired){
        colorInp.__wired=true;
        colorInp.addEventListener('input', ()=>{ applyExec('foreColor', colorInp.value); });
      }

      if(saveBtn && !saveBtn.__wired){
        saveBtn.__wired=true;
        saveBtn.addEventListener('click', async ()=>{
          ensureDailySelectors();
          const htmlv = String(box?.innerHTML||'');
          const payload = {
            year: DAILY.year,
            monthIndex: DAILY.monthIndex,
            monthName: DAILY.monthName,
            html: htmlv,
            updatedAt: serverTimestamp(),
          };
          try{
            await setDoc(doc(db,'daily_texts', DAILY_EDITOR_DOCID), payload, { merge:true });
            toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Øµ');
            closeDailyEditor();
          }catch(e){
            console.warn('daily editor save', e);
            toast('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ (Rules)');
          }
        });
      }

      if(delBtn && !delBtn.__wired){
        delBtn.__wired=true;
        delBtn.addEventListener('click', async ()=>{
          try{
            await deleteDoc(doc(db,'daily_texts', DAILY_EDITOR_DOCID));
            toast('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Øµ');
            closeDailyEditor();
          }catch(e){
            console.warn('daily editor delete', e);
            toast('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù');
          }
        });
      }
    }

    // wire editor once
    try{ wireDailyEditor(); }catch(e){ console.warn(e); }

</script>


  <!-- Rich Text Editor Modal -->
  <div class="modal" id="rteModal" style="display:none">
    <div class="modal-card" style="max-width:860px">
      <div class="modal-head">
        <strong id="rteModalTitle">Ù…Ø­Ø±Ø± Ù†ØµÙˆØµ</strong>
        <button class="btn secondary xs" id="rteClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="modal-body">
        <div class="rte">
          <div class="rte-bar">
            <select id="rteFont" class="inp" style="min-width:160px">
              <option value="Tajawal">Tajawal</option>
              <option value="Arial">Arial</option>
              <option value="Tahoma">Tahoma</option>
              <option value="Cairo">Cairo</option>
            </select>
            <select id="rteSize" class="inp" style="width:120px">
              <option value="3">Ø¹Ø§Ø¯ÙŠ</option>
              <option value="2">ØµØºÙŠØ±</option>
              <option value="4">ÙƒØ¨ÙŠØ±</option>
              <option value="5">Ø£ÙƒØ¨Ø±</option>
            </select>
            <input id="rteColor" type="color" class="inp" style="width:54px;padding:6px" value="#111111" />
            <button class="btn secondary xs" type="button" data-rte="bold"><b>B</b></button>
            <button class="btn secondary xs" type="button" data-rte="italic"><i>I</i></button>
            <button class="btn secondary xs" type="button" data-rte="underline"><u>U</u></button>
            <button class="btn secondary xs" type="button" data-rte="ul">â€¢ List</button>
            <button class="btn secondary xs" type="button" data-rte="ol">1. List</button>
            <button class="btn ghost xs" type="button" data-rte="clear">Ù…Ø³Ø­ ØªÙ†Ø³ÙŠÙ‚</button>
          </div>
          <div id="rteBox" class="rte-box" contenteditable="true"></div>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
          <button class="btn danger" id="rteDelete" type="button">Ø­Ø°Ù</button>
          <button class="btn" id="rteSave" type="button">Ø­ÙØ¸</button>
        </div>
      </div>
    </div>
  </div>

  
  <!-- Daily Text Editor Modal -->
  <div class="modal" id="dailyEditorModal">
    <div class="modal-card" style="max-width:900px">
      <div class="modal-head">
        <strong>Ù…Ø­Ø±Ø± Ø§Ù„Ù†ØµÙˆØµ</strong>
        <button class="btn secondary xs" id="dailyEditorClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="modal-body">
        <div class="muted" id="dailyEditorMeta" style="font-size:12px;margin-bottom:10px">â€”</div>
        <div class="rte">
          <div class="rte-bar">
            <select id="dailyRteFont" class="inp" style="min-width:160px">
              <option value="Tajawal">Tajawal</option>
              <option value="Arial">Arial</option>
              <option value="Cairo">Cairo</option>
              <option value="Tahoma">Tahoma</option>
            </select>
            <select id="dailyRteSize" class="inp" style="width:140px">
              <option value="3">Ø¹Ø§Ø¯ÙŠ</option>
              <option value="4">ÙƒØ¨ÙŠØ±</option>
              <option value="5">Ø£ÙƒØ¨Ø±</option>
              <option value="2">ØµØºÙŠØ±</option>
            </select>
            <input id="dailyRteColor" type="color" class="inp" style="width:54px;padding:6px" value="#111111" />
            <button class="btn secondary xs" type="button" data-drte="bold"><b>B</b></button>
            <button class="btn secondary xs" type="button" data-drte="italic"><i>I</i></button>
            <button class="btn secondary xs" type="button" data-drte="underline"><u>U</u></button>
            <button class="btn secondary xs" type="button" data-drte="ul">â€¢ List</button>
            <button class="btn secondary xs" type="button" data-drte="ol">1. List</button>
            <button class="btn ghost xs" type="button" data-drte="clear">Ù…Ø³Ø­ ØªÙ†Ø³ÙŠÙ‚</button>
          </div>
          <div id="dailyEditorBox" class="rte-box" contenteditable="true"></div>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn danger" id="dailyEditorDelete" type="button">Ø­Ø°Ù</button>
        <div style="flex:1"></div>
        <button class="btn secondary" id="dailyEditorCancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" id="dailyEditorSave" type="button">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

<!-- Daily Task Modal -->
  <div class="modal" id="dailyTaskModal">
    <div class="sheet">
      <div class="m-head">
        <strong id="dailyTaskModalTitle">Ù…Ù‡Ù…Ø© ÙŠÙˆÙ…ÙŠØ©</strong>
        <button class="btn secondary xs" id="dailyTaskModalClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="m-body">
        <input type="hidden" id="dailyTaskId" />
        <input type="hidden" id="dailyWeekIdx" />
        <input type="hidden" id="dailyDayIdx" />

        <div class="grid2">
          <div>
            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©</label>
            <input id="dailyTitle" placeholder="Ù…Ø«Ø§Ù„: ØªØµÙ…ÙŠÙ… ØµÙˆØ±Ø© / Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª..." />
          </div>
          <div>
            <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="dailyStatus">
              <option value="todo">Ù„Ù… ÙŠØªÙ…</option>
              <option value="done">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</option>
            </select>
          </div>
        </div>

        <label>ÙˆØµÙ Ø§Ù„Ù…Ù‡Ù…Ø©</label>
        <textarea id="dailyDesc" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ Ù…Ø®ØªØµØ±..." ></textarea>

        <label>Ù…Ø­Ø±Ø± Ù†ØµÙˆØµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <div class="rte">
          <div class="rte-bar">
            <select id="rteFont" class="inp" style="min-width:140px">
              <option value="Tajawal">Tajawal</option>
              <option value="Arial">Arial</option>
              <option value="Tahoma">Tahoma</option>
              <option value="Times New Roman">Times New Roman</option>
            </select>
            <select id="rteSize" class="inp" style="width:120px">
              <option value="12">12</option>
              <option value="14" selected>14</option>
              <option value="16">16</option>
              <option value="18">18</option>
              <option value="22">22</option>
              <option value="28">28</option>
            </select>
            <input id="rteColor" type="color" class="inp" style="width:54px;padding:6px" value="#111111" />
            <button class="btn secondary xs" type="button" data-rte="bold"><b>B</b></button>
            <button class="btn secondary xs" type="button" data-rte="italic"><i>I</i></button>
            <button class="btn secondary xs" type="button" data-rte="underline"><u>U</u></button>
            <button class="btn secondary xs" type="button" data-rte="ul">â€¢ List</button>
            <button class="btn secondary xs" type="button" data-rte="ol">1. List</button>
            <button class="btn ghost xs" type="button" data-rte="clear">Ù…Ø³Ø­ ØªÙ†Ø³ÙŠÙ‚</button>
          </div>
          <div id="dailyNotes" class="rte-box" contenteditable="true"></div>
        </div>
      </div>
      <div class="m-foot">
        <button class="btn danger" id="dailyDelete" type="button" style="display:none">Ø­Ø°Ù</button>
        <button class="btn secondary" id="dailyCancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" id="dailySave" type="button">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

</body>
</html>
