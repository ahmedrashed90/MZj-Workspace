<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Workspace â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª ÙˆØ§Ù„Ø­Ù…Ù„Ø§Øª</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --text:#1f2937;
      --muted:#6b7280;
      --card:#ffffff;
      --line:#e5e7eb;
      --radius:16px;
      --shadow: 0 12px 30px rgba(62,36,32,.12);
      --shadow2: 0 18px 50px rgba(62,36,32,.18);
      --danger:#b91c1c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--cream);
      color:var(--text);
      font-family:"Tajawal",system-ui,Arial;
    }
    a{color:inherit;text-decoration:none}
    button,input,select,textarea{font-family:inherit}

    /* ===== Layout ===== */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 300px 1fr;
      transition: grid-template-columns .18s ease;
    }
    .app.collapsed{ grid-template-columns: 88px 1fr; }

    /* ===== Sidebar ===== */
    .sidebar{
      background: linear-gradient(180deg, var(--brown), #2f1c19);
      color:#fff;
      padding:14px;
      position:sticky;
      top:0;
      height:100vh;
      overflow:auto;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .sb-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:6px 4px 14px;
      border-bottom:1px solid rgba(255,255,255,.12);
      margin-bottom:12px;
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand-badge{
      inline-size:34px;
      block-size:34px;
      border-radius:12px;
      background:linear-gradient(135deg,var(--beige),#d9b39a);
      flex:0 0 auto;
      box-shadow: 0 12px 24px rgba(188,143,116,.25);
    }
    .brand-title{display:flex;flex-direction:column;gap:2px;min-width:0}
    .brand-title strong{
      font-size:14px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .brand-title span{
      font-size:12px;opacity:.85;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .toggle-btn{
      border:0;
      background:rgba(255,255,255,.12);
      color:#fff;
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .toggle-btn:hover{background:rgba(255,255,255,.18)}
    .app.collapsed .brand-title{display:none}

    .sb-user{
      margin:10px 0 14px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      background:rgba(255,255,255,.06);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .avatar{
      width:36px;height:36px;border-radius:12px;
      background:rgba(255,255,255,.14);
      display:flex;align-items:center;justify-content:center;
      font-weight:800;
      flex:0 0 auto;
    }
    .sb-user .meta{min-width:0}
    .sb-user .meta .name{
      font-weight:800;font-size:13px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .sb-user .meta .role{
      font-size:12px;opacity:.85;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .app.collapsed .sb-user .meta{display:none}

    .sb-nav{display:grid;gap:8px;margin-top:10px}
    .sb-link{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      cursor:pointer;transition:.15s;user-select:none;
    }
    .sb-link:hover{background:rgba(255,255,255,.10)}
    .sb-link.active{
      background:rgba(255,255,255,.16);
      border-color:rgba(255,255,255,.16);
    }
    .sb-ico{
      width:34px;height:34px;border-radius:12px;
      background:rgba(255,255,255,.12);
      display:flex;align-items:center;justify-content:center;
      flex:0 0 auto;font-size:16px;
    }
    .sb-text{font-weight:800}
    .app.collapsed .sb-text{display:none}

    .sb-foot{
      margin-top:14px;padding-top:12px;
      border-top:1px solid rgba(255,255,255,.12);
      display:grid;gap:8px;
    }
    .hint{font-size:12px;line-height:1.6}

    /* ===== Main ===== */
    .main{padding:18px;min-width:0}
    .page-head{
      display:flex;align-items:flex-start;justify-content:space-between;
      gap:14px;margin-bottom:14px;
    }
    .title-wrap h1{margin:0;font-size:20px;color:var(--brown);letter-spacing:.2px}
    .title-wrap p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.6}

    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      padding:10px 12px;border-radius:14px;border:0;
      background:var(--brown);color:#fff;cursor:pointer;font-weight:800;
      box-shadow: 0 10px 24px rgba(62,36,32,.18);transition:.15s;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{background:#fff;color:var(--brown);border:1px solid var(--brown);box-shadow:none}
    .btn.danger{background:var(--danger);box-shadow: 0 10px 24px rgba(185,28,28,.18)}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--brown);box-shadow:none}
    .btn.sm{padding:8px 10px;border-radius:12px;font-size:13px}
    .btn.xs{padding:6px 9px;border-radius:999px;font-size:12px}

    .panel{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(62,36,32,.06);
      overflow:hidden;
    }
    .panel .head{
      padding:12px 14px;border-bottom:1px solid #f1f1f1;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      background: linear-gradient(180deg, #fff, #fff8ef);
    }
    .panel .body{padding:14px}
    .muted{color:var(--muted)}

    /* ===== Home cards ===== */
    .home-grid{display:grid;grid-template-columns:repeat(2, minmax(0, 1fr));gap:14px}
    @media(max-width:980px){.home-grid{grid-template-columns:1fr}}
    .hero-card{
      border-radius:18px;border:1px solid rgba(62,36,32,.10);
      background: linear-gradient(140deg, #fff, #fff8ef 60%, rgba(188,143,116,.10));
      box-shadow: var(--shadow);
      padding:16px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      position:relative;overflow:hidden;min-height:150px;cursor:pointer;
    }
    .hero-card::before{
      content:"";position:absolute;inset:auto -40px -40px auto;
      width:160px;height:160px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(188,143,116,.35), transparent 60%);
      transform: rotate(12deg);
    }
    .hero-left{position:relative;z-index:1;min-width:0}
    .hero-title{margin:0;font-size:18px;color:var(--brown);font-weight:900}
    .hero-desc{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.7;max-width:560px}
    .hero-actions{position:relative;z-index:1;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;background:#fff;
      border:1px solid rgba(62,36,32,.10);color:var(--brown);
      font-weight:800;font-size:12px;box-shadow: 0 8px 18px rgba(62,36,32,.10);
    }
    .pill .dot{width:8px;height:8px;border-radius:999px;background:var(--beige)}

    /* ===== Lists ===== */
    .list{display:grid;gap:10px}
    .list-item{
      border:1px solid rgba(62,36,32,.10);border-radius:16px;padding:12px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      background:#fff;transition:.15s;cursor:pointer;
    }
    .list-item:hover{transform:translateY(-1px);box-shadow: 0 14px 36px rgba(62,36,32,.12)}
    .li-main{min-width:0}
    .li-title{
      margin:0;font-size:14px;font-weight:900;color:var(--brown);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .li-sub{
      margin:6px 0 0;font-size:12px;color:var(--muted);line-height:1.6;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
    }
    .li-right{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;flex:0 0 auto}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;background:#fff8ef;
      border:1px solid rgba(188,143,116,.30);color:var(--brown);
      font-size:12px;font-weight:800;
    }
    .tag .mini{width:6px;height:6px;border-radius:999px;background:var(--beige)}

    /* ===== Board ===== */
    .board{display:grid;gap:14px;grid-template-columns:repeat(4, minmax(0, 1fr));margin-top:12px}
    @media(max-width:1400px){.board{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:980px){.board{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.board{grid-template-columns:1fr}}

    .col{
      background:#fff;border:1px solid rgba(62,36,32,.08);
      border-radius:16px;box-shadow: 0 10px 28px rgba(62,36,32,.08);
      overflow:hidden;display:flex;flex-direction:column;min-height:220px;
    }
    .col-head{
      background: linear-gradient(180deg, #fff8ef, #fff);
      border-bottom:1px solid rgba(62,36,32,.06);
      padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px;
    }
    .col-title{
      font-weight:900;color:var(--brown);font-size:13px;
      display:flex;align-items:center;gap:8px;min-width:0;
    }
    .col-title span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .count-badge{
      display:inline-flex;align-items:center;justify-content:center;
      min-width:24px;height:24px;padding:0 8px;border-radius:999px;
      background:#fff;border:1px solid rgba(62,36,32,.12);
      font-size:12px;font-weight:900;color:var(--brown);
    }
    .col-body{padding:10px;display:grid;gap:10px}

    .task-card{
      border:1px solid rgba(62,36,32,.10);border-radius:14px;padding:10px;
      background:#fff;box-shadow: 0 10px 22px rgba(62,36,32,.08);
      cursor:pointer;transition:.15s;
    }
    .task-card:hover{transform:translateY(-1px)}
    .t-title{margin:0;font-size:13px;font-weight:900;color:var(--brown);line-height:1.5}
    .t-meta{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:12px}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;background:#fff8ef;
      border:1px solid rgba(188,143,116,.25);color:var(--brown);
      font-weight:800;font-size:12px;
    }
    .badge .dot{width:8px;height:8px;border-radius:999px;background:var(--beige)}

    /* ===== Modal ===== */
    .modal{
      position:fixed;inset:0;background:rgba(0,0,0,.40);
      display:none;place-items:center;padding:16px;z-index:999;
    }
    .modal.show{display:grid}
    .sheet{
      width:min(900px, 100%);background:#fff;border-radius:18px;box-shadow: var(--shadow2);
      overflow:hidden;display:flex;flex-direction:column;max-height:92vh;
    }
    .sheet .m-head{
      padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid #f1f1f1;background: linear-gradient(180deg, #fff, #fff8ef);
    }
    .sheet .m-head strong{color:var(--brown);font-size:14px;font-weight:900}
    .sheet .m-body{padding:14px;overflow:auto;display:grid;gap:10px}
    .sheet .m-foot{
      padding:12px 14px;border-top:1px solid #f1f1f1;background: #fff8ef;
      display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;
    }

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:860px){.grid2{grid-template-columns:1fr}}
    label{display:block;margin:4px 0 6px;font-size:12px;font-weight:900;color:var(--brown)}
    input,select,textarea{
      width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      outline:none;background:#fff;font-size:14px;
    }
    textarea{min-height:110px;resize:vertical;line-height:1.8}
    input:focus,select:focus,textarea:focus{
      border-color: rgba(188,143,116,.65);
      box-shadow: 0 0 0 4px rgba(188,143,116,.18);
    }

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;border:1px solid rgba(62,36,32,.10);
      background:#fff;font-size:12px;color:var(--brown);font-weight:800;
    }
    .chip button{
      border:0;background:#fff8ef;color:var(--brown);
      border-radius:10px;cursor:pointer;padding:4px 8px;font-weight:900;
    }

    .divider{height:1px;background: #f1f1f1;margin:4px 0}
    .empty{
      padding:14px;border:1px dashed rgba(62,36,32,.18);
      border-radius:16px;background:#fff;color:var(--muted);
      line-height:1.8;font-size:13px;
    }

    .toast{
      position:fixed;left:16px;bottom:16px;background:#111827;color:#fff;
      padding:10px 12px;border-radius:14px;box-shadow: 0 14px 40px rgba(0,0,0,.25);
      display:none;z-index:2000;font-size:13px;
    }
    .toast.show{display:block}

    .kpi-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi{
      flex:1 1 220px;background:#fff;border-radius:16px;border:1px solid rgba(62,36,32,.08);
      box-shadow: 0 10px 28px rgba(62,36,32,.08);padding:12px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .kpi strong{display:block;color:var(--brown);font-weight:900;font-size:13px}
    .kpi span{color:var(--muted);font-size:12px}
    .kpi .num{font-weight:900;font-size:18px;color:var(--brown)}
  </style>
</head>

<body>
  <div class="app" id="app">
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand">
          <div class="brand-badge"></div>
          <div class="brand-title">
            <strong>MZJ Workspace</strong>
            <span>Tasks & Campaigns</span>
          </div>
        </div>
        <button class="toggle-btn" id="sbToggle" title="ÙØªØ­ / Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">â˜°</button>
      </div>

      <div class="sb-user">
        <div class="avatar" id="avatar">M</div>
        <div class="meta">
          <div class="name" id="whoName">...</div>
          <div class="role" id="whoRole">...</div>
        </div>
      </div>

      <div class="sb-nav">
        <div class="sb-link active" id="navHome">
          <div class="sb-ico">ğŸ </div>
          <div class="sb-text">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        </div>

        <div class="sb-link" id="navAgendas">
          <div class="sb-ico">ğŸ—‚ï¸</div>
          <div class="sb-text">Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª</div>
        </div>

        <div class="sb-link" id="navCampaigns">
          <div class="sb-ico">ğŸ“£</div>
          <div class="sb-text">Ø§Ù„Ø­Ù…Ù„Ø§Øª</div>
        </div>
      </div>

      <div class="sb-foot">
        <a class="sb-link" href="javascript:void(0)" id="btnLogout">
          <div class="sb-ico">ğŸšª</div>
          <div class="sb-text">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
        </a>
        <div class="hint" style="color:rgba(255,255,255,.75);padding:6px 6px 0">
          Â© Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª â€” Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="page-head">
        <div class="title-wrap">
          <h1 id="pageTitle">Workspace â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª ÙˆØ§Ù„Ø­Ù…Ù„Ø§Øª</h1>
          <p id="pageDesc">Ø£Ù†Ø´Ø¦ Ø£Ø¬Ù†Ø¯Ø§Øª Ù„ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©/Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©ØŒ ÙˆØ£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø§Øª Ø¨ØªÙˆØ§Ø±ÙŠØ® ÙˆÙˆØµÙ ÙˆØ£Ø¹Ù…Ø¯Ø©â€¦ Ø«Ù… Ø£Ø¶Ù ØªØ§Ø³ÙƒØ§Øª Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ø¹Ù…ÙˆØ¯ Ø¨Ø³Ù‡ÙˆÙ„Ø©.</p>
        </div>

        <div class="actions" id="topActions">
          <button class="btn secondary sm" id="btnBack" style="display:none">â¬… Ø±Ø¬ÙˆØ¹</button>
          <button class="btn sm" id="btnCreateAgenda">â• Ø£Ø¬Ù†Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
          <button class="btn secondary sm" id="btnCreateCampaign">â• Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>
      </div>

      <section class="panel" id="viewHome">
        <div class="head">
          <strong>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</strong>
          <span class="muted" id="homeMeta">...</span>
        </div>
        <div class="body">
          <div class="home-grid">
            <div class="hero-card" id="goAgendas">
              <div class="hero-left">
                <h3 class="hero-title">Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª (Tasks)</h3>
                <p class="hero-desc">
                  Ø£Ù†Ø´Ø¦ Ø£Ø¬Ù†Ø¯Ø© Ø¨Ø§Ø³Ù… ÙˆØ­Ø¯Ø¯ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ÙƒØ±ÙˆØªØŒ Ø«Ù… Ø£Ø¶Ù ØªØ§Ø³ÙƒØ§Øª Ù„ÙƒÙ„ Ø¹Ù…ÙˆØ¯.
                  Ø§Ù„ØªØ§Ø³Ùƒ ÙŠØ­ØªÙˆÙŠ Unique Spec Key + ÙˆØµÙ + ØªØ§Ø±ÙŠØ® ØªØ³Ù„ÙŠÙ… + Ù…Ø³Ø¤ÙˆÙ„.
                </p>
                <div class="kpi-row">
                  <div class="kpi">
                    <div>
                      <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª</strong>
                      <span class="muted">Active</span>
                    </div>
                    <div class="num" id="kpiAgendas">0</div>
                  </div>
                  <div class="kpi">
                    <div>
                      <strong>ØªØ§Ø³ÙƒØ§Øª Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª</strong>
                      <span class="muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                    </div>
                    <div class="num" id="kpiAgendaTasks">0</div>
                  </div>
                </div>
              </div>
              <div class="hero-actions">
                <div class="pill"><span class="dot"></span> Board Ù…Ø±ØªØ¨</div>
                <button class="btn sm" type="button">ÙØªØ­ Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª</button>
              </div>
            </div>

            <div class="hero-card" id="goCampaigns">
              <div class="hero-left">
                <h3 class="hero-title">Ø§Ù„Ø­Ù…Ù„Ø§Øª (Campaigns)</h3>
                <p class="hero-desc">
                  Ø£Ù†Ø´Ø¦ Ø­Ù…Ù„Ø© Ø¨Ø§Ø³Ù… ÙˆÙˆØµÙ + ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ©/Ù†Ù‡Ø§ÙŠØ© + Ø£Ø¹Ù…Ø¯Ø©ØŒ Ø«Ù… Ø£Ø¶Ù ØªØ§Ø³ÙƒØ§Øª Ù„ÙƒÙ„ Ø¹Ù…ÙˆØ¯.
                  Ø§Ù„ØªØ§Ø³Ùƒ ÙŠØ­ØªÙˆÙŠ Unique Spec Key + ÙˆØµÙ + ØªØ§Ø±ÙŠØ® ØªØ³Ù„ÙŠÙ… + Ø±ÙˆØ§Ø¨Ø· + Ù…Ø³Ø¤ÙˆÙ„.
                </p>
                <div class="kpi-row">
                  <div class="kpi">
                    <div>
                      <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù…Ù„Ø§Øª</strong>
                      <span class="muted">Active</span>
                    </div>
                    <div class="num" id="kpiCampaigns">0</div>
                  </div>
                  <div class="kpi">
                    <div>
                      <strong>ØªØ§Ø³ÙƒØ§Øª Ø§Ù„Ø­Ù…Ù„Ø§Øª</strong>
                      <span class="muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                    </div>
                    <div class="num" id="kpiCampaignTasks">0</div>
                  </div>
                </div>
              </div>
              <div class="hero-actions">
                <div class="pill"><span class="dot"></span> ØªÙˆØ§Ø±ÙŠØ® + Ø±ÙˆØ§Ø¨Ø·</div>
                <button class="btn sm" type="button">ÙØªØ­ Ø§Ù„Ø­Ù…Ù„Ø§Øª</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="panel" id="viewList" style="display:none">
        <div class="head">
          <strong id="listTitle">...</strong>
          <div class="actions">
            <button class="btn secondary sm" id="btnRefresh" type="button">âŸ³ ØªØ­Ø¯ÙŠØ«</button>
          </div>
        </div>
        <div class="body">
          <div class="empty" id="listEmpty" style="display:none">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰.</div>
          <div class="list" id="listContainer"></div>
        </div>
      </section>

      <section class="panel" id="viewBoard" style="display:none">
        <div class="head">
          <div>
            <strong id="boardTitle">...</strong>
            <div class="muted" id="boardSub" style="font-size:12px;margin-top:6px"></div>
          </div>
          <div class="actions">
            <button class="btn ghost sm" id="btnEditBoard" type="button">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn danger sm" id="btnDeleteBoard" type="button">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
        <div class="body">
          <div class="board" id="boardCols"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- Create/Edit Board Modal -->
  <div class="modal" id="boardModal">
    <div class="sheet">
      <div class="m-head">
        <strong id="boardModalTitle">...</strong>
        <button class="btn secondary xs" id="boardModalClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="m-body">
        <div class="grid2">
          <div>
            <label>Ø§Ù„Ù†ÙˆØ¹</label>
            <input id="boardType" readonly />
            <div class="hint" style="color:var(--muted)">Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¯Ø§Ø®Ù„ Collection: <b>workspaces</b>.</div>
          </div>
          <div>
            <label>Ø§Ø³Ù… (Ø§Ù„Ø£Ø¬Ù†Ø¯Ø© / Ø§Ù„Ø­Ù…Ù„Ø©)</label>
            <input id="boardName" placeholder="Ù…Ø«Ø§Ù„: ÙŠÙ†Ø§ÙŠØ± 2026 / Ø­Ù…Ù„Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø· - ÙØ¨Ø±Ø§ÙŠØ±"/>
          </div>
        </div>

        <div id="campaignFields" style="display:none">
          <label>ÙˆØµÙ Ø§Ù„Ø­Ù…Ù„Ø©</label>
          <textarea id="campaignDesc" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ø­Ù…Ù„Ø© Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­..."></textarea>
          <div class="grid2">
            <div>
              <label>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ù…Ù„Ø©</label>
              <input id="campaignStart" type="date"/>
            </div>
            <div>
              <label>ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ù…Ù„Ø©</label>
              <input id="campaignEnd" type="date"/>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div>
          <label>Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ø§Ù„ÙƒØ±ÙˆØª)</label>
          <div class="hint" style="color:var(--muted)">Ø£Ø¶Ù Ø£ÙƒØ«Ø± Ù…Ù† Ø¹Ù…ÙˆØ¯. Ù…Ø«Ø§Ù„: (Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª) (ØªØµÙ…ÙŠÙ… ØµÙˆØ±) (Ù…ÙˆØ´Ù†) ...</div>

          <div class="grid2" style="align-items:end">
            <div><input id="colInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø¹Ù…ÙˆØ¯ Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ©"/></div>
            <div style="display:flex;gap:10px;justify-content:flex-end">
              <button class="btn secondary sm" id="btnAddCol" type="button">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯</button>
              <button class="btn ghost sm" id="btnAddDefaults" type="button">Ø¥Ø¶Ø§ÙØ© Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
            </div>
          </div>

          <div class="chips" id="colsChips" style="margin-top:10px"></div>
        </div>
      </div>
      <div class="m-foot">
        <button class="btn secondary" id="boardCancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" id="boardSave" type="button">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- Task Modal -->
  <div class="modal" id="taskModal">
    <div class="sheet">
      <div class="m-head">
        <strong id="taskModalTitle">ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯</strong>
        <button class="btn secondary xs" id="taskModalClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="m-body">
        <div class="grid2">
          <div>
            <label>Unique Spec Key</label>
            <input id="taskSpecKey" list="specKeyList" placeholder="Ø§Ø¨Ø­Ø« ÙˆØ§Ø®ØªØ± (Ø§Ù„Ø³ÙŠØ§Ø±Ø© | Ø§Ù„Ø¨ÙŠØ§Ù† | Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„)â€¦"/>
            <datalist id="specKeyList"></datalist>
            <div class="hint" style="color:var(--muted)">* ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† ØµÙØ­Ø©/Ù‚Ø§Ø¹Ø¯Ø© Unique Spec Key (Ø§Ù„Ù…Ø®Ø²ÙˆÙ†) â€” Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ ØµÙØ­Ø© ÙÙŠ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±.</div>
          </div>
          <div>
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</label>
            <input id="taskDue" type="date"/>
          </div>
        </div>

        <label>Ø§Ù„ÙˆØµÙ</label>
        <textarea id="taskDesc" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ ÙˆØ§Ø¶Ø­ Ù„Ù„ØªØ§Ø³Ùƒ..."></textarea>

        <div class="grid2">
          <div>
            <label>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (User)</label>
            <select id="taskAssignee">
              <option value="">â€” Ø§Ø®ØªØ± ÙŠÙˆØ²Ø± â€”</option>
            </select>
          </div>
          <div>
            <label>Ø§Ù„Ø¹Ù…ÙˆØ¯</label>
            <input id="taskColumn" readonly/>
          </div>
        </div>

        <div id="taskLinksWrap" style="display:none">
          <div class="divider"></div>
          <label>Ø±ÙˆØ§Ø¨Ø· Ù…Ø±ØªØ¨Ø·Ø© (Ù„Ù„Ø­Ù…Ù„Ø§Øª)</label>
          <div class="grid2" style="align-items:end">
            <div><input id="linkTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· â€” Ù…Ø«Ø§Ù„: Ù…Ù„Ù Ø¬ÙˆØ¬Ù„ Ø¯Ø±Ø§ÙŠÙ"/></div>
            <div><input id="linkUrl" placeholder="https://..."/></div>
          </div>
          <div style="display:flex;justify-content:flex-end;margin-top:10px">
            <button class="btn secondary sm" id="btnAddLink" type="button">Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø·</button>
          </div>
          <div class="chips" id="linksChips" style="margin-top:10px"></div>
        </div>

        <div class="divider"></div>
        <div class="hint" style="color:var(--muted)">Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ Ø¯Ø§Ø®Ù„ Collection: <b>workspace_tasks</b>.</div>
      </div>

      <div class="m-foot">
        <button class="btn danger" id="taskDelete" style="display:none" type="button">Ø­Ø°Ù</button>
        <button class="btn secondary" id="taskCancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" id="taskSave" type="button">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- Task Detail Modal -->
  <div class="modal" id="detailModal">
    <div class="sheet">
      <div class="m-head">
        <strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø³Ùƒ</strong>
        <button class="btn secondary xs" id="detailClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="m-body">
        <div class="grid2">
          <div><label>Unique Spec Key</label><input id="dSpecKey" readonly/></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</label><input id="dDue" readonly/></div>
        </div>
        <div class="grid2">
          <div><label>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label><input id="dAssignee" readonly/></div>
          <div><label>Ø§Ù„Ø¹Ù…ÙˆØ¯</label><input id="dColumn" readonly/></div>
        </div>
        <label>Ø§Ù„ÙˆØµÙ</label>
        <textarea id="dDesc" readonly></textarea>

        <div id="dLinksBlock" style="display:none">
          <div class="divider"></div>
          <label>Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</label>
          <div class="chips" id="dLinks"></div>
        </div>
      </div>
      <div class="m-foot">
        <button class="btn secondary" id="detailEdit" type="button">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn danger" id="detailDelete" type="button">Ø­Ø°Ù</button>
        <button class="btn" id="detailOk" type="button">ØªÙ…Ø§Ù…</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">...</div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, signInAnonymously, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs,
      addDoc, setDoc, updateDoc, deleteDoc,
      query, where, orderBy, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDXXDsJKnKb_0HynSTnP22QYc0yrUdx-cw",
      authDomain: "mzj-workspace-c7d4e.firebaseapp.com",
      projectId: "mzj-workspace-c7d4e",
      storageBucket: "mzj-workspace-c7d4e.firebasestorage.app",
      messagingSenderId: "1080687990992",
      appId: "1:1080687990992:web:4a496249bbf330fc37a6d5"
    };

  // ===== Unique Spec Key Source (Agenda DB) =====
  // ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ÙÙ‚Ø· Ù„Ø¬Ù„Ø¨ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù€ Spec Key Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ§Ø³Ùƒ (Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©).
  const agendaFirebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };


    if(!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    const $ = (id)=> document.getElementById(id);
    const appEl = $("app");
    const toastEl = $("toast");

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=> toastEl.classList.remove("show"), 2200);
    }

    function showLoginOverlay(show, errMsg){
      const ov = $("loginOverlay");
      if(!ov) return;
      ov.style.display = show ? "flex" : "none";
      const e = $("loginErr");
      if(e){
        if(errMsg){
          e.style.display = "";
          e.textContent = errMsg;
        }else{
          e.style.display = "none";
          e.textContent = "";
        }
      }
    }

    async function doGoogleLogin(){
      try{
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
        showLoginOverlay(false);
      }catch(e){
        console.error(e);
        showLoginOverlay(true, "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ© Ø£Ùˆ Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¹Ø§Ø¯ÙŠØ© (Ø¨Ø¯ÙˆÙ† Incognito).");
      }
    }
    function escapeHtml(s){
      return String(s??"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    
    
    // Admin emails (Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª + Ù…Ø²Ø§Ù…Ù†Ø© Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù€ Workspace)
    const ADMIN_EMAILS = [
      "hossamzayan10@gmail.com",
      "an9036663@gmail.com",
      "mr.ahmed_rashed@outlook.sa"
    ];
    function isAdminEmail(email){
      const e = String(email||"").toLowerCase().trim();
      return ADMIN_EMAILS.includes(e);
    }

    // Cache Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù€ Workspace (Ù†ÙØ³ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
    // ÙŠØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø­Ø¯Ø«Ø© Ù…Ù† stock Ù‡Ù†Ø§ Ù„ØªØ³ØªØ®Ø¯Ù… Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„Ù‰ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    const SPEC_CACHE_DOC = doc(db, "spec_keys_cache", "v1");
    let lastStockHash = "";
    async function upsertSpecCache(stockArr){
      try{
        const email = auth.currentUser?.email || "";
        if(!isAdminEmail(email)) return; // ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙƒØ§Ø´ Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
        const payload = Array.isArray(stockArr) ? stockArr : [];
        const h = await stockHash(payload);
        if(h && h === lastStockHash) return;
        lastStockHash = h;
        await setDoc(SPEC_CACHE_DOC, {
          stock: payload,
          updatedAt: serverTimestamp(),
          updatedBy: email
        }, { merge:true });
      }catch(e){
        console.warn("upsertSpecCache failed", e);
      }
    }
    function stockHash(arr){
      try{
        // hash Ø®ÙÙŠÙ Ù„ØªÙØ§Ø¯ÙŠ ÙƒØªØ§Ø¨Ø© Ù…ØªÙƒØ±Ø±Ø©
        const txt = JSON.stringify(arr);
        let hash = 0;
        for(let i=0;i<txt.length;i++){
          hash = ((hash<<5)-hash) + txt.charCodeAt(i);
          hash |= 0;
        }
        return Promise.resolve(String(hash));
      }catch(e){
        return Promise.resolve("");
      }
    }

// ===== Spec Key Options (Ø¨Ø¯ÙˆÙ† Ø£Ù„ÙˆØ§Ù†) =====
    const SPEC_DATALIST_ID = "specKeyList";
    let SPEC_KEY_OPTIONS = [];
    let agendaUnsub = null;

    function cleanSpec(v){
      return String(v ?? "").replace(/[--]/g,"").replace(/\s+/g," ").trim();
    }

    function buildSpecKeyNoColors(rec){
      const car = cleanSpec(rec.car);
      const variant = cleanSpec(rec.variant);
      const year = cleanSpec(rec.modelYear);
      const parts = [car, variant, year].map(x=> x || "-");
      return parts.join(" | ");
    }

    const SOLD_STATES_SPEC = ["Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„ÙˆÙƒØ§Ù„Ø©"];
    function isSoldRowForSpec(rec){
      const placeRaw = cleanSpec(rec.place || rec.location || rec["Ø§Ù„Ù…ÙƒØ§Ù†"] || "");
      if(!placeRaw) return false;
      return SOLD_STATES_SPEC.some(st => placeRaw.includes(st));
    }

    function setSpecKeyOptionsFromStock(stockArr){
      try{
        const set = new Set();
        for(const r of (Array.isArray(stockArr)?stockArr:[])){
          if(isSoldRowForSpec(r)) continue;
          const key = buildSpecKeyNoColors(r);
          if(key && key !== "- | - | -") set.add(key);
        }
        SPEC_KEY_OPTIONS = Array.from(set).sort((a,b)=> a.localeCompare(b,"ar"));
        renderSpecKeyDatalist();
      }catch(e){
        console.warn("setSpecKeyOptionsFromStock error", e);
      }
    }

    function renderSpecKeyDatalist(){
      const dl = document.getElementById(SPEC_DATALIST_ID);
      if(!dl) return;
      dl.innerHTML = SPEC_KEY_OPTIONS.map(k=> `<option value="${escapeAttr(k)}"></option>`).join("");
    }

    // init live source
    
    function initLocalSpecCache(){
      try{
        onSnapshot(SPEC_CACHE_DOC, (snap)=>{
          if(!snap.exists()) return;
          const d = snap.data() || {};
          if(Array.isArray(d.stock) && d.stock.length){
            setSpecKeyOptionsFromStock(d.stock);
          }
        });
      }catch(e){
        console.warn("initLocalSpecCache failed", e);
      }
    }

function initSpecKeySource(){
      try{
        // Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† ÙÙŠ Auth Ø¯Ø§Ø®Ù„ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Firebase Project Ù…Ø®ØªÙ„Ù)
        // Ù‡Ù†Ø³ØªØ®Ø¯Ù… Anonymous Auth Ø¹Ù„Ø´Ø§Ù† Ù†Ù‚Ø¯Ø± Ù†Ù‚Ø±Ø£ Ø§Ù„Ø¯Ø§ØªØ§ (Ù„Ùˆ Anonymous Ù…ÙØ¹Ù‘Ù„ ÙÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹).
        signInAnonymously(agendaAuth).then(()=>{
          const stateRef = doc(agendaDb, "mzj_admin_state", "v1");
          if(agendaUnsub) agendaUnsub();
          agendaUnsub = onSnapshot(stateRef, (snap)=>{
            if(!snap.exists()) return;
            const d = snap.data() || {};
            setSpecKeyOptionsFromStock(d.stock || []);
            // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø­Ø¯Ø«Ø© Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù€ Workspace
            upsertSpecCache(d.stock || []);
          }, (err)=>{
            console.warn("SpecKey source snapshot error", err);
            toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Unique Spec Key (ØªØ­Ù‚Ù‚ Ù…Ù† Rules/Anonymous Auth ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)");
          });
        }).catch((err)=>{
          console.warn("agenda anonymous auth failed", err);
          toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Unique Spec Key (Anonymous Auth ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)");
        });
      }catch(e){
        console.warn("initSpecKeySource failed", e);
        toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Unique Spec Key");
      }
    }

    function escapeAttr(s){ return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;"); }
function initials(name){
      const n = (name||"M").trim();
      const parts = n.split(/\s+/).filter(Boolean);
      if(parts.length===1) return parts[0][0].toUpperCase();
      return (parts[0][0]+parts[1][0]).toUpperCase();
    }

    $("sbToggle").addEventListener("click", ()=>{
      appEl.classList.toggle("collapsed");
      localStorage.setItem("ws_sb_collapsed", appEl.classList.contains("collapsed") ? "1" : "0");
    });
    if(localStorage.getItem("ws_sb_collapsed")==="1") appEl.classList.add("collapsed");

    const views = { home: $("viewHome"), list: $("viewList"), board: $("viewBoard") };
    function showView(key){
      Object.values(views).forEach(v=> v.style.display="none");
      views[key].style.display="";
    }

    let CURRENT_USER = null;
    let CURRENT_ROLE = "member";
    let USERS = [];

    let MODE = "home";
    let LIST_TYPE = null;
    let CURRENT_WORKSPACE = null;
    let CURRENT_TASK = null;
    let unsubWorkspaces = null;
    let unsubTasks = null;

    $("btnCreateAgenda").addEventListener("click", ()=> openBoardModal("agenda", "create"));
    $("btnCreateCampaign").addEventListener("click", ()=> openBoardModal("campaign", "create"));
    $("btnBack").addEventListener("click", ()=> {
      if(MODE==="board") openList(LIST_TYPE);
      else openHome();
    });

    function setNavActive(which){
      ["navHome","navAgendas","navCampaigns"].forEach(id=>{
        $(id).classList.toggle("active", id===which);
      });
    }
    $("navHome").addEventListener("click", ()=> openHome());
    $("navAgendas").addEventListener("click", ()=> openList("agenda"));
    $("navCampaigns").addEventListener("click", ()=> openList("campaign"));

    $("goAgendas").addEventListener("click", ()=> openList("agenda"));
    $("goCampaigns").addEventListener("click", ()=> openList("campaign"));

    $("btnLogout").addEventListener("click", async ()=>{
      await signOut(auth);
      showLoginOverlay(true);
    });

    // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    $("btnLoginGoogle") && $("btnLoginGoogle").addEventListener("click", doGoogleLogin);

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ showLoginOverlay(true); return; }
      CURRENT_USER = user;
      showLoginOverlay(false);

      let displayName = user.email || "Ù…Ø³ØªØ®Ø¯Ù…";
      try{
        const uSnap = await getDoc(doc(db, "users", user.uid));
        if(uSnap.exists()){
          const ud = uSnap.data() || {};
          displayName = ud.name || ud.username || user.email || "Ù…Ø³ØªØ®Ø¯Ù…";
          CURRENT_ROLE = ud.role || "member";
        }
      }catch{}

      $("whoName").textContent = displayName;
      $("whoRole").textContent = (CURRENT_ROLE==="admin" ? "Ù…Ø¯ÙŠØ±" : "Ø¹Ø¶Ùˆ");
      $("avatar").textContent = initials(displayName);

      await loadUsers();
      openHome();
      listenKPIs();
    });

    async function loadUsers(){
      USERS = [];
      try{
        const snap = await getDocs(collection(db,"users"));
        snap.forEach(d=>{
          const u = d.data()||{};
          USERS.push({
            uid: d.id,
            name: u.name || u.username || u.email || d.id.slice(0,6),
            role: u.role || "member",
            email: u.email || null
          });
        });
      }catch(err){ console.warn("users load failed", err); }

      const sel = $("taskAssignee");
      sel.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± ÙŠÙˆØ²Ø± â€”</option>`;
      USERS.slice().sort((a,b)=> (a.name||"").localeCompare(b.name||"", "ar")).forEach(u=>{
        const opt = document.createElement("option");
        opt.value = u.uid;
        opt.textContent = u.name + (u.role ? ` (${u.role})` : "");
        sel.appendChild(opt);
      });
    }

    let unsubKpiWs=null, unsubKpiTasks=null;
    function listenKPIs(){
      if(unsubKpiWs) unsubKpiWs();
      if(unsubKpiTasks) unsubKpiTasks();

      unsubKpiWs = onSnapshot(collection(db,"workspaces"), (snap)=>{
        let agendas=0, campaigns=0;
        snap.forEach(d=>{
          const x = d.data()||{};
          if(x.active===false) return;
          if(x.type==="agenda") agendas++;
          if(x.type==="campaign") campaigns++;
        });
        $("kpiAgendas").textContent = agendas;
        $("kpiCampaigns").textContent = campaigns;
      });

      unsubKpiTasks = onSnapshot(collection(db,"workspace_tasks"), (snap)=>{
        let a=0,c=0;
        snap.forEach(d=>{
          const t=d.data()||{};
          if(t.type==="agenda") a++;
          if(t.type==="campaign") c++;
        });
        $("kpiAgendaTasks").textContent = a;
        $("kpiCampaignTasks").textContent = c;
      });
    }

    function openHome(){
      MODE="home"; LIST_TYPE=null; CURRENT_WORKSPACE=null;
      if(unsubWorkspaces){unsubWorkspaces();unsubWorkspaces=null;}
      if(unsubTasks){unsubTasks();unsubTasks=null;}

      setNavActive("navHome");
      $("pageTitle").textContent = "Workspace â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª ÙˆØ§Ù„Ø­Ù…Ù„Ø§Øª";
      $("pageDesc").textContent = "Ø£Ù†Ø´Ø¦ Ø£Ø¬Ù†Ø¯Ø§Øª Ù„Ù„Ù…Ù‡Ø§Ù… Ø£Ùˆ Ø­Ù…Ù„Ø§Øª Ø¨ØªÙˆØ§Ø±ÙŠØ® ÙˆÙˆØµÙâ€¦ Ø«Ù… Ø£Ø¶Ù ØªØ§Ø³ÙƒØ§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©.";
      $("btnBack").style.display="none";
      $("btnCreateAgenda").style.display="";
      $("btnCreateCampaign").style.display="";
      $("homeMeta").textContent = "Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (mzj-workspace-c7d4e)";
      showView("home");
    }

    $("btnRefresh").addEventListener("click", ()=> { if(LIST_TYPE) openList(LIST_TYPE); });

    function openList(type){
      MODE = type==="agenda" ? "agendas" : "campaigns";
      LIST_TYPE = type;
      CURRENT_WORKSPACE = null;
      if(unsubTasks){unsubTasks();unsubTasks=null;}

      setNavActive(type==="agenda" ? "navAgendas" : "navCampaigns");

      $("btnBack").style.display="";
      $("btnCreateAgenda").style.display = type==="agenda" ? "" : "none";
      $("btnCreateCampaign").style.display = type==="campaign" ? "" : "none";

      $("pageTitle").textContent = type==="agenda" ? "Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª" : "Ø§Ù„Ø­Ù…Ù„Ø§Øª";
      $("pageDesc").textContent  = type==="agenda"
        ? "Ø§Ø®ØªØ± Ø£Ø¬Ù†Ø¯Ø© Ø£Ùˆ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©. Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø³ØªØ¬Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØªØ¶ÙŠÙ ØªØ§Ø³ÙƒØ§Øª Ø¨Ø³Ù‡ÙˆÙ„Ø©."
        : "Ø§Ø®ØªØ± Ø­Ù…Ù„Ø© Ø£Ùˆ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ ÙˆØµÙ + ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ©/Ù†Ù‡Ø§ÙŠØ© + Ø£Ø¹Ù…Ø¯Ø©.";

      $("listTitle").textContent = type==="agenda" ? "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù†Ø¯Ø§Øª" : "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ù…Ù„Ø§Øª";

      showView("list");
      listenWorkspaces(type);
    }

    function listenWorkspaces(type){
      if(unsubWorkspaces){unsubWorkspaces();unsubWorkspaces=null;}

      const qy = query(
        collection(db,"workspaces"),
        where("type","==", type)
      );
unsubWorkspaces = onSnapshot(qy, (snap)=>{
        let items=[];
        snap.forEach(d=> items.push({ id:d.id, ...(d.data()||{}) }));
        // ØªØµÙÙŠØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·Ø© + ØªØ±ØªÙŠØ¨ Ù…Ø­Ù„ÙŠ Ù„ØªÙØ§Ø¯ÙŠ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù€ Composite Index
        items = items.filter(x=> x.active !== false);
        items.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
        renderList(type, items);
      }, (err)=>{
        console.error(err);
        toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©");
      });
    }

    function renderList(type, items){
      const container = $("listContainer");
      const empty = $("listEmpty");
      container.innerHTML = "";
      empty.style.display = items.length ? "none" : "";

      items.forEach(x=>{
        const el = document.createElement("div");
        el.className = "list-item";

        const columnsCount = Array.isArray(x.columns) ? x.columns.length : 0;
        let sub = "";
        if(type==="agenda"){
          sub = `Ø£Ø¹Ù…Ø¯Ø©: ${columnsCount}`;
        }else{
          const s = x.startDate || "â€”";
          const e = x.endDate || "â€”";
          sub = `Ø§Ù„ÙØªØ±Ø©: ${s} â†’ ${e} | Ø£Ø¹Ù…Ø¯Ø©: ${columnsCount}`;
        }

        const desc = type==="campaign" ? (x.description||"") : "";
        el.innerHTML = `
          <div class="li-main">
            <p class="li-title">${escapeHtml(x.name||"Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")}</p>
            <p class="li-sub">${escapeHtml(desc ? (desc + " â€” " + sub) : sub)}</p>
          </div>
          <div class="li-right">
            <span class="tag"><span class="mini"></span>${type==="agenda"?"Agenda":"Campaign"}</span>
            <button class="btn sm secondary" data-open="1" type="button">ÙØªØ­</button>
          </div>
        `;

        el.querySelector('[data-open="1"]').addEventListener("click", (e)=>{
          e.stopPropagation();
          openBoard(x);
        });

        el.addEventListener("click", ()=> openBoard(x));
        container.appendChild(el);
      });
    }

    function openBoard(workspace){
      MODE="board";
      CURRENT_WORKSPACE = workspace;

      $("btnBack").style.display="";
      $("btnCreateAgenda").style.display="none";
      $("btnCreateCampaign").style.display="none";

      $("pageTitle").textContent = workspace.type==="agenda" ? "Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©" : "Ù„ÙˆØ­Ø© Ø§Ù„Ø­Ù…Ù„Ø©";
      $("pageDesc").textContent  = "Ø§Ø¶ØºØ· â• Ø¯Ø§Ø®Ù„ Ø£ÙŠ Ø¹Ù…ÙˆØ¯ Ù„Ø¥Ø¶Ø§ÙØ© ØªØ§Ø³Ùƒ. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø³Ùƒ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø£Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.";

      $("boardTitle").textContent = workspace.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
      if(workspace.type==="campaign"){
        const s = workspace.startDate || "â€”";
        const e = workspace.endDate || "â€”";
        const d = workspace.description ? workspace.description : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ";
        $("boardSub").textContent = `Ø§Ù„ÙØªØ±Ø©: ${s} â†’ ${e} | ${d}`;
      }else{
        $("boardSub").textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: ${(workspace.columns||[]).length}`;
      }

      showView("board");

      $("btnEditBoard").onclick = ()=> openBoardModal(workspace.type, "edit", workspace);
      $("btnDeleteBoard").onclick = ()=> deleteWorkspace(workspace);

      renderBoardColumns(workspace, []);
      listenTasksForWorkspace(workspace.id);
    }

    function renderBoardColumns(workspace, tasks){
      const colsEl = $("boardCols");
      colsEl.innerHTML = "";

      const cols = Array.isArray(workspace.columns) && workspace.columns.length ? workspace.columns : ["Ù‚Ø§Ø¦Ù…Ø©"];
      const byCol = {};
      cols.forEach(c=> byCol[c]=[]);
      tasks.forEach(t=>{
        const c = t.column || cols[0];
        if(!byCol[c]) byCol[c]=[];
        byCol[c].push(t);
      });

      cols.forEach(colName=>{
        const col = document.createElement("section");
        col.className = "col";

        const list = byCol[colName] || [];
        const head = document.createElement("div");
        head.className = "col-head";
        head.innerHTML = `
          <div class="col-title">
            <span>${escapeHtml(colName)}</span>
            <span class="count-badge">${list.length}</span>
          </div>
          <button class="btn secondary xs" type="button">â• ØªØ§Ø³Ùƒ</button>
        `;
        head.querySelector("button").addEventListener("click", (e)=>{
          e.stopPropagation();
          openTaskModal("create", { workspace, column: colName });
        });

        const body = document.createElement("div");
        body.className = "col-body";

        if(!list.length){
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.style.fontSize = "12px";
          empty.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ§Ø³ÙƒØ§Øª Ù‡Ù†Ø§. Ø§Ø¶ØºØ· â• Ù„Ø¥Ø¶Ø§ÙØ© ØªØ§Ø³Ùƒ.";
          body.appendChild(empty);
        }else{
          list.slice().sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)).forEach(t=>{
            const card = document.createElement("div");
            card.className = "task-card";

            const assignee = t.assigneeName || "â€”";
            const due = t.due || "â€”";
            const specKey = t.specKey || "â€”";

            card.innerHTML = `
              <p class="t-title">${escapeHtml(specKey)}</p>
              <div class="t-meta">
                <span class="badge"><span class="dot"></span>${escapeHtml(assignee)}</span>
                <span class="badge" style="background:#fff;border-color:rgba(62,36,32,.10)"><span class="dot" style="background:#6b7280"></span>ğŸ“… ${escapeHtml(due)}</span>
              </div>
            `;

            card.addEventListener("click", ()=> openTaskDetail(t));
            body.appendChild(card);
          });
        }

        col.appendChild(head);
        col.appendChild(body);
        colsEl.appendChild(col);
      });
    }

    function listenTasksForWorkspace(workspaceId){
      if(unsubTasks){unsubTasks();unsubTasks=null;}
      // Ù…Ù„Ø§Ø­Ø¸Ø©: where + orderBy ÙŠØ­ØªØ§Ø¬ Composite IndexØŒ ÙÙ‡Ù†Ø³Ø­Ø¨ Ø¨Ø¯ÙˆÙ† orderBy ÙˆÙ†Ø±ØªÙ‘Ø¨ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ù€ Index
      const qy = query(
        collection(db,"workspace_tasks"),
        where("workspaceId","==", workspaceId)
      );
      unsubTasks = onSnapshot(qy, (snap)=>{
        let tasks=[];
        snap.forEach(d=> tasks.push({ id:d.id, ...(d.data()||{}) }));
        // ØªØ±ØªÙŠØ¨ Ù…Ø­Ù„ÙŠ Ø¨Ø§Ù„Ø£Ø­Ø¯Ø« (createdAt)
        tasks.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
        renderBoardColumns(CURRENT_WORKSPACE, tasks);
      }, (err)=>{
        console.error(err);
        const msg = (err?.code ? (err.code + " â€” ") : "") + (err?.message || "");
        toast("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ§Ø³ÙƒØ§Øª: " + (msg || "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª/Rules"));
      });
    }

    // Board modal
    const boardModal = $("boardModal");
    const boardType = $("boardType");
    const boardName = $("boardName");
    const campaignFields = $("campaignFields");
    const campaignDesc = $("campaignDesc");
    const campaignStart = $("campaignStart");
    const campaignEnd = $("campaignEnd");
    const colInput = $("colInput");
    const colsChips = $("colsChips");

    let BOARD_MODAL_MODE = "create";
    let BOARD_MODAL_TYPE = "agenda";
    let BOARD_EDIT_ID = null;
    let COLUMNS_TMP = [];

    const DEFAULT_AGENDA_COLS = ["Ø±ÙŠÙ„ Ù…ÙˆØ§ØµÙØ§Øª","Ø±ÙŠÙ„ Ù‚ØµÙŠØ±","ØªØµÙ…ÙŠÙ… ØµÙˆØ±","ÙŠÙˆØªÙŠÙˆØ¨","ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"];
    const DEFAULT_CAMPAIGN_COLS = ["Ø±ÙŠÙ„Ø² - ÙƒØ§Ø´","Ù…ÙˆØ´Ù† - ÙƒØ§Ø´","Ø¬Ø±Ø§ÙÙŠÙƒ - ÙƒØ§Ø´","Ø±ÙŠÙ„Ø² Ø§Ù‚Ø³Ø§Ø·","Ai Ø§Ù‚Ø³Ø§Ø·","Ø¬Ø±Ø§ÙÙŠÙƒ - Ø§Ù‚Ø³Ø§Ø·","Ø´Ø±ÙƒØ§Øª - Ù„ÙŠÙ†ÙƒØ¯ Ø§Ù†"];

    $("boardModalClose").addEventListener("click", ()=> closeBoardModal());
    $("boardCancel").addEventListener("click", ()=> closeBoardModal());
    boardModal.addEventListener("click", (e)=> { if(e.target===boardModal) closeBoardModal(); });

    $("btnAddCol").addEventListener("click", ()=>{
      const v = (colInput.value||"").trim();
      if(!v) return;
      addCol(v);
      colInput.value="";
    });
    $("btnAddDefaults").addEventListener("click", ()=>{
      const defs = BOARD_MODAL_TYPE==="agenda" ? DEFAULT_AGENDA_COLS : DEFAULT_CAMPAIGN_COLS;
      defs.forEach(addCol);
    });

    function addCol(name){
      const v = (name||"").trim();
      if(!v) return;
      if(COLUMNS_TMP.includes(v)) return;
      COLUMNS_TMP.push(v);
      renderColChips();
    }
    function removeCol(name){
      COLUMNS_TMP = COLUMNS_TMP.filter(x=> x!==name);
      renderColChips();
    }
    function renderColChips(){
      colsChips.innerHTML = "";
      if(!COLUMNS_TMP.length){
        colsChips.innerHTML = `<div class="empty" style="padding:10px;font-size:12px">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø¹Ø¯.</div>`;
        return;
      }
      COLUMNS_TMP.forEach(c=>{
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.innerHTML = `${escapeHtml(c)} <button type="button" title="Ø­Ø°Ù">âœ•</button>`;
        chip.querySelector("button").addEventListener("click", ()=> removeCol(c));
        colsChips.appendChild(chip);
      });
    }

    function openBoardModal(type, mode, workspace=null){
      BOARD_MODAL_TYPE = type;
      BOARD_MODAL_MODE = mode;
      BOARD_EDIT_ID = workspace?.id || null;

      boardType.value = (type==="agenda" ? "Ø£Ø¬Ù†Ø¯Ø© (Tasks)" : "Ø­Ù…Ù„Ø© (Campaign)");
      $("boardModalTitle").textContent = mode==="create"
        ? (type==="agenda" ? "Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø¬Ù†Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©" : "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©")
        : (type==="agenda" ? "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©" : "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø©");

      campaignFields.style.display = (type==="campaign") ? "" : "none";

      boardName.value = workspace?.name || "";
      campaignDesc.value = workspace?.description || "";
      campaignStart.value = workspace?.startDate || "";
      campaignEnd.value = workspace?.endDate || "";

      COLUMNS_TMP = Array.isArray(workspace?.columns) ? [...workspace.columns] : [];
      renderColChips();

      boardModal.classList.add("show");
    }

    function closeBoardModal(){
      boardModal.classList.remove("show");
      BOARD_EDIT_ID = null;
      COLUMNS_TMP = [];
      colInput.value = "";
    }

    $("boardSave").addEventListener("click", async ()=>{
      const name = (boardName.value||"").trim();
      if(!name) return toast("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©/Ø§Ù„Ø­Ù…Ù„Ø©");
      if(!COLUMNS_TMP.length) return toast("Ø£Ø¶Ù Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");

      const payload = {
        type: BOARD_MODAL_TYPE,
        name,
        columns: COLUMNS_TMP,
        active: true
      };

      if(BOARD_MODAL_TYPE==="campaign"){
        payload.description = (campaignDesc.value||"").trim() || null;
        payload.startDate = campaignStart.value || null;
        payload.endDate = campaignEnd.value || null;
      }

      try{
        if(BOARD_MODAL_MODE==="create"){
          payload.createdAt = serverTimestamp();
          payload.createdBy = CURRENT_USER?.uid || null;
          await addDoc(collection(db,"workspaces"), payload);
          toast("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ±");
        }else{
          if(!BOARD_EDIT_ID) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ID Ù„Ù„ØªØ¹Ø¯ÙŠÙ„");
          await updateDoc(doc(db,"workspaces", BOARD_EDIT_ID), payload);
          toast("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
        }
        closeBoardModal();
      }catch(err){
        console.error(err);
        const msg = (err?.code ? (err.code + " â€” ") : "") + (err?.message || "");
        toast("âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + (msg || "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Firestore Rules)"));
      }
    });

    async function deleteWorkspace(workspace){
      if(!workspace?.id) return;
      if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù (Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©/Ø§Ù„Ø­Ù…Ù„Ø©)ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù„ÙˆØ­Ø© ÙÙ‚Ø·ØŒ ÙˆØ§Ù„ØªØ§Ø³ÙƒØ§Øª Ø³ØªØ¸Ù„ (Ø¥Ù„Ø§ Ù„Ùˆ Ø·Ù„Ø¨Øª Ø­Ø°ÙÙ‡Ø§).")) return;

      try{
        await deleteDoc(doc(db,"workspaces", workspace.id));
        toast("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù");
        openList(workspace.type);
      }catch(err){
        console.error(err);
        toast("âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù");
      }
    }

    // Task modal
    const taskModal = $("taskModal");
    const taskSpecKey = $("taskSpecKey");
    const taskDesc = $("taskDesc");
    const taskDue = $("taskDue");
    const taskAssignee = $("taskAssignee");
    const taskColumn = $("taskColumn");
    const taskLinksWrap = $("taskLinksWrap");
    const linkTitle = $("linkTitle");
    const linkUrl = $("linkUrl");
    const linksChips = $("linksChips");

    let TASK_MODE = "create";
    let TASK_CTX = null;
    let LINKS_TMP = [];

    $("taskModalClose").addEventListener("click", ()=> closeTaskModal());
    $("taskCancel").addEventListener("click", ()=> closeTaskModal());
    taskModal.addEventListener("click", (e)=> { if(e.target===taskModal) closeTaskModal(); });

    $("btnAddLink").addEventListener("click", ()=>{
      const t = (linkTitle.value||"").trim() || "Ø±Ø§Ø¨Ø·";
      const u = (linkUrl.value||"").trim();
      if(!u || !/^https?:\/\//i.test(u)) return toast("Ø§ÙƒØªØ¨ Ø±Ø§Ø¨Ø· ÙŠØ¨Ø¯Ø£ Ø¨Ù€ http(s)://");
      LINKS_TMP.push({ title:t, url:u });
      linkTitle.value=""; linkUrl.value="";
      renderLinksChips();
    });

    function renderLinksChips(){
      linksChips.innerHTML="";
      if(!LINKS_TMP.length){
        linksChips.innerHTML = `<div class="empty" style="padding:10px;font-size:12px">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø±ÙˆØ§Ø¨Ø· Ø¨Ø¹Ø¯.</div>`;
        return;
      }
      LINKS_TMP.forEach((l,idx)=>{
        const chip = document.createElement("span");
        chip.className="chip";
        chip.innerHTML = `
          ğŸ”— ${escapeHtml(l.title)}
          <a href="${escapeHtml(l.url)}" target="_blank" rel="noopener" style="color:var(--brown);text-decoration:underline;font-weight:800">ÙØªØ­</a>
          <button type="button" title="Ø­Ø°Ù">âœ•</button>
        `;
        chip.querySelector("button").addEventListener("click", ()=>{
          LINKS_TMP.splice(idx,1);
          renderLinksChips();
        });
        linksChips.appendChild(chip);
      });
    }

    function openTaskModal(mode, ctxOrTask){
      TASK_MODE = mode;

      if(mode==="create"){
        TASK_CTX = ctxOrTask; // {workspace, column}
        CURRENT_TASK = null;

        $("taskModalTitle").textContent = "ØªØ§Ø³Ùƒ Ø¬Ø¯ÙŠØ¯";
        $("taskDelete").style.display="none";

        taskColumn.value = TASK_CTX.column;
        taskSpecKey.value = "";
        taskDesc.value = "";
        taskDue.value = "";
        taskAssignee.value = "";

        const isCampaign = TASK_CTX.workspace.type==="campaign";
        taskLinksWrap.style.display = isCampaign ? "" : "none";
        LINKS_TMP = [];
        renderLinksChips();
      }else{
        CURRENT_TASK = ctxOrTask;
        TASK_CTX = { workspace: CURRENT_WORKSPACE, column: CURRENT_TASK.column };

        $("taskModalTitle").textContent = "ØªØ¹Ø¯ÙŠÙ„ ØªØ§Ø³Ùƒ";
        $("taskDelete").style.display="";

        taskColumn.value = CURRENT_TASK.column || "";
        taskSpecKey.value = CURRENT_TASK.specKey || "";
        taskDesc.value = CURRENT_TASK.description || "";
        taskDue.value = CURRENT_TASK.due || "";
        taskAssignee.value = CURRENT_TASK.assigneeUid || "";

        const isCampaign = CURRENT_TASK.type==="campaign";
        taskLinksWrap.style.display = isCampaign ? "" : "none";
        LINKS_TMP = Array.isArray(CURRENT_TASK.links) ? [...CURRENT_TASK.links] : [];
        renderLinksChips();
      }

      taskModal.classList.add("show");
    }

    function closeTaskModal(){
      taskModal.classList.remove("show");
      TASK_CTX = null;
      LINKS_TMP = [];
    }

    $("taskSave").addEventListener("click", async ()=>{
      const specKey = (taskSpecKey.value||"").trim();
      const description = (taskDesc.value||"").trim() || null;
      const due = taskDue.value || null;
      const assigneeUid = taskAssignee.value || null;
      const assigneeObj = USERS.find(u=> u.uid===assigneeUid);
      const assigneeName = assigneeObj?.name || null;

      if(!specKey) return toast("Ø§ÙƒØªØ¨ Unique Spec Key");
      if(!TASK_CTX?.workspace?.id) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Workspace Ù…Ø­Ø¯Ø¯");
      if(!TASK_CTX?.column) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…ÙˆØ¯");

      const isCampaign = TASK_CTX.workspace.type==="campaign";

      const payload = {
        workspaceId: TASK_CTX.workspace.id,
        type: TASK_CTX.workspace.type,
        column: TASK_CTX.column,
        specKey,
        description,
        due,
        assigneeUid,
        assigneeName
      };

      if(isCampaign) payload.links = LINKS_TMP.length ? LINKS_TMP : [];

      try{
        if(TASK_MODE==="create"){
          payload.createdAt = serverTimestamp();
          payload.createdBy = CURRENT_USER?.uid || null;
          await addDoc(collection(db,"workspace_tasks"), payload);
          toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ");
        }else{
          if(!CURRENT_TASK?.id) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ID Ù„Ù„ØªØ¹Ø¯ÙŠÙ„");
          await updateDoc(doc(db,"workspace_tasks", CURRENT_TASK.id), payload);
          toast("âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ø³Ùƒ");
        }
        closeTaskModal();
      }catch(err){
        console.error(err);
        const msg = (err?.code ? (err.code + " â€” ") : "") + (err?.message || "");
        toast("âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ: " + (msg || "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Firestore Rules)"));
      }
    });

    $("taskDelete").addEventListener("click", async ()=>{
      if(!CURRENT_TASK?.id) return;
      if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØªØ§Ø³ÙƒØŸ")) return;
      try{
        await deleteDoc(doc(db,"workspace_tasks", CURRENT_TASK.id));
        toast("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ§Ø³Ùƒ");
        closeTaskModal();
        closeDetail();
      }catch(err){
        console.error(err);
        toast("âš ï¸ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØªØ§Ø³Ùƒ");
      }
    });

    // Detail
    const detailModal = $("detailModal");
    function openTaskDetail(task){
      CURRENT_TASK = task;

      $("dSpecKey").value = task.specKey || "";
      $("dDue").value = task.due || "";
      $("dAssignee").value = task.assigneeName || "â€”";
      $("dColumn").value = task.column || "";
      $("dDesc").value = task.description || "";

      const linksBlock = $("dLinksBlock");
      const dLinks = $("dLinks");
      dLinks.innerHTML="";

      if(task.type==="campaign" && Array.isArray(task.links) && task.links.length){
        linksBlock.style.display="";
        task.links.forEach(l=>{
          const chip = document.createElement("span");
          chip.className="chip";
          chip.innerHTML = `ğŸ”— <a href="${escapeHtml(l.url)}" target="_blank" rel="noopener" style="color:var(--brown);text-decoration:underline;font-weight:900">${escapeHtml(l.title||l.url)}</a>`;
          dLinks.appendChild(chip);
        });
      }else{
        linksBlock.style.display="none";
      }

      detailModal.classList.add("show");
    }
    function closeDetail(){ detailModal.classList.remove("show"); }

    $("detailClose").addEventListener("click", closeDetail);
    $("detailOk").addEventListener("click", closeDetail);
    detailModal.addEventListener("click", (e)=> { if(e.target===detailModal) closeDetail(); });

    $("detailEdit").addEventListener("click", ()=>{
      if(!CURRENT_TASK) return;
      closeDetail();
      openTaskModal("edit", CURRENT_TASK);
    });

    $("detailDelete").addEventListener("click", async ()=>{
      if(!CURRENT_TASK?.id) return;
      if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØªØ§Ø³ÙƒØŸ")) return;
      try{
        await deleteDoc(doc(db,"workspace_tasks", CURRENT_TASK.id));
        toast("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ§Ø³Ùƒ");
        closeDetail();
      }catch(err){
        console.error(err);
        toast("âš ï¸ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØªØ§Ø³Ùƒ");
      }
    });
  </script>

  <!-- Login Overlay (Ø¨Ø¯ÙˆÙ† ØµÙØ­Ø© Ù…Ù†ÙØµÙ„Ø©) -->
  <div id="loginOverlay" style="position:fixed;inset:0;background:rgba(255,248,239,.92);backdrop-filter: blur(6px);z-index:9999;display:none;align-items:center;justify-content:center;padding:20px">
    <div style="width:min(520px,100%);background:#fff;border:1px solid rgba(62,36,32,.12);border-radius:16px;box-shadow:0 18px 55px rgba(0,0,0,.10);padding:18px 18px 16px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,rgba(62,36,32,.16),rgba(188,143,116,.18));display:grid;place-items:center;color:rgb(62,36,32);font-weight:900">MZJ</div>
          <div>
            <div style="font-weight:900;color:rgb(62,36,32)">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
            <div class="muted" style="font-size:12px">Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø¹Ù„Ø´Ø§Ù† ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù€ Workspace.</div>
          </div>
        </div>
      </div>

      <div id="loginErr" class="muted" style="display:none;margin:10px 0 12px;padding:10px 12px;border-radius:12px;border:1px solid rgba(220,38,38,.25);background:rgba(220,38,38,.06);color:#b91c1c;font-weight:800;font-size:12px"></div>

      <button id="btnLoginGoogle" class="btn" type="button" style="width:100%;justify-content:center">
        <span style="font-size:16px">ğŸ”</span>
        <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google</span>
      </button>

      <div class="muted" style="font-size:12px;margin-top:10px;line-height:1.7">
        Ù„Ùˆ Ø¸Ù‡Ø±Øª Ù„Ùƒ Ù…Ø´ÙƒÙ„Ø© ØµÙ„Ø§Ø­ÙŠØ§ØªØŒ ØªØ£ÙƒØ¯ Ø¥Ù† Ø­Ø³Ø§Ø¨Ùƒ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ <b>users</b> Ø¯Ø§Ø®Ù„ Firestore ÙˆÙ…Ø­Ø¯Ø¯ Ù„Ù‡ role Ù…Ù†Ø§Ø³Ø¨.
      </div>
    </div>
  </div>

</body>
</html>
